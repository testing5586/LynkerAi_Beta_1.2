from flask import Blueprint, render_template, request, redirect, session, url_for
import sys
import os

# 添加路径以确保可以导入 engine
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from lynker_bazi_engine.engine.birth_engine import BirthEngine
from lynker_bazi_engine.engine.time_engine.time_engine import TimeEngine
from lynker_bazi_engine.engine.bazi_engine.bazi_engine import BaziEngine
from lynker_bazi_engine.engine.ziwei_engine.ziwei_wrapper import ZiweiEngine

birth_input_bp = Blueprint("birth_input", __name__, template_folder='../templates', static_folder='../static')
modernmatch_bp = Blueprint("modernmatch", __name__, url_prefix='/bazi', template_folder='../templates', static_folder='../static')
bazi_bp = Blueprint("bazi", __name__, url_prefix='/bazi', template_folder='../templates', static_folder='../static')
ziwei_bp = Blueprint("ziwei", __name__, url_prefix='/ziwei', template_folder='../templates', static_folder='../static')


# -------------------------
# 出生填写页面
# -------------------------
@birth_input_bp.route("/birth-input", methods=["GET"])
def birth_input_form():
    return render_template("birth_input.html")


@birth_input_bp.route("/birth-input", methods=["POST"])
def process_birth_data():
    # 获取表单数据
    date = request.form.get("birth_date")
    time = request.form.get("birth_time")
    gender = request.form.get("gender")
    location = request.form.get("location") # 注意：前端表单 name 是 location 不是 birth_place
    
    # 兼容处理：如果前端传的是 birth_place
    if not location:
        location = request.form.get("birth_place")

    # 调用总控 BirthEngine
    engine = BirthEngine()
    result = engine.generate_all(date, time, gender, location)

    # 存入 session
    session["birth_data"] = result.get("birth_data") # 保存基础信息供 dashboard 使用
    session["modernmatch"] = result["modern"]
    session["bazi"] = result["bazi"]
    session["ziwei"] = result["ziwei"]

    return redirect("/dashboard")


# -------------------------
# Dashboard 总览页
# -------------------------
@birth_input_bp.route("/dashboard", methods=["GET"])
def dashboard():
    # 获取 birth_data，如果为空则提供预览数据
    birth_data = session.get("birth_data")
    if not birth_data:
        birth_data = {
            "name": "灵友",
            "gender": "male",
            "location": {"name": "吉隆坡 Kuala Lumpur"},
            "local_datetime": "2011-01-11T19:32:00",
            "true_solar_datetime": "2011-01-11T18:11:36",
            "shichen": "酉"
        }
    
    # 构造 chart_summary 供模板使用
    modern_ready = session.get("modernmatch", {}).get("pending") is not True
    bazi_ready = session.get("bazi", {}).get("pending") is not True
    ziwei_ready = session.get("ziwei", {}).get("pending") is not True
    
    chart_summary = {
        "time_layers": {"ready": modern_ready},
        "bazi": {"ready": bazi_ready},
        "ziwei": {"ready": ziwei_ready}
    }
    
    return render_template("dashboard.html", 
                           birth_data=birth_data,
                           chart_summary=chart_summary)


# -------------------------
# ModernMatch 页面
# -------------------------
@modernmatch_bp.route("/modernmatch", methods=["GET"])
def modernmatch():
    birth_data = session.get("birth_data")
    if not birth_data:
        # Mock data for preview if session is empty
        birth_data = {
            "name": "Preview User",
            "gender": "male",
            "location": {"name": "Preview City"},
            "true_solar_datetime": "2024-01-01 12:00:00",
            "shichen": "Wu"
        }
    
    data = session.get("modernmatch")
    return render_template("modernmatch_unified.html", 
                           birth_data=birth_data,
                           modern_layers=data)


# -------------------------
# 八字命盘页面
# -------------------------
@bazi_bp.route("/match", methods=["GET"])
def bazi_page():
    data = session.get("bazi")
    return render_template("bazi_unified.html", 
                           birth_data=session.get("birth_data"),
                           bazi=data)


# -------------------------
# 紫微命盘页面
# -------------------------
@ziwei_bp.route("/match", methods=["GET"])
def ziwei_page():
    data = session.get("ziwei")
    return render_template("ziwei_unified.html", 
                           birth_data=session.get("birth_data"),
                           ziwei=data)


@birth_input_bp.route('/clear-session', methods=['GET'])
def clear_session():
    """
    清除 session 数据（用于测试）
    """
    session.clear()
    return redirect(url_for('birth_input.birth_input_form'))




