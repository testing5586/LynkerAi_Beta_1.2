# æ’è¡Œæ¦œé€»è¾‘ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ· **çµå‹ #1** ä½œä¸ºå½“å‰æœç´¢ç”¨æˆ·ï¼Œä¸åº”å‡ºç°åœ¨è‡ªå·±çš„æ’è¡Œæ¦œä¸­ã€‚è¿™ä¼šå¯¼è‡´ï¼š
- âŒ ç”¨æˆ·çœ‹åˆ°è‡ªå·±100%åŒ¹é…è‡ªå·±ï¼ˆæ— æ„ä¹‰ï¼‰
- âŒ å ç”¨æ’è¡Œæ¦œä½ç½®
- âŒ ç”¨æˆ·ä½“éªŒæ··ä¹±

## ä¿®å¤æ–¹æ¡ˆ

### âœ… ä¸€ã€åç«¯APIä¿®å¤

#### æ–‡ä»¶ï¼š`app.py`
**ä½ç½®**: ç¬¬308-329è¡Œ

**ä¿®æ”¹å†…å®¹**:
```python
# æ–°å¢å‚æ•°
exclude_user = request.args.get("exclude_user", None, type=int)

# è°ƒç”¨æ’è¡Œæ¦œå¼•æ“æ—¶ä¼ é€’å‚æ•°
leaderboard = get_dynamic_leaderboard(engine, limit, exclude_user_id=exclude_user)
```

---

### âœ… äºŒã€æ’è¡Œæ¦œå¼•æ“ä¿®å¤

#### æ–‡ä»¶ï¼š`engines/leaderboard_engine.py`
**ä½ç½®**: ç¬¬10è¡Œã€ç¬¬38-41è¡Œ

**ä¿®æ”¹å†…å®¹**:
```python
# 1. å‡½æ•°ç­¾åæ–°å¢å‚æ•°
def get_dynamic_leaderboard(
    engine: str = "time", 
    limit: int = 10, 
    exclude_user_id: Optional[int] = None  # âœ… æ–°å¢
) -> List[Dict[str, Any]]:
```

```python
# 2. ç»Ÿè®¡èšåˆæ—¶è¿‡æ»¤å½“å‰ç”¨æˆ·
for uid in [u1, u2]:
    # âœ… æ’é™¤å½“å‰ç”¨æˆ·
    if exclude_user_id is not None and uid == exclude_user_id:
        continue
    
    if uid not in stats:
        stats[uid] = {...}
```

---

### âœ… ä¸‰ã€å‰ç«¯è°ƒç”¨ä¿®å¤

#### æ–‡ä»¶ï¼š`static/js/samelife.js`
**ä½ç½®**: ç¬¬224-230è¡Œ

**ä¿®æ”¹å†…å®¹**:
```javascript
async function loadLeaderboard() {
    // âœ… æ’é™¤å½“å‰ç”¨æˆ·ï¼ˆchart_id=1ï¼‰æ˜¾ç¤ºåœ¨æ’è¡Œæ¦œä¸­
    const currentUserId = 1; // å½“å‰ç”¨æˆ· chart_id
    const res = await fetch(`/api/leaderboard/top?limit=5&exclude_user=${currentUserId}`);
    ...
}
```

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ (âŒ)
```
æ’è¡Œæ¦œï¼š
ğŸ¥‡ çµå‹ #1001    100%
ğŸ¥ˆ çµå‹ #1      100%  â† âŒ å½“å‰ç”¨æˆ·è‡ªå·±
ğŸ¥‰ çµå‹ #2001   100%
No.4 çµå‹ #1002  68%
No.5 çµå‹ #2002  68%
```

### ä¿®å¤å (âœ…)
```
æ’è¡Œæ¦œï¼š
ğŸ¥‡ çµå‹ #1001    100%
ğŸ¥ˆ çµå‹ #2001    100%
ğŸ¥‰ çµå‹ #1002    68%
No.4 çµå‹ #2002  68%
No.5 çµå‹ #3001  50%
```

---

## APIå‚æ•°è¯´æ˜

### `/api/leaderboard/top`

**Queryå‚æ•°**:
- `limit`: è¿”å›æ•°é‡ï¼ˆé»˜è®¤10ï¼Œæœ€å¤§100ï¼‰
- `engine`: åŒ¹é…å¼•æ“ç±»å‹ (`time` | `bazi`)
- `exclude_user`: âœ… **æ–°å¢** - æ’é™¤çš„ç”¨æˆ·ID

**ç¤ºä¾‹**:
```
GET /api/leaderboard/top?limit=5&engine=time&exclude_user=1
```

---

## é€‚ç”¨åœºæ™¯

âœ… **TimeMatché¡µé¢** - æ’é™¤å½“å‰æœç´¢ç”¨æˆ·  
âœ… **BaziMatché¡µé¢** - æ’é™¤å½“å‰æœç´¢ç”¨æˆ·  
âœ… **ä¸ªäººä¸­å¿ƒé¡µé¢** - æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„æ’å  

---

## æ ¸å¿ƒé€»è¾‘

1. **å‰ç«¯è·å–å½“å‰ç”¨æˆ·ID** (hardcode `chart_id=1` æˆ–ä»sessionè¯»å–)
2. **è°ƒç”¨APIæ—¶ä¼ é€’** `exclude_user` å‚æ•°
3. **åç«¯å¼•æ“è¿‡æ»¤** è¯¥ç”¨æˆ·çš„æ‰€æœ‰åŒ¹é…è®°å½•
4. **è¿”å›æ’è¡Œæ¦œ** ä¸åŒ…å«å½“å‰ç”¨æˆ·

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-23 19:48  
**å½±å“èŒƒå›´**: TimeMatchæ’è¡Œæ¦œã€BaziMatchæ’è¡Œæ¦œï¼ˆå¦‚éœ€è¦ï¼‰
