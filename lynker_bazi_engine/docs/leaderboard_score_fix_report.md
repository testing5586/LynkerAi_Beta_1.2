# 排行榜分数显示修复报告

## 问题描述

**排行榜显示的分数与匹配结果不一致**：

| 用户 | 匹配结果 | 排行榜显示 | 差异 |
|------|----------|-----------|------|
| 灵友 #1002 | **80%** | 68% | -12% |
| 灵友 #2002 | **80%** | 68% | -12% |
| 灵友 #1003 | **65%** | 55% | -10% |

### 根本原因

**排行榜错误地显示了`final_score`（应用样本衰减后的分数），而不是`display_score`（原始匹配分数）**。

#### 衰减逻辑：
```python
# 样本衰减系数：少于5次匹配自动降权
if match_count < 5:
    final_score *= 0.85  # 85%衰减

# 示例：
# max_score = 80 → final_score = 0.8 * 0.85 = 0.68 (68%)
```

---

## 设计理念

### ✅ 正确逻辑

1. **`final_score`** - 用于**排序**
   - 应用样本衰减
   - 应用完美匹配豁免
   - 仅用于排行榜排序，不显示给用户

2. **`display_score`** - 用于**显示**
   - 原始 `max_score`（峰值共振分数）
   - 与匹配结果一致
   - 显示给用户看

### 为什么需要两个分数？

| 场景 | final_score (排序) | display_score (显示) |
|------|-------------------|---------------------|
| 用户A: 1次100%匹配 | 1.0 (豁免衰减) | 100 |
| 用户B: 2次80%匹配 | 0.68 (0.8×0.85) | 80 |
| 用户C: 10次70%匹配 | 0.7 (无衰减) | 70 |

**排序结果**: A(100) > C(70) > B(68)  
**显示结果**: A(100%) > B(80%) > C(70%)

---

## 修复方案

### ✅ 一、后端引擎修复

#### 文件：`engines/leaderboard_engine.py`
**位置**: 第105-112行

**修改内容**:
```python
leaderboard.append({
    "user_id": uid, 
    "chart_id": uid,
    "match_count": s["count"],
    "verified_count": s["verified"],
    "final_score": final_score,     # 用于排序
    "display_score": max_score,     # ✅ 用于前端显示（原始分数）
    "avg_score": avg_score
})
```

---

### ✅ 二、前端显示修复

#### 文件：`static/js/samelife.js`
**位置**: 第251-252行

**修改内容**:
```javascript
// ✅ 使用 display_score（原始分数）而不是 final_score（排序用的衰减分数）
const displayScore = Math.round(item.display_score || item.final_score * 100);
```

---

## 修复效果

### 修复前 (❌)

```
排行榜：
🥇 灵友 #2001    100%  ✅ 正确
🥈 灵友 #1001    100%  ✅ 正确
🥉 灵友 #2002    68%   ❌ 应该是80%
No.4 灵友 #1002  68%   ❌ 应该是80%
No.5 灵友 #1003  55%   ❌ 应该是65%
```

### 修复后 (✅)

```
排行榜：
🥇 灵友 #2001    100%  ✅ 正确
🥈 灵友 #1001    100%  ✅ 正确
🥉 灵友 #2002    80%   ✅ 修复（与匹配结果一致）
No.4 灵友 #1002  80%   ✅ 修复（与匹配结果一致）
No.5 灵友 #1003  65%   ✅ 修复（与匹配结果一致）
```

---

## 核心逻辑总结

### 排序逻辑 (final_score)
```
1. 完美匹配(100分) → 1.0（豁免衰减）
2. 高分+少样本(80分,2次) → 0.68（80% × 0.85衰减）
3. 中分+多样本(70分,10次) → 0.7（无衰减）

排序: 1.0 > 0.7 > 0.68
```

### 显示逻辑 (display_score)
```
1. 完美匹配 → 100%
2. 高分+少样本 → 80%（显示原始分数）
3. 中分+多样本 → 70%

显示: 100% > 80% > 70%
```

---

## API返回结构

```json
{
  "leaderboard": [
    {
      "user_id": 2001,
      "chart_id": 2001,
      "match_count": 1,
      "verified_count": 0,
      "final_score": 1.0,        // ← 排序用
      "display_score": 100,      // ← 显示用 ✅
      "avg_score": 100
    }
  ]
}
```

---

**修复完成时间**: 2025-11-23 19:54  
**影响范围**: TimeMatch排行榜、BaziMatch排行榜
