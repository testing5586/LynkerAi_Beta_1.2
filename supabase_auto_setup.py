#!/usr/bin/env python3
"""
==========================================================
Supabase è‡ªåŠ¨è®¾ç½®å·¥å…· - æ£€æµ‹å¹¶å¼•å¯¼åˆ›å»º child_ai_insights è¡¨
==========================================================
ç”±äºSupabase Pythonå®¢æˆ·ç«¯ä¸æ”¯æŒç›´æ¥æ‰§è¡ŒDDLï¼Œæœ¬è„šæœ¬å°†ï¼š
1. æ£€æµ‹è¡¨æ˜¯å¦å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨ï¼Œç”ŸæˆSQLå¹¶æä¾›æ“ä½œæŒ‡å¼•
3. æä¾›ä¸€é”®å¤åˆ¶çš„SQLè¯­å¥
"""

from supabase_init import init_supabase
import os


def check_and_setup_table(table_name):
    """æ£€æŸ¥å¹¶è®¾ç½®æŒ‡å®šçš„è¡¨"""
    
    print("=" * 70)
    print(f"ğŸ” Supabase Cloud è¡¨æ£€æµ‹ï¼š{table_name}")
    print("=" * 70)
    
    # åˆå§‹åŒ–Supabase
    supabase = init_supabase()
    
    if supabase is None:
        print("\nâš ï¸ Supabaseæœªè¿æ¥ï¼Œæ— æ³•æ£€æµ‹äº‘ç«¯è¡¨ã€‚")
        print("ğŸ’¡ è¯·æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼šSUPABASE_URL å’Œ SUPABASE_KEY")
        return False
    
    # æ£€æµ‹è¡¨æ˜¯å¦å­˜åœ¨
    try:
        result = supabase.table(table_name).select("id").limit(1).execute()
        print(f"\nâœ… è¡¨ '{table_name}' å·²å­˜åœ¨äºSupabaseäº‘ç«¯ï¼")
        print(f"ğŸ“Š å½“å‰è®°å½•æ•°ï¼š{len(result.data) if result.data else 0}")
        return True
    except Exception as e:
        print(f"\nâŒ è¡¨ '{table_name}' ä¸å­˜åœ¨äºSupabaseäº‘ç«¯")
        print(f"ğŸ“‹ é”™è¯¯è¯¦æƒ…ï¼š{e}")
        
        # ç”Ÿæˆåˆ›å»ºSQL
        print("\n" + "=" * 70)
        print("ğŸ“ è¯·åœ¨ Supabase Dashboard ä¸­æ‰§è¡Œä»¥ä¸‹SQLè¯­å¥åˆ›å»ºè¡¨ï¼š")
        print("=" * 70)
        print("\nğŸ”— è®¿é—®ï¼šhttps://supabase.com/dashboard/project/YOUR_PROJECT_ID/editor/sql\n")
        
        sql_script = """-- åˆ›å»º child_ai_insights è¡¨
CREATE TABLE IF NOT EXISTS public.child_ai_insights (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id TEXT NOT NULL,
    partner_id TEXT NOT NULL,
    similarity FLOAT,
    shared_tags JSONB,
    insight_text TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_child_ai_user_id ON public.child_ai_insights (user_id);
CREATE INDEX IF NOT EXISTS idx_child_ai_partner_id ON public.child_ai_insights (partner_id);
CREATE INDEX IF NOT EXISTS idx_child_ai_similarity ON public.child_ai_insights (similarity DESC);

-- éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ
SELECT tablename FROM pg_tables WHERE tablename = 'child_ai_insights';
"""
        
        print(sql_script)
        print("=" * 70)
        print("\nğŸ“‹ æ“ä½œæ­¥éª¤ï¼š")
        print("1ï¸âƒ£ å¤åˆ¶ä¸Šé¢çš„SQLè¯­å¥")
        print("2ï¸âƒ£ ç™»å½• Supabase Dashboard")
        print("3ï¸âƒ£ è¿›å…¥ SQL Editor")
        print("4ï¸âƒ£ ç²˜è´´å¹¶æ‰§è¡ŒSQL")
        print("5ï¸âƒ£ é‡æ–°è¿è¡Œæœ¬è„šæœ¬éªŒè¯")
        print("\nğŸ’¡ æˆ–è€…å°†SQLä¿å­˜åˆ°æ–‡ä»¶ï¼š")
        
        # ä¿å­˜SQLåˆ°æ–‡ä»¶
        sql_file = "./setup_child_ai_insights.sql"
        with open(sql_file, "w", encoding="utf-8") as f:
            f.write(sql_script)
        
        print(f"âœ… SQLå·²ä¿å­˜åˆ°ï¼š{sql_file}")
        print("=" * 70)
        
        return False


def test_insert_and_read():
    """æµ‹è¯•æ’å…¥å’Œè¯»å–åŠŸèƒ½"""
    print("\n" + "=" * 70)
    print("ğŸ§ª æµ‹è¯• Supabase æ’å…¥å’Œè¯»å–")
    print("=" * 70)
    
    supabase = init_supabase()
    
    if supabase is None:
        print("âš ï¸ Supabaseæœªè¿æ¥ï¼Œè·³è¿‡æµ‹è¯•")
        return
    
    # æµ‹è¯•æ•°æ®
    test_data = {
        "user_id": "u_test_setup",
        "partner_id": "u_partner_test",
        "similarity": 0.888,
        "shared_tags": {"career_type": "è®¾è®¡è¡Œä¸š", "marriage_status": "æ™šå©š"},
        "insight_text": "âœ¨ æµ‹è¯•æ´å¯Ÿï¼šä½ ä¸ u_partner_test çš„å‘½ç†ç›¸ä¼¼åº¦ä¸º 0.888ã€‚\nğŸ“‹ å…±åŒç‰¹å¾ï¼šè®¾è®¡è¡Œä¸šã€æ™šå©šã€‚\nğŸ”® â†’ å‘½ç›˜å…±é¸£å¼ºçƒˆï¼Œé€‚åˆåˆä½œæˆ–å‹è°Šã€‚"
    }
    
    try:
        # æ’å…¥æµ‹è¯•
        print("\n1ï¸âƒ£ æµ‹è¯•æ’å…¥...")
        result = supabase.table("child_ai_insights").insert(test_data).execute()
        print(f"âœ… æ’å…¥æˆåŠŸï¼è®°å½•IDï¼š{result.data[0]['id'] if result.data else 'N/A'}")
        
        # è¯»å–æµ‹è¯•
        print("\n2ï¸âƒ£ æµ‹è¯•è¯»å–...")
        result = supabase.table("child_ai_insights").select("*").eq("user_id", "u_test_setup").execute()
        
        if result.data:
            print(f"âœ… è¯»å–æˆåŠŸï¼æ‰¾åˆ° {len(result.data)} æ¡è®°å½•")
            print(f"\nğŸ“Š æœ€æ–°è®°å½•ï¼š")
            record = result.data[0]
            print(f"   - user_id: {record['user_id']}")
            print(f"   - partner_id: {record['partner_id']}")
            print(f"   - similarity: {record['similarity']}")
            print(f"   - shared_tags: {record['shared_tags']}")
            print(f"   - insight_text: {record['insight_text'][:100]}...")
        else:
            print("âš ï¸ æœªæ‰¾åˆ°è®°å½•")
        
        print("\nâœ… Supabase è¯»å†™æµ‹è¯•é€šè¿‡ï¼")
        print("=" * 70)
        
    except Exception as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥ï¼š{e}")
        print("=" * 70)


if __name__ == "__main__":
    print("\nğŸš€ å¯åŠ¨ Supabase è¡¨è‡ªåŠ¨è®¾ç½®å·¥å…·\n")
    
    # æ£€æŸ¥æ‰€æœ‰è¡¨
    tables_to_check = ["child_ai_insights", "child_ai_memory"]
    
    for table in tables_to_check:
        table_exists = check_and_setup_table(table)
        
        # å¦‚æœæ˜¯ child_ai_insights è¡¨ä¸”å­˜åœ¨ï¼Œè¿è¡Œæµ‹è¯•
        if table == "child_ai_insights" and table_exists:
            test_insert_and_read()
        
        print("\n")
    
    print("âœ… æ‰€æœ‰è¡¨æ£€æµ‹å®Œæˆï¼\n")
