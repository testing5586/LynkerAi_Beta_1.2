import os
from supabase import create_client, Client

# ä»ç¯å¢ƒå˜é‡è¯»å– Supabase é…ç½®
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

def ensure_users_table():
    """ç¡®ä¿ users è¡¨å­˜åœ¨"""
    try:
        supabase.table("users").select("id").limit(1).execute()
        print("âœ… users è¡¨å·²å­˜åœ¨")
    except Exception:
        print("ğŸ› ï¸ åˆ›å»º users è¡¨...")
        supabase.postgrest.rpc(
            "exec",
            {
                "sql": """
                CREATE TABLE IF NOT EXISTS public.users (
                    id bigint PRIMARY KEY,
                    name text,
                    ai_api_key text
                );
                """
            }
        ).execute()
        print("âœ… users è¡¨åˆ›å»ºæˆåŠŸ")

def ensure_recommendations_table():
    """ç¡®ä¿ recommendations è¡¨å­˜åœ¨"""
    try:
        supabase.table("recommendations").select("id").limit(1).execute()
        print("âœ… recommendations è¡¨å·²å­˜åœ¨")
    except Exception:
        print("ğŸ› ï¸ åˆ›å»º recommendations è¡¨...")
        supabase.postgrest.rpc(
            "exec",
            {
                "sql": """
                CREATE TABLE IF NOT EXISTS public.recommendations (
                    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    user_id bigint REFERENCES public.users(id) ON DELETE CASCADE,
                    target_id bigint,
                    match_score numeric,
                    matching_fields text[],
                    ai_comment text,
                    created_at timestamptz DEFAULT now()
                );
                """
            }
        ).execute()
        print("âœ… recommendations è¡¨åˆ›å»ºæˆåŠŸ")

def insert_default_users():
    """æ’å…¥å‘½ä¸»Aã€Bã€C"""
    default_users = [
        {"id": 2, "name": "å‘½ä¸»A", "ai_api_key": None},
        {"id": 3, "name": "å‘½ä¸»B", "ai_api_key": None},
        {"id": 5, "name": "å‘½ä¸»C", "ai_api_key": None},
    ]

    for user in default_users:
        existing = supabase.table("users").select("id").eq("id", user["id"]).execute()
        if not existing.data:
            supabase.table("users").insert(user).execute()
            print(f"âœ… æ’å…¥ç”¨æˆ·: {user['name']}")
        else:
            print(f"ğŸ”¹ ç”¨æˆ· {user['name']} å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥")

def main():
    print("ğŸ”§ LynkerAI åˆå§‹åŒ–å¼€å§‹...\n")
    ensure_users_table()
    ensure_recommendations_table()
    insert_default_users()
    print("\nâœ… åˆå§‹åŒ–å®Œæˆï¼å¯ä»¥é‡æ–°è¿è¡Œ pattern_match_engine_v3.py")

if __name__ == "__main__":
    main()
