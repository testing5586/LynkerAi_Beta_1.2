import os
from supabase import create_client, Client

SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å»ºè¡¨é€»è¾‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def ensure_tables():
    tables = {
        "users": """
            CREATE TABLE IF NOT EXISTS public.users (
                id bigint PRIMARY KEY,
                name text,
                role text DEFAULT 'user',
                ai_provider text DEFAULT 'mock-ai',
                ai_api_key text,
                created_at timestamptz DEFAULT now()
            );
        """,
        "birthcharts": """
            CREATE TABLE IF NOT EXISTS public.birthcharts (
                id bigint PRIMARY KEY,
                user_id bigint REFERENCES public.users(id),
                birth_data jsonb,
                created_at timestamptz DEFAULT now()
            );
        """,
        "recommendations": """
            CREATE TABLE IF NOT EXISTS public.recommendations (
                id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                user_id bigint REFERENCES public.users(id) ON DELETE CASCADE,
                target_id bigint,
                match_score numeric,
                matching_fields text[],
                ai_comment text,
                created_at timestamptz DEFAULT now()
            );
        """,
        "ai_rules": """
            CREATE TABLE IF NOT EXISTS public.ai_rules (
                id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                controller_id bigint REFERENCES public.users(id),
                target_role text,
                rule_name text,
                rule_description text,
                active boolean DEFAULT true,
                created_at timestamptz DEFAULT now()
            );
        """
    }

    for name, sql in tables.items():
        try:
            supabase.table(name).select("id").limit(1).execute()
            print(f"âœ… {name} è¡¨å·²å­˜åœ¨")
        except Exception:
            print(f"ğŸ› ï¸ åˆ›å»º {name} è¡¨...")
            supabase.postgrest.rpc("exec", {"sql": sql}).execute()
            print(f"âœ… {name} è¡¨åˆ›å»ºæˆåŠŸ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åˆå§‹åŒ–ç”¨æˆ·ä¸ Lynker Master
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def insert_default_users():
    users = [
        {"id": 1, "name": "Lynker Master", "role": "master", "ai_provider": "openai", "ai_api_key": os.getenv("OPENAI_API_KEY")},
        {"id": 2, "name": "å‘½ä¸»A", "role": "user", "ai_provider": "mock-ai"},
        {"id": 3, "name": "å‘½ä¸»B", "role": "user", "ai_provider": "gemini-free"},
        {"id": 5, "name": "å‘½ä¸»C", "role": "user", "ai_provider": "mock-ai"},
    ]

    for user in users:
        existing = supabase.table("users").select("id").eq("id", user["id"]).execute()
        if not existing.data:
            supabase.table("users").insert(user).execute()
            print(f"âœ… æ’å…¥ç”¨æˆ·: {user['name']} ({user['ai_provider']})")
        else:
            print(f"ğŸ”¹ ç”¨æˆ· {user['name']} å·²å­˜åœ¨ï¼Œè·³è¿‡")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ’å…¥ Master æ§åˆ¶è§„åˆ™
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def insert_master_rules():
    rules = [
        {
            "controller_id": 1,
            "target_role": "user",
            "rule_name": "AIè¡Œä¸ºç›‘æ§",
            "rule_description": "ç¦æ­¢ç”¨æˆ·AIåŠ©æ‰‹è‡ªè¡Œè¿æ¥å¤–éƒ¨APIæˆ–ç”ŸæˆæœªéªŒè¯æ–­è¯­ã€‚",
        },
        {
            "controller_id": 1,
            "target_role": "user",
            "rule_name": "åŠŸèƒ½æ¨¡å—æƒé™",
            "rule_description": "æ™®é€šç”¨æˆ·ä»…å¯è®¿é—®å‘½ç›˜è§£æã€åŒ¹é…ã€ç¤¾äº¤åŠŸèƒ½ï¼Œç¦ç”¨æ‰¹é‡ç ”ç©¶ä¸ä¸Šä¼ å¤§æ¨¡å‹ã€‚",
        },
        {
            "controller_id": 1,
            "target_role": "user",
            "rule_name": "ç®—åŠ›é…é¢é™åˆ¶",
            "rule_description": "æ¯æ—¥æœ€å¤šè§¦å‘AIè°ƒç”¨50æ¬¡ï¼Œè¶…å‡ºåæš‚åœè‡³æ¬¡æ—¥ã€‚",
        }
    ]

    for rule in rules:
        existing = supabase.table("ai_rules").select("rule_name").eq("rule_name", rule["rule_name"]).execute()
        if not existing.data:
            supabase.table("ai_rules").insert(rule).execute()
            print(f"âœ… æ–°å¢è§„åˆ™: {rule['rule_name']}")
        else:
            print(f"ğŸ”¹ è§„åˆ™ {rule['rule_name']} å·²å­˜åœ¨ï¼Œè·³è¿‡")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ä¸»ç¨‹åº
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main():
    print("\nğŸ”§ åˆå§‹åŒ– LynkerAI ç³»ç»Ÿæ•°æ®åº“...")
    ensure_tables()
    insert_default_users()
    insert_master_rules()
    print("\nğŸ¯ åˆå§‹åŒ–å®Œæˆï¼æ™®é€šç”¨æˆ·ä½¿ç”¨å…è´¹APIï¼ŒLynker Masterå…¨é¢æ§åˆ¶ã€‚")

if __name__ == "__main__":
    main()
