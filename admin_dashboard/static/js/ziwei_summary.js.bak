/* ğŸ§© Lynker Ziwei Summary v2.0 */
/* åŠŸèƒ½ï¼šInspector å¾½ç«  + 12å®«æ‘˜è¦ç½‘æ ¼ + æ¸å±‚é»‘åº•æ ·å¼ */

function renderZiweiSummary(data, containerId) {
  try {
    // âœ… ä»å®Œæ•´æ•°æ®å¯¹è±¡ä¸­æå–å„éƒ¨åˆ†
    const starMap = data.star_map || {};
    const basicInfo = data.basic_info || {};
    const transformations = data.transformations || {};

    console.log("[ZiweiSummary v2.0] æ¥æ”¶åˆ°æ•°æ®:", {
      star_map: Object.keys(starMap),
      basic_info: Object.keys(basicInfo),
      transformations: transformations
    });

    // ğŸ§­ Inspector å¾½ç« ï¼šæ£€æµ‹ star_map æ•°æ®ç»“æ„
    const mingGongData = starMap["å‘½å®«"];
    const isDict = typeof mingGongData === "object" && !Array.isArray(mingGongData) && mingGongData !== null;
    const badge = `<span class="ziwei-inspector-badge ${isDict ? "" : "warning"}">
      ${isDict ? "âœ… æ•°æ®ç»“æ„: dict æ­£å¸¸" : "âš ï¸ å¼‚å¸¸: star_map éæ ‡å‡†ç»“æ„"}
    </span>`;
    console.log("[ZiweiInspector] star_map['å‘½å®«'] ç±»å‹æ£€æµ‹:", isDict ? "dict âœ…" : "édict âš ï¸");

    const mg = starMap["å‘½å®«"] || {};
    
    // ç¹ç®€ä½“å…¼å®¹æå–å‡½æ•°
    const get = (obj, keys) => {
      for (const k of keys) {
        if (obj[k]) return obj[k];
      }
      return "";
    };

    const mainStar = get(mg, ["ä¸»æ˜Ÿ", "ä¸»æ˜Ÿæ›œ"]);
    const assistStar = get(mg, ["è¾…æ˜Ÿ", "è¼”æ˜Ÿ"]);
    const minorStar = get(mg, ["å°æ˜Ÿ", "æ¬¡æ˜Ÿ"]);

    // âœ… ä¿®å¤ï¼šå‘½å®«æ‘˜è¦åªæ˜¾ç¤ºä¸»æ˜Ÿï¼Œä¸æ˜¾ç¤ºè¾…æ˜Ÿå’Œå°æ˜Ÿ
    const mingGongStars = mainStar && mainStar.trim() ? mainStar : "æœªè¯†åˆ«";

    const mingzhu = basicInfo["å‘½ä¸»"] || "æœªçŸ¥";
    const shenzhu = basicInfo["èº«ä¸»"] || "æœªçŸ¥";

    const hua = transformations?.["ç”Ÿå¹´å››åŒ–"] || transformations || {};
    const huaStr = [
      `ç¦„: ${hua["ç¦„"] || hua["ç¥¿"] || ""}`,
      `æƒ: ${hua["æƒ"] || hua["æ¬Š"] || ""}`,
      `ç§‘: ${hua["ç§‘"] || ""}`,
      `å¿Œ: ${hua["å¿Œ"] || ""}`
    ].join(" | ");

    console.log("[ZiweiSummary] âœ… å‘½å®«ä¸»æ˜Ÿ=", mingGongStars);

    // ğŸ–¤ ä¸»å¡å†…å®¹ï¼ˆå¸¦ Inspector å¾½ç« ï¼‰
    const mainCardHTML = `
      <div class="summary-black-card">
        ${badge}
        <p><b>å‘½å®«:</b> ${mingGongStars}</p>
        <p><b>å‘½ä¸»:</b> ${mingzhu}; <b>èº«ä¸»:</b> ${shenzhu}</p>
        <p><b>ç”Ÿå¹´å››åŒ–:</b> ${huaStr}</p>
      </div>
    `;

    // ğŸ¯ 12å®«æ‘˜è¦ç½‘æ ¼
    const palaceGridHTML = Object.entries(starMap).map(([palace, info]) => {
      if (!info || typeof info !== "object") return "";
      const stars = [
        get(info, ["ä¸»æ˜Ÿ", "ä¸»æ˜Ÿæ›œ"]),
        get(info, ["è¾…æ˜Ÿ", "è¼”æ˜Ÿ"]),
        get(info, ["å°æ˜Ÿ", "æ¬¡æ˜Ÿ"])
      ].filter(s => s && s.trim()).join("ã€") || "æ— ";
      return `<div class="palace-card"><b>${palace}</b><br>${stars}</div>`;
    }).join("");

    // âœ… æ’å…¥ä¸»å¡ + 12å®«ç½‘æ ¼åˆ°å®¹å™¨
    const summaryCard = document.getElementById(containerId);
    if (summaryCard) {
      summaryCard.innerHTML = `
        ${mainCardHTML}
        <div id="ziweiPalaceGrid" class="ziwei-palace-grid">${palaceGridHTML}</div>
      `;
      console.log("[ZiweiSummary v2.0] âœ… ä¸»å¡ + 12å®«ç½‘æ ¼å·²æˆåŠŸæ’å…¥ DOMï¼Œå®¹å™¨ID:", containerId);
    } else {
      console.error("[ZiweiSummary v2.0] âŒ æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ï¼ŒID:", containerId);
    }
  } catch (e) {
    console.error("[ZiweiSummary v2.0] âŒ æ¸²æŸ“é”™è¯¯:", e);
  }
}
