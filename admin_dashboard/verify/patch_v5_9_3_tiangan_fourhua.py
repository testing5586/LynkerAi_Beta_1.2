# -*- coding: utf-8 -*-
"""
ğŸ”¹ Ziwei TXT Parser v5.9.3 â€” å››åŒ–å¤©å¹²æ¨ç®—æ¨¡å—
æ ¹æ®ç”Ÿå¹´å¤©å¹²è‡ªåŠ¨æ¨ç®—å››åŒ–ï¼ˆé’¦å¤©å››åŒ–ä½“ç³»ï¼‰
é€‚ç”¨äºæ–‡å¢¨å¤©æœº TXT å¯¼å‡ºæ–‡ä»¶ä¸­æ²¡æœ‰å››åŒ–ä¿¡æ¯çš„æƒ…å†µ
"""
import re


# é’¦å¤©å››åŒ–å¯¹ç…§è¡¨ï¼ˆç”Ÿå¹´å¤©å¹² â†’ å››åŒ–æ˜Ÿï¼‰
TIANGAN_FOURHUA_TABLE = {
    "ç”²": {"ç¦„": "å»‰è²", "æƒ": "ç ´è»", "ç§‘": "æ­¦æ›²", "å¿Œ": "å¤ªé™½"},
    "ä¹™": {"ç¦„": "å¤©æ©Ÿ", "æƒ": "å¤©æ¢", "ç§‘": "ç´«å¾®", "å¿Œ": "å¤ªé™°"},
    "ä¸™": {"ç¦„": "å¤©åŒ", "æƒ": "å¤©æ©Ÿ", "ç§‘": "æ–‡æ˜Œ", "å¿Œ": "å»‰è²"},
    "ä¸": {"ç¦„": "å¤ªé™°", "æƒ": "å¤©åŒ", "ç§‘": "å¤©æ©Ÿ", "å¿Œ": "å·¨é–€"},
    "æˆŠ": {"ç¦„": "è²ªç‹¼", "æƒ": "å¤ªé™°", "ç§‘": "å³å¼¼", "å¿Œ": "å¤©æ©Ÿ"},
    "å·±": {"ç¦„": "æ­¦æ›²", "æƒ": "è²ªç‹¼", "ç§‘": "å¤©æ¢", "å¿Œ": "æ–‡æ›²"},
    "åºš": {"ç¦„": "å¤ªé™½", "æƒ": "æ­¦æ›²", "ç§‘": "å¤ªé™°", "å¿Œ": "å¤©åŒ"},
    "è¾›": {"ç¦„": "å·¨é–€", "æƒ": "å¤ªé™½", "ç§‘": "æ–‡æ›²", "å¿Œ": "æ–‡æ˜Œ"},
    "å£¬": {"ç¦„": "å¤©æ¢", "æƒ": "ç´«å¾®", "ç§‘": "å·¦è¼”", "å¿Œ": "æ­¦æ›²"},
    "ç™¸": {"ç¦„": "ç ´è»", "æƒ": "å·¨é–€", "ç§‘": "å¤ªé™°", "å¿Œ": "è²ªç‹¼"}
}


def extract_tiangan_from_text(txt):
    """ä»æ–‡å¢¨å¤©æœº TXT ä¸­æå–ç”Ÿå¹´å¤©å¹²"""
    # ä¼˜å…ˆä»èŠ‚æ°”å››æŸ±æå–ï¼ˆæ›´å‡†ç¡®ï¼‰
    m = re.search(r"èŠ‚[æ°£æ°”]å››æŸ±\s*[:ï¼š]\s*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])", txt)
    if m:
        return m.group(1)
    
    # æ¬¡é€‰ï¼šä»å†œå†æ—¶é—´æå–
    m = re.search(r"([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])å¹´", txt)
    if m:
        return m.group(1)
    
    # å…œåº•ï¼šä»ä»»ä½•å¤©å¹²åœ°æ”¯ç»„åˆæå–ç¬¬ä¸€ä¸ªå¤©å¹²
    m = re.search(r"([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])", txt)
    if m:
        return m.group(1)
    
    return None


def patch_tiangan_fourhua(result):
    """
    v5.9.3 å››åŒ–å¤©å¹²æ¨ç®—è¡¥ä¸
    
    åŠŸèƒ½ï¼š
    1. ä»åŸå§‹æ–‡æœ¬ä¸­æå–ç”Ÿå¹´å¤©å¹²
    2. æ ¹æ®é’¦å¤©å››åŒ–è¡¨è‡ªåŠ¨æ¨ç®—å››åŒ–æ˜Ÿ
    3. æ›´æ–° transformations å­—æ®µ
    
    è¾“å…¥ï¼šParser v5.1-v5.8 çš„ç»“æœå­—å…¸
    è¾“å‡ºï¼šæ³¨å…¥å››åŒ–ä¿¡æ¯çš„ç»“æœå­—å…¸
    """
    raw_text = result.get("raw_text", "")
    if not raw_text:
        print("[v5.9.3 å¤©å¹²æ¨ç®—] âš ï¸ æ²¡æœ‰åŸå§‹æ–‡æœ¬ï¼Œè·³è¿‡å››åŒ–æ¨ç®—")
        return result
    
    # æå–ç”Ÿå¹´å¤©å¹²
    tiangan = extract_tiangan_from_text(raw_text)
    if not tiangan:
        print("[v5.9.3 å¤©å¹²æ¨ç®—] âš ï¸ æ— æ³•æå–ç”Ÿå¹´å¤©å¹²ï¼Œè·³è¿‡å››åŒ–æ¨ç®—")
        return result
    
    # æ ¹æ®å¤©å¹²æ¨ç®—å››åŒ–
    fourhua_table = TIANGAN_FOURHUA_TABLE.get(tiangan)
    if not fourhua_table:
        print(f"[v5.9.3 å¤©å¹²æ¨ç®—] âš ï¸ æœªçŸ¥å¤©å¹² '{tiangan}'ï¼Œè·³è¿‡å››åŒ–æ¨ç®—")
        return result
    
    # æ£€æŸ¥ç°æœ‰å››åŒ–æ•°æ®
    existing_fourhua = result.get("transformations", {}).get("ç”Ÿå¹´å››åŒ–", {})
    has_existing = any(existing_fourhua.values()) if existing_fourhua else False
    
    if has_existing:
        print(f"[v5.9.3 å¤©å¹²æ¨ç®—] â„¹ï¸ æ£€æµ‹åˆ°å·²æœ‰å››åŒ–æ•°æ®ï¼Œä¿ç•™åŸæ•°æ®")
        return result
    
    # æ³¨å…¥å››åŒ–æ•°æ®
    if "transformations" not in result:
        result["transformations"] = {}
    
    result["transformations"]["ç”Ÿå¹´å››åŒ–"] = fourhua_table.copy()
    
    # æµå¹´å››åŒ–æš‚æ—¶ç•™ç©ºï¼ˆéœ€è¦æµå¹´ä¿¡æ¯ï¼‰
    if "æµå¹´å››åŒ–" not in result["transformations"]:
        result["transformations"]["æµå¹´å››åŒ–"] = {"ç¦„": "", "æƒ": "", "ç§‘": "", "å¿Œ": ""}
    
    print(f"[v5.9.3 å¤©å¹²æ¨ç®—] âœ… æ ¹æ®å¤©å¹² '{tiangan}' æ¨ç®—å››åŒ–: {fourhua_table}")
    
    return result


if __name__ == "__main__":
    # æµ‹è¯•ç”¨ä¾‹
    test_result = {
        "raw_text": """
æ–‡å¢¨å¤©æ©Ÿç´«å¾®æ–—æ•¸å‘½ç›¤
â”‚
â”œåŸºæœ¬ä¿¡æ¯
â”‚ â”œè¾²æ›†æ™‚é–“ : ä¹™å¯å¹´ä¸ƒæœˆåˆå››æ—¥è¾°æ™‚
â”‚ â”œç¯€æ°£å››æŸ± : ä¹™å¯ ç”²ç”³ æˆŠå­ ä¸™è¾°
â”‚ â””èº«ä¸»:å¤©åŒ; å‘½ä¸»:å»‰è²
        """,
        "transformations": {
            "ç”Ÿå¹´å››åŒ–": {"ç¦„": "", "æƒ": "", "ç§‘": "", "å¿Œ": ""},
            "æµå¹´å››åŒ–": {"ç¦„": "", "æƒ": "", "ç§‘": "", "å¿Œ": ""}
        }
    }
    
    result = patch_tiangan_fourhua(test_result)
    print("\nâœ… å››åŒ–æ¨ç®—æµ‹è¯•:")
    print(f"ç”Ÿå¹´å››åŒ–: {result['transformations']['ç”Ÿå¹´å››åŒ–']}")
    print(f"\né¢„æœŸç»“æœï¼ˆä¹™å¹´ï¼‰: ç¦„=å¤©æ©Ÿ, æƒ=å¤©æ¢, ç§‘=ç´«å¾®, å¿Œ=å¤ªé™°")
