<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lynker Superintendent Command Center</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div class="sidebar">
    <h2>ğŸ§  LSCC</h2>
    <p class="sidebar-subtitle">Lynker Superintendent<br>Command Center</p>
    <ul>
        <li><a href="/dashboard" class="active">ğŸ“Š Dashboard</a></li>
        <li><a href="/chatroom">ğŸ’¬ AI åä½œèŠå¤©</a></li>
        <li><a href="/verify_view">ğŸ” çœŸå‘½ç›˜éªŒè¯</a></li>
        <li><a href="/superintendent/questionnaire/">ğŸ“‹ é—®å·ç®¡ç†</a></li>
    </ul>
</div>

<div class="main">
    <h1>Superintendent æ§åˆ¶é¢æ¿</h1>
    <p class="timestamp">æ›´æ–°æ—¶é—´: {{ data.timestamp }}</p>
    
    <div class="stats-grid">
        <div class="card">
            <h3>{{ data.master_status }}</h3>
            <p class="label">Master AI çŠ¶æ€</p>
        </div>
        <div class="card">
            <h3>{{ data.group_leaders }}</h3>
            <p class="label">Group Leaders</p>
        </div>
        <div class="card">
            <h3>{{ data.child_ai }}</h3>
            <p class="label">Child AI æ•°é‡</p>
        </div>
        <div class="card">
            <h3>{{ data.token_today }}</h3>
            <p class="label">ä»Šæ—¥ Token æ¶ˆè€—</p>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h3>
        <div class="db-stats">
            <div class="stat-item">
                <span class="stat-label">Master Vault æ¡ç›®:</span>
                <span class="stat-value">{{ data.vault_entries }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å‘½ç›˜æ€»æ•°:</span>
                <span class="stat-value">{{ data.charts_total }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">é¢„æµ‹æ€»æ•°:</span>
                <span class="stat-value">{{ data.predictions_total }}</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ˆ Token æ¶ˆè€—è¶‹åŠ¿</h3>
        <div id="tokenChart" style="width:100%;height:300px;"></div>
    </div>

    <div class="card">
        <h3>ğŸ” æœ€æ–°å‘½ç†è§„å¾‹å‘ç°</h3>
        <ul class="findings-list">
            {% for finding in data.new_findings %}
            <li>{{ finding }}</li>
            {% endfor %}
        </ul>
    </div>

    <div class="card">
        <h3>ğŸ‘¥ ç”¨æˆ·è¡Œä¸ºæ¦‚è§ˆï¼ˆ7å¤©ï¼‰</h3>
        <div class="stats-grid" style="margin-top: 15px;">
            <div class="stat-item">
                <span class="stat-label">7æ—¥äº‹ä»¶æ•°:</span>
                <span class="stat-value" id="events7d">åŠ è½½ä¸­...</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ä»Šæ—¥äº‹ä»¶æ•°:</span>
                <span class="stat-value" id="eventsToday">åŠ è½½ä¸­...</span>
            </div>
        </div>
        <div id="emotionChart" style="width:100%;height:250px;margin-top:15px;"></div>
        <div style="margin-top: 15px;">
            <h4 style="font-size: 0.95em; margin-bottom: 8px;">Top3 ç”¨æˆ·å…³æ³¨ç‚¹</h4>
            <div id="topConcerns" style="color: #888;">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ” ç”¨æˆ·ç”»åƒæŸ¥è¯¢</h3>
        <div style="margin-top: 15px;">
            <input type="number" id="userIdInput" placeholder="è¾“å…¥ç”¨æˆ· ID (ä¾‹å¦‚: 3)" 
                   style="width: 200px; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
            <button onclick="queryUserInsight()" 
                    style="padding: 8px 16px; margin-left: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 4px; color: white; cursor: pointer;">
                æŸ¥è¯¢ç”»åƒ
            </button>
        </div>
        <div id="insightResult" style="margin-top: 20px; min-height: 80px;"></div>
    </div>
</div>

<script>
    var trace = {
        x: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
        y: [5000, 5200, 5100, 5321, 5400, 5500, 5600],
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: '#61dafb', size: 8 },
        line: { color: '#61dafb', width: 3 }
    };
    
    var layout = {
        title: '',
        xaxis: { title: 'æ—¥æœŸ' },
        yaxis: { title: 'Token æ•°é‡' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Microsoft YaHei, sans-serif' }
    };
    
    Plotly.newPlot('tokenChart', [trace], layout, {responsive: true});

    // åŠ è½½ç”¨æˆ·è¡Œä¸ºæ¦‚è§ˆ
    function loadEventOverview() {
        fetch('/api/events/stats/overview')
            .then(res => res.json())
            .then(data => {
                document.getElementById('events7d').textContent = data.total_events_7d || 0;
                document.getElementById('eventsToday').textContent = 'æœªå®ç°';
                
                // ç»˜åˆ¶æƒ…ç»ªåˆ†å¸ƒå›¾
                const emotions = data.emotion_distribution || {};
                const labels = Object.keys(emotions);
                const values = Object.values(emotions);
                
                const emotionTrace = {
                    x: labels,
                    y: values,
                    type: 'bar',
                    marker: { color: '#764ba2' }
                };
                
                const emotionLayout = {
                    title: 'æƒ…ç»ªåˆ†å¸ƒ',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Microsoft YaHei, sans-serif', color: '#fff' },
                    xaxis: { title: 'æƒ…ç»ªç±»å‹' },
                    yaxis: { title: 'äº‹ä»¶æ•°' }
                };
                
                Plotly.newPlot('emotionChart', [emotionTrace], emotionLayout, {responsive: true});
                
                // æ¨¡æ‹Ÿ Top3 å…³æ³¨ç‚¹ï¼ˆå®é™…åº”ä»èšåˆæ•°æ®è·å–ï¼‰
                document.getElementById('topConcerns').innerHTML = 
                    '<span style="color: #61dafb;">1. å¤«å¦»å®«</span> &nbsp;&nbsp; ' +
                    '<span style="color: #764ba2;">2. åŒ–å¿Œ</span> &nbsp;&nbsp; ' +
                    '<span style="color: #f093fb;">3. è´¢å¸›å®«</span>';
            })
            .catch(err => {
                console.error('åŠ è½½äº‹ä»¶æ¦‚è§ˆå¤±è´¥:', err);
                document.getElementById('events7d').textContent = 'åŠ è½½å¤±è´¥';
            });
    }
    
    // æŸ¥è¯¢ç”¨æˆ·ç”»åƒ
    function queryUserInsight() {
        const userId = document.getElementById('userIdInput').value;
        if (!userId) {
            alert('è¯·è¾“å…¥ç”¨æˆ· ID');
            return;
        }
        
        const resultDiv = document.getElementById('insightResult');
        resultDiv.innerHTML = '<p style="color: #888;">æ­£åœ¨æŸ¥è¯¢...</p>';
        
        fetch(`/api/insights/${userId}`)
            .then(res => res.json())
            .then(insight => {
                const html = `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <div class="stat-item" style="margin-bottom: 10px;">
                            <span class="stat-label">æƒ…ç»ªå€¾å‘:</span>
                            <span class="stat-value" style="color: ${getEmotionColor(insight.emotion_tendency)}">${insight.emotion_tendency}</span>
                        </div>
                        <div class="stat-item" style="margin-bottom: 10px;">
                            <span class="stat-label">7å¤©äº‹ä»¶æ•°:</span>
                            <span class="stat-value">${insight.last_7d_event_count}</span>
                        </div>
                        <div class="stat-item" style="margin-bottom: 10px;">
                            <span class="stat-label">å…³æ³¨ç‚¹:</span>
                            <span class="stat-value">${(insight.top_concerns || []).join(', ') || 'æš‚æ— '}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ¨é€å°±ç»ª:</span>
                            <span class="stat-value" style="color: ${insight.push_ready ? '#4ade80' : '#888'}">${insight.push_ready ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = html;
            })
            .catch(err => {
                console.error('æŸ¥è¯¢ç”¨æˆ·ç”»åƒå¤±è´¥:', err);
                resultDiv.innerHTML = '<p style="color: #f87171;">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ· ID</p>';
            });
    }
    
    function getEmotionColor(emotion) {
        const colors = {
            'positive': '#4ade80',
            'neutral': '#888',
            'anxious': '#fbbf24',
            'sad': '#60a5fa',
            'angry': '#f87171'
        };
        return colors[emotion] || '#888';
    }
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    loadEventOverview();
</script>
</body>
</html>
