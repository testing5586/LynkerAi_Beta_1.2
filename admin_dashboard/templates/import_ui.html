<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>å‘½ç›˜æ‰¹é‡å¯¼å…¥ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0b1220;color:#e6edf3;font-family:system-ui, -apple-system;}
    .wrap{max-width:900px;margin:40px auto;padding:24px}
    .card{background:#111a2b;border:1px solid #1f2a44;border-radius:16px;padding:20px;margin-bottom:20px}
    h1{text-align:center;margin:0 0 30px 0;color:#40e0a8}
    h2{margin:0 0 12px 0}
    input,button{padding:10px 14px;border-radius:10px;border:1px solid #2a3758;background:#0b1220;color:#e6edf3;font-size:14px}
    button{cursor:pointer;background:#1a4d7a;transition:all 0.2s}
    button:hover{background:#2a5d8a}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .ok{color:#40e0a8}
    .err{color:#ff6b6b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    textarea{width:100%;height:180px;background:#0b1220;border:1px solid #2a3758;color:#e6edf3;border-radius:10px;padding:10px;font-family:monospace;font-size:13px}
    label{opacity:.85;display:block;margin-bottom:6px;font-weight:500}
    .info{background:#1a2847;padding:12px;border-radius:8px;margin-top:12px;font-size:13px;line-height:1.6}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ”® å‘½ç›˜æ‰¹é‡å¯¼å…¥ä¸­å¿ƒ</h1>
  
  <div class="card">
    <h2>ğŸ“‹ æ–‡å¢¨å¤©æœº JSON å¯¼å…¥</h2>
    <div class="row">
      <input type="file" id="jsonfile" accept=".json" />
      <button onclick="uploadJSON()">ä¸Šä¼ å¹¶å¯¼å…¥</button>
      <span id="jsonStatus"></span>
    </div>
    <div class="info">
      ğŸ’¡ æ”¯æŒæ–‡å¢¨å¤©æœºè½¯ä»¶å¯¼å‡ºçš„ JSON æ ¼å¼ï¼Œè‡ªåŠ¨è§£æå§“åã€æ€§åˆ«ã€å‡ºç”Ÿæ—¶é—´ã€å¤«å¦»å®«ã€è´¢å¸›å®«ã€é£åŒ–ä¿¡æ¯
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“„ æ–‡æ¡£å¯¼å…¥ï¼ˆTXT / DOCXï¼‰</h2>
    <div class="row">
      <input type="file" id="docfile" accept=".txt,.docx" />
      <button onclick="filePreview()">è¯†åˆ«å¹¶é¢„è§ˆ</button>
      <span id="fileStatus"></span>
    </div>
    <div class="grid" style="margin-top:16px">
      <div>
        <label>è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘åæäº¤ï¼‰</label>
        <textarea id="fileJson" placeholder='{"name":"å‘½ä¸»","gender":"å¥³","birth_time":"1990-05-20T15:30:00","marriage_palace_star":"å¤©åºœ","wealth_palace_star":"æ­¦æ›²","transformations":{"hualu":true,"huaji":false}}'></textarea>
        <div style="margin-top:10px">
          <button onclick="fileConfirm()">ç¡®è®¤å†™å…¥æ•°æ®åº“</button>
        </div>
      </div>
      <div>
        <label>åŸå§‹æ–‡æœ¬</label>
        <textarea id="fileRawText" readonly></textarea>
      </div>
    </div>
    <div class="info">
      ğŸ’¡ <strong style="color:#40e0a8">å‚»ç“œå¼å¯¼å…¥</strong> - æ”¯æŒ .txt å’Œ .docx æ ¼å¼ï¼Œè‡ªåŠ¨æå–å…³é”®å­—æ®µ<br>
      ğŸ“ <strong>å¿…å¡«å­—æ®µï¼š</strong>å§“å | <strong style="color:#888">å¯é€‰å­—æ®µï¼š</strong>æ€§åˆ«ã€å‡ºç”Ÿæ—¶é—´ã€å¤«å¦»å®«ã€è´¢å¸›å®«ã€åŒ–ç¦„ã€åŒ–å¿Œ<br>
      âœ… <strong>å³ä½¿åªæœ‰å§“åä¹Ÿèƒ½å¯¼å…¥ï¼</strong>å…¶ä»–å­—æ®µä¼šè‡ªåŠ¨å¡«å……é»˜è®¤å€¼ï¼Œåç»­å¯è¡¥å……<br>
      ğŸ“– æ–‡æœ¬æ ¼å¼ç¤ºä¾‹ï¼š<code style="background:#0b1220;padding:2px 6px;border-radius:4px">å§“å: å¼ ä¸‰</code> æˆ–å®Œæ•´ç‰ˆ <code style="background:#0b1220;padding:2px 6px;border-radius:4px">å§“å: å¼ ä¸‰ | æ€§åˆ«: ç”· | å‡ºç”Ÿæ—¶é—´: 1990-05-20 14:30</code><br>
      âš ï¸ DOCX åŠŸèƒ½éœ€è¦å®‰è£…ï¼š<code style="background:#0b1220;padding:2px 6px;border-radius:4px">pip install python-docx</code>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ–¼ï¸ æˆªå›¾ OCR åŠè‡ªåŠ¨å¯¼å…¥</h2>
    <div class="row">
      <input type="file" id="imgfile" accept="image/*,.pdf" />
      <button onclick="ocrPreview()">è¯†åˆ«å¹¶é¢„è§ˆ</button>
      <span id="ocrStatus"></span>
    </div>
    <div class="grid" style="margin-top:16px">
      <div>
        <label>è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘åæäº¤ï¼‰</label>
        <textarea id="ocrJson" placeholder='{"name":"å‘½ä¸»","gender":"å¥³","birth_time":"1990-05-20T15:30:00","marriage_palace_star":"å¤©åºœ","wealth_palace_star":"æ­¦æ›²","transformations":{"hualu":true,"huaji":false}}'></textarea>
        <div style="margin-top:10px">
          <button onclick="ocrConfirm()">ç¡®è®¤å†™å…¥æ•°æ®åº“</button>
        </div>
      </div>
      <div>
        <label>åŸå§‹è¯†åˆ«æ–‡æœ¬</label>
        <textarea id="rawText" readonly></textarea>
      </div>
    </div>
    <div class="info">
      âš ï¸ OCR åŠŸèƒ½éœ€è¦å®‰è£…ä¾èµ–ï¼š<code style="background:#0b1220;padding:2px 6px;border-radius:4px">pip install pillow easyocr</code><br>
      é¦–æ¬¡ä½¿ç”¨ä¼šä¸‹è½½ 100MB+ æ¨¡å‹æ–‡ä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…
    </div>
  </div>

  <div class="card" style="background:#1a2847">
    <h2>ğŸ“Š å¯¼å…¥ç»Ÿè®¡</h2>
    <p id="stats">åŠ è½½ä¸­...</p>
  </div>
</div>

<script>
// é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const r = await fetch('/import/stats');
    if (r.ok) {
      const data = await r.json();
      document.getElementById('stats').innerHTML = `
        å½“å‰æ•°æ®åº“å…±æœ‰ <strong style="color:#40e0a8">${data.total || 0}</strong> æ¡å‘½ç›˜è®°å½•
      `;
    }
  } catch(e) {
    document.getElementById('stats').textContent = 'ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥';
  }
});

async function uploadJSON(){
  const file = document.getElementById('jsonfile').files[0];
  if(!file) return alert('è¯·é€‰æ‹©ä¸€ä¸ª JSON æ–‡ä»¶');
  
  document.getElementById('jsonStatus').textContent = 'â³ ä¸Šä¼ ä¸­...';
  
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    const r = await fetch('/import/json', { method:'POST', body:fd });
    const j = await r.json();
    document.getElementById('jsonStatus').textContent = j.ok ? 'âœ… å¯¼å…¥æˆåŠŸ' : ('âŒ ' + j.error);
    document.getElementById('jsonStatus').className = j.ok ? 'ok' : 'err';
  } catch(e) {
    document.getElementById('jsonStatus').textContent = 'âŒ ç½‘ç»œé”™è¯¯';
    document.getElementById('jsonStatus').className = 'err';
  }
}

async function filePreview(){
  const file = document.getElementById('docfile').files[0];
  if(!file) return alert('è¯·é€‰æ‹©ä¸€ä¸ª TXT æˆ– DOCX æ–‡ä»¶');
  
  document.getElementById('fileStatus').textContent = 'â³ è¯†åˆ«ä¸­...';
  
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    const r = await fetch('/import/file/preview', { method:'POST', body: fd });
    const j = await r.json();
    
    if(!j.ok){ 
      document.getElementById('fileStatus').textContent = 'âŒ ' + j.error; 
      document.getElementById('fileStatus').className = 'err';
      return; 
    }
    
    const p = j.parsed || {};
    document.getElementById('fileJson').value = JSON.stringify({
      name: p.name || "",
      gender: p.gender || "",
      birth_time: p.birth_time || "",
      marriage_palace_star: p.marriage_palace_star || "",
      wealth_palace_star: p.wealth_palace_star || "",
      transformations: p.transformations || {hualu:false, huaji:false},
      file_type: j.file_type || "txt"
    }, null, 2);
    
    document.getElementById('fileRawText').value = p.raw_text || '';
    document.getElementById('fileStatus').textContent = 'âœ… è¯†åˆ«å®Œæˆï¼Œè¯·æ£€æŸ¥å­—æ®µåç‚¹å‡»"ç¡®è®¤å†™å…¥"';
    document.getElementById('fileStatus').className = 'ok';
  } catch(e) {
    document.getElementById('fileStatus').textContent = 'âŒ ç½‘ç»œé”™è¯¯';
    document.getElementById('fileStatus').className = 'err';
  }
}

async function fileConfirm(){
  try{
    const payload = JSON.parse(document.getElementById('fileJson').value);
    
    document.getElementById('fileStatus').textContent = 'â³ å†™å…¥ä¸­...';
    
    const r = await fetch('/import/file/confirm', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(payload)
    });
    
    const j = await r.json();
    document.getElementById('fileStatus').textContent = j.ok ? 'âœ… å†™å…¥æˆåŠŸ' : ('âŒ ' + j.error);
    document.getElementById('fileStatus').className = j.ok ? 'ok' : 'err';
    
    if(j.ok) {
      // æ¸…ç©ºè¡¨å•
      document.getElementById('fileJson').value = '';
      document.getElementById('fileRawText').value = '';
    }
  }catch(e){
    alert('JSON æ ¼å¼ä¸æ­£ç¡®ï¼š' + e.message);
  }
}

async function ocrPreview(){
  const file = document.getElementById('imgfile').files[0];
  if(!file) return alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡æˆ–PDF');
  
  document.getElementById('ocrStatus').textContent = 'â³ è¯†åˆ«ä¸­...';
  
  const fd = new FormData();
  fd.append('image', file);
  
  try {
    const r = await fetch('/import/ocr/preview', { method:'POST', body: fd });
    const j = await r.json();
    
    if(!j.ok){ 
      document.getElementById('ocrStatus').textContent = 'âŒ ' + j.error; 
      document.getElementById('ocrStatus').className = 'err';
      return; 
    }
    
    const p = j.parsed || {};
    document.getElementById('ocrJson').value = JSON.stringify({
      name: p.name || "",
      gender: p.gender || "",
      birth_time: p.birth_time || "",
      marriage_palace_star: p.marriage_palace_star || "",
      wealth_palace_star: p.wealth_palace_star || "",
      transformations: p.transformations || {hualu:false, huaji:false}
    }, null, 2);
    
    document.getElementById('rawText').value = p.raw_text || '';
    document.getElementById('ocrStatus').textContent = 'âœ… è¯†åˆ«å®Œæˆï¼Œè¯·æ£€æŸ¥å­—æ®µåç‚¹å‡»"ç¡®è®¤å†™å…¥"';
    document.getElementById('ocrStatus').className = 'ok';
  } catch(e) {
    document.getElementById('ocrStatus').textContent = 'âŒ ç½‘ç»œé”™è¯¯';
    document.getElementById('ocrStatus').className = 'err';
  }
}

async function ocrConfirm(){
  try{
    const payload = JSON.parse(document.getElementById('ocrJson').value);
    
    document.getElementById('ocrStatus').textContent = 'â³ å†™å…¥ä¸­...';
    
    const r = await fetch('/import/ocr/confirm', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(payload)
    });
    
    const j = await r.json();
    document.getElementById('ocrStatus').textContent = j.ok ? 'âœ… å†™å…¥æˆåŠŸ' : ('âŒ ' + j.error);
    document.getElementById('ocrStatus').className = j.ok ? 'ok' : 'err';
    
    if(j.ok) {
      // æ¸…ç©ºè¡¨å•
      document.getElementById('ocrJson').value = '';
      document.getElementById('rawText').value = '';
    }
  }catch(e){
    alert('JSON æ ¼å¼ä¸æ­£ç¡®ï¼š' + e.message);
  }
}
</script>
</body>
</html>
