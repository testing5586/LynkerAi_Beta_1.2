<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„çœŸå‘½ç›˜ - LynkerAI</title>
    <link rel="stylesheet" href="/static/css/verify.css">
    <style>
        /* Mode B Embedded Styles */
        .mode-b-section {
            background: #222;
            border-radius: 12px;
            padding: 24px;
            margin: 30px 20px;
            border: 2px solid #00ff9d;
        }

        .mode-b-header h2 {
            color: #00ff9d;
            margin-bottom: 8px;
        }

        .mode-b-subtitle {
            color: #aaa;
            margin-bottom: 24px;
        }

        .sop-selector {
            margin: 20px 0;
        }

        .sop-selector label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
        }

        .sop-selector select {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .ai-message-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            color: white;
        }

        .ai-message-box .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .start-analysis-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00ff9d 0%, #00d4aa 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-analysis-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.3);
        }

        .start-analysis-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .analysis-results {
            display: none;
            margin-top: 30px;
        }

        .analysis-results.visible {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .ai-column {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
        }

        .ai-column h3 {
            color: #00ff9d;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #444;
        }

        .module-result {
            background: #1a1a1a;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .module-result h4 {
            color: #00d4aa;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .module-result .summary {
            color: #e0e0e0;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        .confidence-high {
            background: rgba(0, 255, 157, 0.2);
            color: #00ff9d;
        }

        .confidence-medium {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }

        .confidence-low {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .evidence-list {
            font-size: 13px;
            color: #aaa;
            margin-top: 8px;
            padding-left: 20px;
        }

        .evidence-list li {
            margin-bottom: 4px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #444;
            border-top-color: #00ff9d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            border-radius: 12px;
            margin-top: 30px;
            color: white;
        }

        .ai-summary h3 {
            margin-bottom: 16px;
            font-size: 20px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .comparison-table th {
            background: #1a1a1a;
            color: #00ff9d;
            font-weight: bold;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .btn-secondary {
            padding: 8px 16px;
            background: #444;
            border: 1px solid #666;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #555;
            border-color: #00ff9d;
        }
    </style>
    
    <!-- ZiweiAI v1.1 é»‘åº•æ‘˜è¦å¡ç‰‡æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/ziwei_summary.css">
    
    <!-- ç”¨æˆ·ä¿¡æ¯ç»„ä»¶æ ·å¼å’Œè„šæœ¬ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user-profile-card.css') }}">
    <script src="{{ url_for('static', filename='js/user-avatar.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/user-profile-card.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/i18n.js') }}" defer></script>
    
    <style>
        /* èŠå¤©æ¡†é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯æ¡æ ·å¼ */
        .chatbox-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .chatbox-user-info:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%);
        }
        
        .chatbox-user-info .user-avatar-display {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }
        
        .chatbox-user-info .user-nickname {
            font-size: 15px;
            font-weight: 500;
            color: #e0e0e0;
        }
    </style>
</head>
<body data-user-id="{{ user_id }}">
<div class="app-container">
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <aside class="sidebar">
        <div class="logo">
            <h2>LynkerAI</h2>
        </div>
        <nav class="nav-menu">
            <a href="/dashboard" class="nav-item">
                <span class="icon">ğŸ“Š</span> Dashboard
            </a>
            <a href="#" class="nav-item">
                <span class="icon">ğŸ”</span> Search
            </a>
            
            <!-- æˆ‘çš„å‘½ç›˜ï¼ˆå¯å±•å¼€ï¼‰ -->
            <div class="nav-item expandable active" data-menu="charts">
                <span class="icon">ğŸ”</span> æˆ‘çš„å‘½ç›˜
                <span class="arrow">â–¼</span>
            </div>
            <div class="nav-submenu" data-parent="charts">
                <a href="/verify?user_id={{ user_id }}" class="nav-sub-item">æˆ‘çš„çœŸå‘½ç›˜åˆ†æ</a>
                <a href="#" class="nav-sub-item group-switch active" data-group-index="0">å¯èƒ½å‡ºç”Ÿçš„æ—¶è¾°1</a>
                <a href="#" class="nav-sub-item group-switch" data-group-index="1">å¯èƒ½å‡ºç”Ÿçš„æ—¶è¾°2</a>
                <a href="#" class="nav-sub-item group-switch" data-group-index="2">å¯èƒ½å‡ºç”Ÿçš„æ—¶è¾°3</a>
            </div>
            
            <!-- NewChat å¤šè¯é¢˜èŠå¤© -->
            <a href="/newchat" class="nav-item" target="_blank">
                <span class="icon">ğŸ’¬</span> NewChat
            </a>
        </nav>
    </aside>

    <!-- ä¸­é—´ä¸»åŒºåŸŸ -->
    <main class="main-content">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <header class="page-header">
            <h1 class="page-title-center">æˆ‘çš„çœŸå‘½ç›˜</h1>
            <p class="subtitle-center">åœ¨è¿™é‡Œè¿˜åŸçœŸå®çš„å‡ºç”Ÿæ—¶è¾°ã€‚è¾“å…¥3ç»„ç»éªŒçš„å‡ºç”Ÿæ—¶è¾°åï¼Œè®©æˆ‘ä»¬ç»„åˆ3ç»„å¯èƒ½çš„äººç”Ÿè½¨è¿¹ï¼Œå†ç”±ä½ äº²è‡ªå¯¹æ¯”ã€é€‰æ‹©æœ€é€‚åˆçš„é‚£ä¸€ä¸ªã€‚æœ¬å¹³å°ä¸æä¾›ç®—ç›˜æœåŠ¡ï¼Œè¯·ä»å…¶ä»–å¹³å°æ‹¿åˆ°ç®—ç›˜çš„å›¾ç‰‡æˆ–æ–‡æœ¬åå†éªŒè¯ã€‚</p>
        </header>

        <!-- æ—¶è¾°æ ‡é¢˜ -->
        <div class="shichen-title">
            <h2>å¯èƒ½å‡ºç”Ÿçš„æ—¶è¾°1</h2>
        </div>

        <!-- ä¸¤ä¸ªå¹¶æ’ä¸Šä¼ æ¡† -->
        <section class="upload-section">
            <!-- å‡ºç”Ÿåœ°ç¯å¢ƒä¿¡æ¯é€‰æ‹©å™¨ -->
            <div class="env-select-container" style="margin-bottom: 24px; padding: 20px; background: #2a2a2a; border-radius: 12px; border: 1px solid #444;">
                <label style="display: block; color: #00ff9d; font-size: 16px; font-weight: bold; margin-bottom: 12px;">ğŸŒ å‡ºç”Ÿåœ°ä¿¡æ¯</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <select id="countrySelect" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #fff; font-size: 14px;">
                        <option value="">é€‰æ‹©å›½å®¶</option>
                    </select>
                    <select id="citySelect" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #fff; font-size: 14px;">
                        <option value="">é€‰æ‹©åŸå¸‚</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <input type="text" id="latitude" placeholder="çº¬åº¦" readonly style="padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #aaa; font-size: 13px;">
                    <input type="text" id="climate_zone" placeholder="æ°”å€™å¸¦" readonly style="padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #aaa; font-size: 13px;">
                    <input type="text" id="humidity_type" placeholder="æ¹¿åº¦" readonly style="padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #aaa; font-size: 13px;">
                    <input type="text" id="terrain_type" placeholder="åœ°å½¢" readonly style="padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #aaa; font-size: 13px;">
                </div>
            </div>

            <!-- Lynker ç»Ÿä¸€å‘½ç†å¼•æ“ï¼ˆå·²æš‚æ—¶æ”¶èµ·ï¼‰ -->
            <div id="lynker-divider" class="text-center my-4" style="margin-bottom: 24px;">
                <hr style="border-top: 1px solid #444; margin-bottom: 12px;">
                <div style="color: #888; font-size: 13px; padding: 8px 0;">
                    ğŸš§ Lynker ç»Ÿä¸€å‘½ç†å¼•æ“ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
                </div>
                <hr style="border-top: 1px solid #444; margin-top: 12px;">
            </div>

            <!-- ä¿ç•™å¼•æ“åŒºä½†é»˜è®¤éšè— -->
            <div id="birth-info" style="display: none; margin-bottom: 24px; padding: 20px; background: linear-gradient(180deg, #0a0a0a 0%, #1c1c1c 100%); border-radius: 16px; border: 1px solid #00ff9d;">
                <h4 style="color: #00ff9d; font-size: 18px; margin-bottom: 16px;">âœ¨ Lynker ç»Ÿä¸€å‘½ç†å¼•æ“</h4>
                <p style="color: #aaa; font-size: 13px; margin-bottom: 16px;">è¾“å…¥å‡ºç”Ÿèµ„æ–™ï¼Œä¸€é”®ç”Ÿæˆå…«å­—+ç´«å¾®å‘½ç›˜ï¼ˆæœªæ¥å°†å¯¹æ¥æ–‡å¢¨å¤©æœº/é—®çœŸAPIï¼‰</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; color: #fff; font-size: 13px; margin-bottom: 6px;">é˜³å†ç”Ÿæ—¥</label>
                        <input type="date" id="unifiedBirthDate" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; color: #fff; font-size: 13px; margin-bottom: 6px;">å‡ºç”Ÿæ—¶é—´</label>
                        <input type="time" id="unifiedBirthTime" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; color: #fff; font-size: 13px; margin-bottom: 6px;">æ€§åˆ«</label>
                        <select id="unifiedGender" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #fff; font-size: 14px;">
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; color: #fff; font-size: 13px; margin-bottom: 6px;">æ—¶åŒº</label>
                        <input type="text" id="unifiedTimezone" value="+08:00" style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 6px; color: #fff; font-size: 14px;">
                    </div>
                </div>
                
                <button id="generateUnifiedBtn" style="width: 100%; padding: 12px; background: linear-gradient(90deg, #00b4d8 0%, #00ff9d 100%); border: none; border-radius: 8px; color: #000; font-weight: bold; font-size: 15px; cursor: pointer; transition: all 0.3s;">
                    ğŸš€ ç”Ÿæˆå®Œæ•´å‘½ç›˜æ¡£æ¡ˆ
                </button>
                <div id="unifiedGenStatus" style="margin-top: 12px; color: #00b4d8; font-size: 13px; min-height: 20px;"></div>
            </div>

            <div class="upload-grid">
                <!-- å…«å­—å‘½ç›˜ä¸Šä¼ æ¡† -->
                <div class="upload-card" id="baziCard">
                    <h3>å…«å­—å‘½ç›˜</h3>
                    <div class="dropzone" id="baziDropzone">
                        <div class="dropzone-icon">â˜ï¸</div>
                        <p class="dropzone-text">æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ æˆ–</p>
                        <button class="btn-upload" onclick="document.getElementById('baziFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                        <input type="file" id="baziFile" accept="image/*,.txt" style="display:none;">
                        <p class="dropzone-hint">ä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´å‘½ç›˜æ–‡æœ¬</p>
                    </div>
                    <textarea 
                        id="baziText" 
                        class="chart-input" 
                        placeholder="æˆ–è€…ç›´æ¥ç²˜è´´å…«å­—å‘½ç›˜æ–‡æœ¬..."
                        rows="6"
                    ></textarea>
                </div>

                <!-- ç´«å¾®æ–—æ•°å‘½ç›˜ä¸Šä¼ æ¡† -->
                <div class="upload-card" id="ziweiCard">
                    <h3>ç´«å¾®æ–—æ•°å‘½ç›˜</h3>
                    <div class="dropzone" id="ziweiDropzone">
                        <div class="dropzone-icon">ğŸ“„</div>
                        <p class="dropzone-text">ä¸Šä¼ æ–‡å¢¨å¤©æœº AIåˆ†æç‰ˆæ–‡ä»¶ æˆ–</p>
                        <button class="btn-upload" onclick="document.getElementById('ziweiFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                        <input type="file" id="ziweiFile" accept=".json,.txt,image/*" style="display:none;">
                        <p class="dropzone-hint">âš ï¸ ä»…æ”¯æŒæ–‡å¢¨å¤©æœº AIåˆ†æç‰ˆ .json / .txt æ–‡ä»¶<br>å›¾ç‰‡ä»…ä½œå­˜åº•ï¼Œä¸è§¦å‘è¯†åˆ«</p>
                    </div>
                    <textarea 
                        id="ziweiText" 
                        class="chart-input" 
                        placeholder="æˆ–è€…ç›´æ¥ç²˜è´´æ–‡å¢¨å¤©æœºå¯¼å‡ºçš„ JSON æ•°æ®..."
                        rows="6"
                    ></textarea>
                </div>
            </div>
        </section>

        <!-- ä¸¤ä¸ªåªè¯»ç»“æœå±•ç¤ºåŒº -->
        <section class="results-section">
            <!-- å…«å­—éªŒè¯ç»“æœå±•ç¤ºåŒº -->
            <div class="result-box" id="baziResult">
                <div class="result-header">
                    <h4>ğŸ“„ å…«å­—å‘½ç›˜éªŒè¯ç»“æœ</h4>
                    <span class="result-status" id="baziStatus">ç­‰å¾…ä¸Šä¼ ...</span>
                    <div class="result-actions">
                        <button class="btn-select" id="selectBaziBtn" onclick="selectResult('bazi')" style="display:none;">é€‰æ‹©æ­¤ç»“æœ</button>
                    </div>
                </div>
                <div class="result-content" id="baziResultContent">
                    <p class="empty-state">ä¸Šä¼ å…«å­—å‘½ç›˜åï¼ŒéªŒè¯ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                </div>
            </div>

            <!-- ç´«å¾®æ–—æ•°éªŒè¯ç»“æœå±•ç¤ºåŒº -->
            <div class="result-box" id="ziweiResult">
                <div class="result-header">
                    <h4>ğŸ“„ ç´«å¾®æ–—æ•°å‘½ç›˜éªŒè¯ç»“æœ</h4>
                    <span class="result-status" id="ziweiStatus">ç­‰å¾…ä¸Šä¼ ...</span>
                    <div class="result-actions">
                        <button class="btn-select" id="selectZiweiBtn" onclick="selectResult('ziwei')" style="display:none;">é€‰æ‹©æ­¤ç»“æœ</button>
                    </div>
                </div>
                <div class="result-content" id="ziweiResultContent">
                    <p class="empty-state">ä¸Šä¼ ç´«å¾®å‘½ç›˜åï¼ŒéªŒè¯ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                </div>
            </div>
        </section>

        <!-- ========== Mode B: çµä¼´ä¸»å¯¼å¼å…¨ç›˜éªŒè¯ ========== -->
        <!-- This section appears only after both charts are uploaded -->
        <section class="mode-b-section" id="modeBSection" style="display:none;">
            <div class="mode-b-header">
                <h2>ğŸ” å…¨ç›˜éªŒè¯åˆ†æ</h2>
                <p class="mode-b-subtitle">ä¸¤ä»½å‘½ç›˜å·²ä¸Šä¼ å®Œæˆï¼Œç°åœ¨å¯ä»¥è¿›è¡Œå…¨é¢çš„AIéªŒè¯åˆ†æ</p>
            </div>

            <!-- SOP æ¨¡æ¿é€‰æ‹© -->
            <div class="sop-selector">
                <label for="sopTemplate">
                    <strong>é€‰æ‹© SOP åˆ†ææ¨¡æ¿ï¼š</strong>
                </label>
                <select id="sopTemplate">
                    <option value="">-- è¯·é€‰æ‹©åˆ†ææ¨¡æ¿ --</option>
                    <option value="standard_v1">æ ‡å‡†å…¨ç›˜åˆ†æ v1.0</option>
                    <option value="career_focused_v1">äº‹ä¸šé‡ç‚¹åˆ†æ v1.0</option>
                    <option value="relationship_focused_v1">æ„Ÿæƒ…é‡ç‚¹åˆ†æ v1.0</option>
                </select>
                <button onclick="uploadCustomSOP()" class="btn-secondary" style="margin-top: 12px;">
                    ä¸Šä¼ è‡ªå®šä¹‰ SOP æ¨¡æ¿
                </button>
                <input type="file" id="sopFileInput" accept=".json" style="display:none;">
            </div>

            <!-- çµä¼´æç¤ºåŒº -->
            <div class="ai-message-box" id="aiMessageBox">
                <div class="icon">ğŸ‘‹</div>
                <div class="message">
                    <strong>å‘½ç›˜å¯¼å…¥å®Œæˆã€‚</strong><br>
                    æ¥ä¸‹æ¥æˆ‘ä¼šä¾æ®æ­¤å‡ºç”Ÿæ—¶è¾°ï¼Œä¾æ¬¡åˆ†æå…­äº²ã€ç«¥å¹´ã€äº‹ä»¶ã€æ„Ÿæƒ…ã€äº‹ä¸šä¸å¥åº·ã€‚<br>
                    ç‚¹å‡»ä¸‹æ–¹ã€å¼€å§‹åˆ†æã€‘æŒ‰é’®å³å¯å¯åŠ¨å…¨ç›˜éªŒè¯ã€‚
                </div>
            </div>

            <!-- å¼€å§‹åˆ†ææŒ‰é’® -->
            <button id="startAnalysisBtn" class="start-analysis-btn" disabled onclick="startFullChartAnalysis()">
                è¯·å…ˆé€‰æ‹©åˆ†ææ¨¡æ¿
            </button>

            <!-- åˆ†æç»“æœåŒº -->
            <div class="analysis-results" id="analysisResults">
                <h2>åˆ†æç»“æœ</h2>

                <!-- å¹¶æ’æ˜¾ç¤ºå…«å­—ä¸ç´«å¾®åˆ†æ -->
                <div class="results-grid">
                    <div class="ai-column" id="baziAnalysisResults">
                        <h3>å…«å­— AI åˆ†æ</h3>
                        <div class="loading" style="text-align: center; padding: 40px; color: #888;">
                            <div class="loading-spinner"></div>
                            åˆ†æä¸­...
                        </div>
                    </div>
                    <div class="ai-column" id="ziweiAnalysisResults">
                        <h3>ç´«å¾® AI åˆ†æ</h3>
                        <div class="loading" style="text-align: center; padding: 40px; color: #888;">
                            <div class="loading-spinner"></div>
                            åˆ†æä¸­...
                        </div>
                    </div>
                </div>

                <!-- å¯¹æ¯”è¡¨æ ¼ -->
                <h3 style="margin-top: 40px; color: #00ff9d;">åˆ†æå¯¹æ¯”</h3>
                <table class="comparison-table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>æ¨¡å—</th>
                            <th>å…«å­—ç»“è®º</th>
                            <th>ç´«å¾®ç»“è®º</th>
                            <th>ä¸€è‡´åº¦</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>

                <!-- çµä¼´æ€»ç»“ -->
                <div class="ai-summary" id="aiSummarySection" style="display:none;">
                    <h3>ğŸª¶ çµä¼´æ€»ç»“</h3>
                    <div id="summaryContent"></div>
                </div>
            </div>
        </section>
        <!-- ========== End Mode B Section ========== -->
    </main>

    <!-- å³ä¾§ï¼šPrimary Chatboxï¼ˆå”¯ä¸€å¯å¯¹è¯çš„ AIï¼‰ -->
    <aside class="chatbox-panel">
        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="chatbox-user-info" id="chatboxUserInfo">
            <div class="user-avatar-display" id="chatboxUserAvatar"></div>
            <div class="user-nickname" id="chatboxUserNickname"></div>
        </div>
        
        <div class="chatbox-header">
            <h3>ğŸ’¬ Child AI åŠ©æ‰‹</h3>
            <p class="chatbox-subtitle">æˆ‘ä¼šå¼•å¯¼ä½ å®Œæˆå‘½ç›˜éªŒè¯</p>
            <button id="expandChatBtn" class="expand-chat-btn" onclick="toggleChatExpand()">
                <span id="expandIcon">â›¶</span>
            </button>
        </div>
        
        <!-- ç»“æœé€‰æ‹©åŒºåŸŸ -->
        <div class="result-selection" id="resultSelection" style="display:none;">
            <h4>ğŸ¯ éªŒè¯ç»“æœé€‰æ‹©</h4>
            <p>è¯·é€‰æ‹©ä½ è®¤ä¸ºæœ€å‡†ç¡®çš„éªŒè¯ç»“æœï¼š</p>
            <div class="selection-options">
                <div class="selection-option">
                    <input type="radio" id="preferBazi" name="preferredResult" value="bazi">
                    <label for="preferBazi">å…«å­—å‘½ç›˜éªŒè¯ç»“æœ</label>
                </div>
                <div class="selection-option">
                    <input type="radio" id="preferZiwei" name="preferredResult" value="ziwei">
                    <label for="preferZiwei">ç´«å¾®æ–—æ•°å‘½ç›˜éªŒè¯ç»“æœ</label>
                </div>
                <div class="selection-option">
                    <input type="radio" id="preferBoth" name="preferredResult" value="both">
                    <label for="preferBoth">æ˜¾ç¤ºä¸¤ä¸ªç»“æœ</label>
                </div>
            </div>
            <button class="btn-confirm" onclick="confirmResultSelection()">ç¡®è®¤é€‰æ‹©</button>
        </div>
        
        <div class="chatbox-messages" id="chatMessages">
            <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message ai-message">
                <div class="message-content">
                    <p>ä½ å¥½ï¼æˆ‘æ˜¯ Child AI åŠ©æ‰‹ã€‚</p>
                    <p>è¯·å…ˆä¸Šä¼ ä½ çš„<strong>å…«å­—å‘½ç›˜</strong>ï¼ˆå¯ä»¥æ‹–æ‹½å›¾ç‰‡æˆ–ç²˜è´´æ–‡æœ¬åˆ°å·¦ä¾§ä¸Šä¼ æ¡†ï¼‰ã€‚</p>
                    <p>ä¸Šä¼ åï¼Œæˆ‘ä¼šå¸®ä½ åˆ†æéªŒè¯ç»“æœã€‚</p>
                </div>
            </div>
        </div>
        
        <div class="chatbox-input-area">
            <textarea 
                id="chatInput" 
                class="chatbox-input" 
                placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–å›å¤..."
                rows="2"
            ></textarea>
            <button id="chatSendBtn" class="chatbox-send-btn">å‘é€</button>
        </div>
    </aside>
</div>

<script>
// åˆå§‹åŒ–èŠå¤©æ¡†é¡¶éƒ¨çš„ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    const userData = {{ user_data | tojson }};
    
    if (userData && userData.nickname) {
        // ç”Ÿæˆç”¨æˆ·å¤´åƒ
        const avatarEl = document.getElementById('chatboxUserAvatar');
        const nicknameEl = document.getElementById('chatboxUserNickname');
        
        if (avatarEl && nicknameEl) {
            // ä½¿ç”¨user-avatar.jsçš„ç”Ÿæˆå‡½æ•°
            if (typeof generateUserAvatar === 'function') {
                const avatarData = generateUserAvatar(userData.nickname, userData.email);
                avatarEl.textContent = avatarData.text;
                avatarEl.style.background = avatarData.gradient;
            } else {
                // é™çº§æ–¹æ¡ˆï¼šç®€å•æ˜¾ç¤ºé¦–å­—æ¯
                const firstChar = userData.nickname.charAt(0).toUpperCase();
                avatarEl.textContent = firstChar;
                avatarEl.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            // æ˜¾ç¤ºæ˜µç§°
            nicknameEl.textContent = userData.nickname;
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
        if (window.userProfileCard && typeof window.userProfileCard.init === 'function') {
            window.userProfileCard.init(userData);
        }
        
        // æ·»åŠ hoverè§¦å‘æœºåˆ¶
        const userInfoEl = document.getElementById('chatboxUserInfo');
        if (userInfoEl) {
            let hoverTimeout;
            
            userInfoEl.addEventListener('mouseenter', function() {
                // å»¶è¿Ÿ300msæ˜¾ç¤ºï¼Œé¿å…è¯¯è§¦
                hoverTimeout = setTimeout(function() {
                    if (window.userProfileCard && typeof window.userProfileCard.openProfileCard === 'function') {
                        window.userProfileCard.openProfileCard();
                    }
                }, 300);
            });
            
            userInfoEl.addEventListener('mouseleave', function() {
                // æ¸…é™¤å»¶è¿Ÿæ˜¾ç¤º
                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                }
            });
            
            // ä¹Ÿæ”¯æŒç‚¹å‡»è§¦å‘
            userInfoEl.addEventListener('click', function() {
                if (window.userProfileCard && typeof window.userProfileCard.openProfileCard === 'function') {
                    window.userProfileCard.openProfileCard();
                }
            });
        }
    }
});
</script>

<div class="user-profile-card-overlay" id="profileCardOverlay">
    <div class="user-profile-card" id="userProfileCard">
        <button class="close-btn" id="closeProfileCard">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
        
        <div class="profile-header">
            <h3 data-i18n="navbar.profileCard.title">ä¸ªäººä¿¡æ¯</h3>
        </div>
        
        <div class="profile-user-info">
            <div class="profile-avatar-large" id="profileAvatarLarge"></div>
            <div class="profile-user-details">
                <div class="profile-nickname-row">
                    <span class="profile-nickname" id="profileNickname">æ˜µç§°</span>
                    <span class="user-type-badge" id="userTypeBadge" data-i18n="navbar.profileCard.normalUser">ä½“éªŒç‰ˆ</span>
                    <button class="btn-subscribe" data-i18n="navbar.profileCard.subscribe">è®¢é˜…å¥—é¤</button>
                </div>
                <div class="profile-meta">
                    <span data-i18n="navbar.profileCard.registeredSince">å¥—é¤åˆ°æœŸæ—¶é—´ï¼š</span>
                    <span id="profileRegisteredDate">2025.09.20</span>
                </div>
            </div>
        </div>
        
        <div class="profile-actions">
            <a href="/user/profile" class="btn-primary" data-i18n="navbar.profileCard.goToProfile">
                å‰å¾€ä¸ªäººé¡µé¢
            </a>
        </div>
        
        <div class="profile-divider"></div>
        
        <div class="profile-section">
            <h4 data-i18n="navbar.profileCard.linkedAccounts">ç»‘å®šè´¦å·</h4>
            <p class="profile-hint" data-i18n="navbar.profileCard.linkedAccountsHint">æ‚¨å¯ä»¥åœ¨ä¸‹æ–¹ç»‘å®šæ›´å¤šéªŒè¯è´¦å·</p>
            
            <div class="linked-accounts">
                <div class="linked-account-item">
                    <div class="account-icon">ğŸ“±</div>
                    <div class="account-info">
                        <span class="account-label" data-i18n="navbar.profileCard.phone">ç»‘å®šæ‰‹æœº</span>
                        <span class="account-value" id="linkedPhoneValue">æœªç»‘å®šæ‰‹æœº</span>
                    </div>
                    <button class="btn-link" data-i18n="navbar.profileCard.bind">ç»‘å®š</button>
                </div>
                
                <div class="linked-account-item">
                    <div class="account-icon">ğŸ’¬</div>
                    <div class="account-info">
                        <span class="account-label" data-i18n="navbar.profileCard.wechat">ç»‘å®šå¾®ä¿¡</span>
                        <span class="account-value" id="linkedWechatValue">å·²ç»‘å®šå¾®ä¿¡å·</span>
                    </div>
                    <button class="btn-link" data-i18n="navbar.profileCard.unbind">è§£ç»‘</button>
                </div>
            </div>
        </div>
        
        <div class="profile-divider"></div>
        
        <div class="profile-section">
            <h4 data-i18n="navbar.profileCard.apiUsage">API ä½¿ç”¨æƒ…å†µ</h4>
            <p class="profile-hint" data-i18n="navbar.profileCard.apiUsageHint">å½“å‰å¥—é¤ä½™é¢ Token ä½¿ç”¨é‡</p>
            
            <div class="api-usage">
                <div class="api-usage-item">
                    <div class="api-usage-header">
                        <span class="api-usage-label" data-i18n="navbar.profileCard.dailyUsed">ä»Šæ—¥å·²ç”¨</span>
                        <span class="api-usage-value" id="dailyUsageValue">1,250 / 10,000</span>
                    </div>
                    <div class="api-progress-bar">
                        <div class="api-progress-fill" id="dailyProgressFill" style="width: 12.5%"></div>
                    </div>
                    <div class="api-progress-percentage" id="dailyPercentage">12.5% å·²ä½¿ç”¨</div>
                </div>
                
                <div class="api-usage-item">
                    <div class="api-usage-header">
                        <span class="api-usage-label" data-i18n="navbar.profileCard.monthlyRemaining">æœ¬æœˆå‰©ä½™</span>
                        <span class="api-usage-value" id="monthlyUsageValue">48,750 Token</span>
                    </div>
                    <div class="api-progress-bar">
                        <div class="api-progress-fill" id="monthlyProgressFill" style="width: 51.25%"></div>
                    </div>
                    <div class="api-progress-percentage" id="monthlyPercentage">51.3% å·²ä½¿ç”¨</div>
                </div>
            </div>
        </div>
        
        <div class="profile-logout">
            <button class="btn-logout" id="logoutBtn" data-i18n="navbar.profileCard.logout">
                é€€å‡ºç™»å½•
            </button>
        </div>
    </div>
</div>

<script src="/static/js/auto_env_fill.js"></script>
<script src="/static/js/ziwei_summary.js?v=2.1"></script>
<script src="/static/js/verify_wizard.js"></script>
</body>
</html>
