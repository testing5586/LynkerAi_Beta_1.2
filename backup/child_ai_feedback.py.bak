"""
child_ai_feedback.py
-------------------------------------
ğŸ“˜ åŠŸèƒ½ï¼š
è®©ç”¨æˆ·å¯¹å­AIç”Ÿæˆçš„åŒ¹é…æŠ¥å‘Š (child_ai_insights) è¿›è¡Œåé¦ˆï¼š
ğŸ‘ å–œæ¬¢ / ğŸ‘ ä¸å–œæ¬¢
ç³»ç»Ÿä¼šè®°å½•åé¦ˆå¹¶å­˜å…¥ Supabase è¡¨ child_ai_feedback

ğŸª¶ å…¼å®¹ç»“æ„ï¼š
- è‹¥ Supabase ä¸å¯ç”¨ï¼Œä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ° JSON å¤‡ä»½æ–‡ä»¶
- ä»…ä¾èµ– supabase_init.get_supabase()

-------------------------------------
è¿è¡Œæ–¹å¼ï¼š
python child_ai_feedback.py
"""

from datetime import datetime
import json, os

try:
    from supabase_init import get_supabase
    supabase = get_supabase()
except Exception as e:
    supabase = None
    print(f"âš ï¸ Supabaseè¿æ¥å¤±è´¥ï¼Œæœ¬åœ°æ¨¡å¼å¯ç”¨ï¼š{e}")

# âœ… è¡¨å
TABLE_NAME = "child_ai_feedback"

# âœ… è‡ªåŠ¨å»ºè¡¨ SQLï¼ˆä¾›ä½ æ‰‹åŠ¨å¤åˆ¶åˆ° Supabase SQL Editorï¼‰
CREATE_TABLE_SQL = """
CREATE TABLE IF NOT EXISTS public.child_ai_feedback (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id TEXT NOT NULL,
    partner_id TEXT NOT NULL,
    liked BOOLEAN DEFAULT FALSE,
    comment TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_feedback_user ON public.child_ai_feedback (user_id);
CREATE INDEX IF NOT EXISTS idx_feedback_partner ON public.child_ai_feedback (partner_id);
"""

# âœ… ä¿å­˜åé¦ˆï¼ˆè‡ªåŠ¨å†™å…¥ Supabase / æœ¬åœ°å¤‡ä»½ï¼‰
def save_feedback(user_id, partner_id, liked, comment=""):
    record = {
        "user_id": user_id,
        "partner_id": partner_id,
        "liked": liked,
        "comment": comment,
        "created_at": datetime.now().isoformat()
    }

    if supabase:
        try:
            supabase.table(TABLE_NAME).insert(record).execute()
            print(f"ğŸ’¾ åé¦ˆå·²ä¿å­˜åˆ° Supabase â†’ {user_id} â†” {partner_id} [{'ğŸ‘' if liked else 'ğŸ‘']}")
        except Exception as e:
            print(f"âš ï¸ Supabase å†™å…¥å¤±è´¥ï¼Œè½¬ä¸ºæœ¬åœ°å¤‡ä»½: {e}")
            save_feedback_local(record)
    else:
        save_feedback_local(record)


# âœ… æœ¬åœ° JSON å¤‡ä»½
def save_feedback_local(record):
    os.makedirs("./data", exist_ok=True)
    backup_file = "./data/child_ai_feedback_backup.jsonl"
    with open(backup_file, "a", encoding="utf-8") as f:
        f.write(json.dumps(record, ensure_ascii=False) + "\n")
    print(f"ğŸ’¾ å·²æœ¬åœ°ä¿å­˜åé¦ˆï¼š{record['user_id']} â†” {record['partner_id']} [{'ğŸ‘' if record['liked'] else 'ğŸ‘']}")


# âœ… æµ‹è¯•å‡½æ•°ï¼ˆå¯é€‰ï¼‰
def test_feedback_flow():
    print("ğŸ§ª æµ‹è¯•åé¦ˆæµç¨‹...")
    save_feedback("u_demo", "u_test1", True, "æ„Ÿè§‰è¿™ä¸ªäººå‘½æ ¼å¾ˆåƒæˆ‘ ğŸ‘")
    save_feedback("u_demo", "u_test2", False, "å‘½æ ¼å¤ªä¸åŒï¼Œä¸åˆé€‚ ğŸ‘")

if __name__ == "__main__":
    print("ğŸš€ å­AIåé¦ˆæ¨¡å—å¯åŠ¨ä¸­...")
    test_feedback_flow()
    print("âœ… æµ‹è¯•å®Œæˆï¼")
