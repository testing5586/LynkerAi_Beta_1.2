Replit ä¿®å¤ Promptï¼ˆå®Œæ•´ç‰ˆï¼Œå¯ç›´æ¥è´´å…¥ï¼‰
Please patch the backend to fix the Bazi AI not reading pasted chart text (å‘½ç›˜æ•°æ®ä¸å®Œæ•´é—®é¢˜).

ğŸ“ File: admin_dashboard/verify/routes_full_chart.py

### STEP 1 â€” Import dependencies
At the top of the file (after existing imports), ensure this is present:
--------------------------------------------------
import re
import json
--------------------------------------------------

### STEP 2 â€” Add text parser function
Place this helper anywhere above run_full_chart_ai():

--------------------------------------------------
def parse_bazi_text(text):
    """è§£æç”¨æˆ·ç²˜è´´çš„å…«å­—æ–‡æœ¬ä¸ºJSONç»“æ„"""
    if not text:
        return {"parsed": None}

    data = {}
    lines = text.strip().split("\n")

    # å››æŸ±è¯†åˆ«
    for line in lines:
        if "å¹´æŸ±" in line or "æœˆæŸ±" in line or "æ—¥æŸ±" in line or "æ—¶æŸ±" in line:
            match = re.findall(r"([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])", line)
            if match and len(match) >= 4:
                data["year_pillar"], data["month_pillar"], data["day_pillar"], data["hour_pillar"] = match[:4]

        if "é˜³å†" in line or "å‡ºç”Ÿ" in line:
            date = re.findall(r"(\d{4}[å¹´\-\.]\d{1,2}[æœˆ\-\.]\d{1,2})", line)
            if date:
                data["birth_date"] = date[0]

    # å¤©å¹²åœ°æ”¯è¡¨è¯†åˆ«ï¼ˆä¾‹å¦‚è¡Œå†…åŒ…å« å¤©å¹²ã€åœ°æ”¯ï¼‰
    if not data and ("å¤©å¹²" in text or "åœ°æ”¯" in text):
        match_all = re.findall(r"([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])", text)
        if len(match_all) >= 4:
            data["year_pillar"], data["month_pillar"], data["day_pillar"], data["hour_pillar"] = match_all[:4]

    return {"parsed": data if data else None}
--------------------------------------------------

### STEP 3 â€” Inject into main analysis route
Inside `run_full_chart_ai()`, locate where the request body is read:

```python
bazi_chart = data.get("bazi_chart")
ziwei_chart = data.get("ziwei_chart")


Immediately below that, insert this logic:

Try to parse plain-text Bazi input

if isinstance(bazi_chart, str):
if not bazi_chart.strip().startswith("{"):
parsed = parse_bazi_text(bazi_chart)
bazi_data = parsed if parsed else {"parsed": None}
else:
try:
bazi_data = json.loads(bazi_chart)
except Exception:
bazi_data = {"parsed": None}
else:
bazi_data = bazi_chart if bazi_chart else {"parsed": None}

Ziwei JSON
try:
ziwei_data = json.loads(ziwei_chart) if ziwei_chart else {}
except Exception:
ziwei_data = {}
STEP 4 â€” Keep existing AI flow unchanged

Ensure the next few lines (that check for completeness) remain:

if not bazi_data or not bazi_data.get("parsed"):
    return {"summary": "å‘½ç›˜æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆåˆ†æã€‚", "confidence": "ä½"}

STEP 5 â€” Restart Flask

After saving, restart the server in Replit (Ctrl+C then python main.py).

ğŸ§ª Test

Paste your full Bazi text in the textarea (the same as screenshot).

Click ã€Œå¼€å§‹åˆ†æã€ under Mode B.

Observe backend logs â€” you should see:

[Mode B] Parsed Bazi pillars: {'year_pillar': 'åºšè¾°', 'month_pillar': 'å·±å¯', 'day_pillar': 'ä¸ä¸‘', 'hour_pillar': 'ç”²è¾°'}


â€œå‘½ç›˜æ•°æ®ä¸å®Œæ•´â€ will disappear and å…«å­— AI will joinç´«å¾®åˆ†æè¾“å‡ºã€‚