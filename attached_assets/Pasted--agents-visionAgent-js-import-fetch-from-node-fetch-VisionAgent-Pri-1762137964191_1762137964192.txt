// agents/visionAgent.js
import fetch from "node-fetch";

/**
 * VisionAgent â€” å¤šå±‚è¯†åˆ«ä¸å›é€€é€»è¾‘
 * Primary: MiniMax-VL-01
 * Fallback: GPT-4-Turbo-Vision
 * Last resort: Local simulation
 */
export async function VisionAgent(input, socket) {
  const minimaxKey = process.env.MINIMAX_API_KEY;
  const openaiKey = process.env.OPENAI_API_KEY;

  // æœ‰å›¾å°±å…ˆè¯• MiniMaxï¼Œå¦åˆ™ç›´æ¥èµ°æ–‡å­—æˆ–æ¨¡æ‹Ÿ
  if (!input?.image_url && !input?.image_base64) {
    socket?.emit("childAI_msg", "âš ï¸ æœªæ£€æµ‹åˆ°å›¾ç‰‡ï¼Œæ”¹ç”¨æ‰‹åŠ¨æ–‡æœ¬è¯†åˆ«ã€‚");
    return simulateFromText(input?.raw_text || "");
  }

  // â‘  MiniMax è¯†åˆ«
  if (minimaxKey) {
    socket?.emit("childAI_msg", "ğŸ“¸ ä½¿ç”¨ MiniMax-VL-01 è¯†åˆ«å…«å­—å‘½ç›˜...");
    try {
      const res = await fetch("https://api.minimax.chat/v1/text/chatcompletion_v2", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${minimaxKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "MiniMax-VL-01",
          messages: [
            {
              role: "user",
              content: [
                { type: "text", text: getPromptTemplate() },
                {
                  type: "image_url",
                  image_url: input.image_url || `data:image/png;base64,${input.image_base64}`
                }
              ]
            }
          ],
          stream: false
        })
      });

      if (!res.ok) throw new Error(`MiniMax è¿”å› ${res.status}`);
      const data = await res.json();
      let raw = data?.choices?.[0]?.message?.content || data?.text || "";

      try {
        const json = JSON.parse(raw);
        socket?.emit("childAI_msg", "âœ… MiniMax è¯†åˆ«æˆåŠŸã€‚");
        return formatResult("MiniMax-VL-01", raw, json);
      } catch {
        socket?.emit("childAI_msg", "âš ï¸ MiniMax è¿”å›éçº¯ JSONï¼Œåˆ‡æ¢ GPT-4-Vision...");
      }
    } catch (err) {
      socket?.emit("childAI_msg", `âŒ MiniMax å‡ºé”™ï¼š${err.message}`);
    }
  }

  // â‘¡ GPT-4-Turbo-Vision fallback
  if (openaiKey) {
    socket?.emit("childAI_msg", "ğŸ§  ä½¿ç”¨ GPT-4-Turbo-Vision å¤‡ç”¨è¯†åˆ«ä¸­...");
    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${openaiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-4-turbo",
          messages: [
            {
              role: "user",
              content: [
                { type: "text", text: getPromptTemplate() },
                {
                  type: "image_url",
                  image_url: input.image_url || `data:image/png;base64,${input.image_base64}`
                }
              ]
            }
          ]
        })
      });

      if (!res.ok) throw new Error(`OpenAI è¿”å› ${res.status}`);
      const data = await res.json();
      const raw = data?.choices?.[0]?.message?.content || "{}";
      try {
        const json = JSON.parse(raw);
        socket?.emit("childAI_msg", "âœ… GPT-4-Vision è¯†åˆ«æˆåŠŸã€‚");
        return formatResult("GPT-4-Turbo-Vision", raw, json);
      } catch {
        socket?.emit("childAI_msg", "âš ï¸ GPT-4-Vision è¿”å›éçº¯ JSONï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿã€‚");
      }
    } catch (err) {
      socket?.emit("childAI_msg", `âŒ GPT-4-Vision å‡ºé”™ï¼š${err.message}`);
    }
  }

  // â‘¢ æœ€ç»ˆæœ¬åœ°æ¨¡æ‹Ÿ
  socket?.emit("childAI_msg", "ğŸª„ æ‰€æœ‰æ¨¡å‹å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿç»“æœã€‚");
  return simulateFromImage();
}

// ---------- è¾…åŠ©å‡½æ•° ----------

function getPromptTemplate() {
  return `
ä½ æ˜¯ä¸€åä¸“ä¸šçš„å…«å­—å‘½ç›˜è¯†åˆ«å¸ˆã€‚
è¯·ä»”ç»†è¯»å–ä¸Šä¼ çš„å‘½ç›˜å›¾ç‰‡ï¼Œè¾“å‡ºä¸¥æ ¼çš„ JSONï¼Œä¸è¦é¢å¤–æ–‡å­—ï¼š

{
  "columns": ["å¹´æŸ±","æœˆæŸ±","æ—¥æŸ±","æ—¶æŸ±"],
  "rows": {
    "å¤©å¹²": ["","","",""],
    "åœ°æ”¯": ["","","",""],
    "è—å¹²": ["","","",""],
    "ä¸»æ˜Ÿ": ["","","",""],
    "å‰¯æ˜Ÿ": ["","","",""],
    "ç¥ç…": ["","","",""]
  }
}`;
}

function formatResult(model, raw, json) {
  return {
    layer: "layer1",
    success: true,
    model,
    confidence: 0.95,
    raw_text: raw,
    detected_elements: json
  };
}

// ---------- fallback æœ¬åœ°æ¨¡æ‹Ÿ ----------

function simulateFromImage() {
  return formatResult("local-simulated", sampleRawText(), fakeDetectedElements());
}

function simulateFromText(text) {
  return formatResult("manual-text", text, fakeDetectedElements());
}

function fakeDetectedElements() {
  return {
    columns: ["å¹´æŸ±", "æœˆæŸ±", "æ—¥æŸ±", "æ—¶æŸ±"],
    rows: {
      å¤©å¹²: ["åºš", "å·±", "ä¸", "ç”²"],
      åœ°æ”¯: ["è¾°", "å¯", "ä¸‘", "è¾°"],
      è—å¹²: ["æˆŠåœŸ ä¹™æœ¨ ç™¸æ°´", "ä¹™æœ¨", "å·±åœŸ ç™¸æ°´ è¾›é‡‘", "æˆŠåœŸ ä¹™æœ¨ ç™¸æ°´"],
      ä¸»æ˜Ÿ: ["æ­£è´¢", "é£Ÿç¥", "å…ƒç”·", "æ­£å°"],
      å‰¯æ˜Ÿ: ["ä¼¤å®˜ åå° ä¸ƒæ€", "åå°", "é£Ÿç¥ ä¸ƒæ€ åè´¢", "ä¼¤å®˜ åå° ä¸ƒæ€"],
      ç¥ç…: [
        "å›½å°è´µäºº",
        "å¤ªæè´µäºº æœˆå¾·åˆ",
        "é˜´å·®é˜³é”™ å¤©ä¹™è´µäºº å¾·ç§€è´µäºº å¯¡å®¿ æŠ«éº»",
        "å›½å°è´µäºº æœˆå¾·è´µäºº å¾·ç§€è´µäºº åç›–"
      ]
    }
  };
}

function sampleRawText() {
  return "å…«å­—ï¼šåºšè¾° å·±å¯ ä¸ä¸‘ ç”²è¾°ï¼ˆç¤ºä¾‹ï¼‰";
}
