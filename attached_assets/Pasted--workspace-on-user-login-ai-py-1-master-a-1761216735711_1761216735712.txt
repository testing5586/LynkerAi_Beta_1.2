åœ¨ ~/workspace/ ä¸­åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶ï¼šon_user_login_ai.py  
è¦æ±‚æ•´åˆä»¥ä¸‹åŠŸèƒ½ï¼š

ğŸ¯ æ–°å¢åŠŸèƒ½
1ï¸âƒ£ å½“ç”¨æˆ·ç™»å½•æ—¶ï¼š
   - è‡ªåŠ¨è§¦å‘ master_ai_reasoner.reason_user(user_id)
   - æŠŠé¢„æµ‹ç»“æœå†™å…¥ predictions è¡¨ï¼›
   - è‹¥ç½®ä¿¡åº¦ â‰¥ 0.6ï¼Œåˆ™è‡ªåŠ¨åˆ·æ–°ã€ŒTop 10 åŒå‘½æ¨èæ¦œã€ã€‚

2ï¸âƒ£ ä¿ç•™ Flask ç™»å½•è§¦å‘æ¥å£ï¼š
   - æ¥å£è·¯å¾„ï¼š/login_refresh
   - å‚æ•°æ ¼å¼ï¼š{"user_id": 2}
   - è¿”å›æ•°æ®åŒ…æ‹¬ï¼š
     âœ… AIé¢„æµ‹ç»“æœ
     âœ… åŒ¹é…æ¨èæ¦œTop 10ï¼ˆæ¥è‡ª recommendations è¡¨ï¼‰

3ï¸âƒ£ æƒé™æ§åˆ¶ï¼š
   - æ™®é€šç”¨æˆ·ä½¿ç”¨è‡ªå·±çš„ AI Providerï¼ˆfreeï¼‰
   - Master AI / Superintendent Admin ä½¿ç”¨ Lynker ä¸» Key
   - ä»…å½“ç”¨æˆ·è§¦å‘ç™»å½•æ—¶è¿è¡Œï¼Œä¸åšåå°å¾ªç¯ï¼ˆèŠ‚çœ tokenï¼‰

4ï¸âƒ£ è‡ªåŠ¨æ—¥å¿—è®°å½•ï¼š
   - æ¯æ¬¡è§¦å‘éƒ½å†™å…¥ logs/user_login_activity.log
   - åŒ…å«æ—¶é—´æˆ³ã€ç”¨æˆ·IDã€é¢„æµ‹ç½®ä¿¡åº¦ã€æ¨èæ¦œåˆ·æ–°çŠ¶æ€

ğŸ“„ ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š
-------------------------------------------------------------

import os
from flask import Flask, request, jsonify
from datetime import datetime
from master_ai_reasoner import reason_user
from supabase import create_client, Client

SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
client: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

app = Flask(__name__)

LOG_PATH = "logs/user_login_activity.log"
os.makedirs("logs", exist_ok=True)

def write_log(msg):
    with open(LOG_PATH, "a", encoding="utf-8") as f:
        f.write(f"[{datetime.now()}] {msg}\n")

def get_top_10_recommendations():
    try:
        resp = client.table("recommendations").select("user_a_name,user_b_name,match_score,matching_fields").order("match_score", desc=True).limit(10).execute()
        return resp.data or []
    except Exception as e:
        print("âš ï¸ æ— æ³•è·å–æ¨èæ¦œ:", e)
        return []

@app.route("/login_refresh", methods=["POST"])
def login_refresh():
    data = request.json
    user_id = data.get("user_id")
    if not user_id:
        return jsonify({"error": "ç¼ºå°‘ user_id å‚æ•°"}), 400

    write_log(f"ğŸ”” ç”¨æˆ· {user_id} ç™»å½•è§¦å‘æ¨ç†å¼•æ“...")

    # æ‰§è¡Œä¸ªä½“æ¨ç†
    try:
        result = reason_user(user_id)
    except Exception as e:
        write_log(f"âŒ æ¨ç†é”™è¯¯: {e}")
        return jsonify({"status": "error", "msg": str(e)}), 500

    prediction = result.get("prediction", {})
    conf = prediction.get("confidence", 0)
    refreshed = False

    # è‹¥ç½®ä¿¡åº¦é«˜åˆ™åˆ·æ–°æ¨èæ¦œ
    if conf >= 0.6:
        write_log(f"âœ… ç”¨æˆ· {user_id} æ¨ç†ç½®ä¿¡åº¦é«˜({conf})ï¼Œåˆ·æ–°æ¨èæ¦œã€‚")
        refreshed = True

    top10 = get_top_10_recommendations()
    write_log(f"ğŸ“Š ç™»å½•ç»“æœ: user={user_id}, conf={conf}, refreshed={refreshed}")

    return jsonify({
        "status": "ok",
        "user_id": user_id,
        "prediction": prediction,
        "recommendations": top10
    })

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)

-------------------------------------------------------------

ğŸ’¾ ä¿å­˜åè‡ªåŠ¨éªŒè¯ï¼š
1ï¸âƒ£ ç¡®ä¿ /login_refresh å¯POSTï¼›
2ï¸âƒ£ è¿”å›ç”¨æˆ·é¢„æµ‹ç»“æœä¸æ¨èæ¦œï¼›
3ï¸âƒ£ åœ¨ logs æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆ activity.logï¼›
4ï¸âƒ£ è¾“å‡º âœ… Master AI ç™»å½•è§¦å‘æ¨ç†æ¨¡å—åˆ›å»ºæˆåŠŸã€‚
