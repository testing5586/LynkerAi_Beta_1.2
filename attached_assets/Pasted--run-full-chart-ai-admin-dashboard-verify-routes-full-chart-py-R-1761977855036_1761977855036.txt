â‘  åç«¯ï¼šä¿® run_full_chart_ai çš„ã€Œå…«å­—ä¸å®Œæ•´å°±åˆ«ä¹±å†™ã€é€»è¾‘

å»ä½ ç°åœ¨çš„ admin_dashboard/verify/routes_full_chart.pyï¼ˆåå­—å¯èƒ½æ˜¯è¿™ä¸ªï¼ŒReplit è¯´è¿‡ä½ æœ‰è¿™ä¸ªæ–‡ä»¶ï¼‰ï¼ŒæŠŠå…«å­—åˆ†æé‚£æ®µæ¢æˆä¸‹é¢è¿™ä¸ªæ€è·¯ï¼š

# åŸæ¥å¯èƒ½æ˜¯è¿™æ ·ä¼ªä»£ç ï¼š
# bazi_result = run_bazi_ai(bazi_text)

# æˆ‘ä»¬æ”¹æˆè¿™æ ·ï¼š
from .bazi_parser import parse_bazi_text   # ä¸‹é¢æˆ‘ä¼šç»™ä½ è¿™ä¸ªæ–‡ä»¶
from .ziwei_parser import parse_wenmo_text

@app.route("/verify/api/run_full_chart_ai", methods=["POST"])
def run_full_chart_ai():
    data = request.get_json()
    bazi_text = data.get("bazi_text", "") or ""
    ziwei_text = data.get("ziwei_text", "") or ""
    sop_template = data.get("sop_template", "standard_v1")

    # â‘  å…ˆæŠŠå…«å­—ã€ç´«å¾®éƒ½æ ‡å‡†åŒ–
    bazi_parsed = parse_bazi_text(bazi_text)
    ziwei_parsed = parse_wenmo_text(ziwei_text)

    # â‘¡ çœ‹å…«å­—æœ‰æ²¡æœ‰â€œå¯éªŒè¯å­—æ®µâ€
    bazi_incomplete = not bazi_parsed.get("has_details", False)

    # â‘¢ æ ¹æ® SOP ç”Ÿæˆè¦é—®çš„æ¨¡å—
    #    è¿™é‡Œå…ˆå†™æ­»ï¼Œåé¢ä½ å†ä» json æ¨¡æ¿é‡Œè¯»
    required_modules = [
        "å…­äº²å…³ç³»",
        "ç«¥å¹´ç»å†",
        "é‡å¤§äº‹ä»¶",
        "æ„Ÿæƒ…å©šå§»",
        "äº‹ä¸šè´¢è¿",
        "å¥åº·çŠ¶å†µ",
    ]

    # â‘£ å¦‚æœå…«å­—ä¸å®Œæ•´ â†’ ä¸è¦å†™æ•…äº‹ï¼Œç›´æ¥è®©å‰ç«¯å¼¹ prophecy-mode
    if bazi_incomplete:
        return jsonify({
            "ok": True,
            "mode": "need_prophecy_feedback",
            "bazi": {
                "parsed": bazi_parsed,
                "status": "incomplete",
                "message": "å…«å­—å‘½ç›˜åªæœ‰å››æŸ±ï¼Œç¼ºå°‘å¯éªŒè¯çš„ç”Ÿæ´»äº‹ä»¶ï¼Œè¯·ç”¨æˆ·ç‚¹å‡†/ä¸å‡†åå†ç»¼åˆã€‚",
                "required_modules": required_modules,
            },
            "ziwei": {
                "parsed": ziwei_parsed,
                "status": "ok"
            },
            "toast": "å·²ç”Ÿæˆè¦éªŒè¯çš„æ¨¡å—ï¼Œè¯·å‰ç«¯å¼¹å‡ºç‚¹å‡†æœºåˆ¶ã€‚"
        }), 200

    # â‘¤ å¦åˆ™æ‰èµ°çœŸæ­£çš„å…«å­—AIåˆ†æï¼ˆä½ åŸæ¥çš„é‚£æ®µï¼‰
    bazi_ai_result = run_bazi_ai_chain(bazi_parsed, sop_template)
    ziwei_ai_result = run_ziwei_ai_chain(ziwei_parsed, sop_template)

    merged = merge_bazi_ziwei(bazi_ai_result, ziwei_ai_result)

    return jsonify({
        "ok": True,
        "mode": "full_completed",
        "bazi": bazi_ai_result,
        "ziwei": ziwei_ai_result,
        "merged": merged,
    }), 200


å…³é”®ç‚¹ï¼šæˆ‘ä»¬ä¸å†è®©åç«¯ç¡¬å†™â€œæ•´ä½“è¶‹åŠ¿ä¸äººç”Ÿè½¨è¿¹å»åˆåº¦è¾ƒé«˜â€è¿™å¥äº†ï¼Œè€Œæ˜¯æ˜ç¡®å‘Šè¯‰å‰ç«¯ï¼šâ€œå–‚ï¼Œè¿™ä¸ªå…«å­—å¤ªç˜¦äº†ï¼Œè¦ä½ ç”¨æˆ·æ¥ç‚¹å‡†â€ã€‚

â‘¡ æ–°å¢ä¸€ä¸ªè¶…å®¹é”™çš„å…«å­— parserï¼ˆåƒä½ åˆšåˆšè´´çš„é‚£ç§å››æŸ±æ–‡æœ¬ï¼‰

æ–°å»ºä¸€ä¸ª admin_dashboard/verify/bazi_parser.pyï¼š

import re

FOUR_PILLAR_KEYS = ["å¹´æŸ±", "æœˆæŸ±", "æ—¥æŸ±", "æ—¶æŸ±"]

def parse_bazi_text(raw: str) -> dict:
    text = (raw or "").strip()
    # æŠŠå…¨è§’å†’å·ã€ç©ºæ ¼ã€æ¢è¡Œéƒ½æ”¶æ‹¾ä¸€ä¸‹
    text = text.replace("ï¼š", ":").replace("ã€€", " ").replace("\r\n", "\n")

    result = {
        "year_pillar": "",
        "month_pillar": "",
        "day_pillar": "",
        "hour_pillar": "",
        "birth_datetime": "",
        "raw": raw,
        "has_details": False,   # è¿™ä¸ªå¾ˆé‡è¦ï¼Œåç«¯é å®ƒåˆ¤æ–­è¦ä¸è¦èµ°prophecy
    }

    # 1) å…ˆæŠ“å››æŸ±
    for line in text.split("\n"):
        line = line.strip()
        if not line:
            continue
        # å¯èƒ½æ˜¯ "å¹´æŸ±:åºšè¾°" ä¹Ÿå¯èƒ½æ˜¯ "å¹´æŸ±ï¼š åºšè¾°"
        m = re.match(r"^(å¹´æŸ±|æœˆæŸ±|æ—¥æŸ±|æ—¶æŸ±)\s*:\s*(.+)$", line)
        if m:
            key = m.group(1)
            val = m.group(2).strip()
            if key == "å¹´æŸ±":
                result["year_pillar"] = val
            elif key == "æœˆæŸ±":
                result["month_pillar"] = val
            elif key == "æ—¥æŸ±":
                result["day_pillar"] = val
            elif key == "æ—¶æŸ±":
                result["hour_pillar"] = val

        # å‡ºç”Ÿæ—¶é—´ / å‡ºç”Ÿæ—¥æœŸ
        if "å‡ºç”Ÿæ—¶é—´" in line or "å‡ºç”Ÿæ—¥æœŸ" in line:
            result["birth_datetime"] = line.split(":", 1)[-1].strip()

    # 2) åˆ¤æ–­æœ‰æ²¡æœ‰â€œå‘½ç†å¯ç”¨ä¿¡æ¯â€
    #    å¦‚æœåªæœ‰å››æŸ±ï¼Œæ²¡æœ‰â€œæ­£è´¢/ä¼¤å®˜/ä¸ƒæ€/è—å¹²/ç¥ç…â€è¿™ç±»å­—çœ¼ï¼Œå°±å½“å®ƒâ€˜ç»“æ„ä¸å®Œæ•´â€™
    has_detail_keywords = any(kw in text for kw in [
        "æ­£è´¢", "åè´¢", "é£Ÿç¥", "ä¼¤å®˜", "ä¸ƒæ€", "æ­£å®˜",
        "æ¯”è‚©", "åŠ«è´¢", "è—å¹²", "ç¥ç…", "çº³éŸ³", "å¤§è¿", "æµå¹´"
    ])

    # å››æŸ±é½äº† + æœ‰ç»†èŠ‚ï¼Œæ‰è¯´ has_details = True
    four_pillars_ok = all([
        result["year_pillar"],
        result["month_pillar"],
        result["day_pillar"],
        result["hour_pillar"],
    ])

    result["has_details"] = bool(four_pillars_ok and has_detail_keywords)
    return result


è¿™ä¸ª parser æœ‰ä¸‰ä¸ªç‰¹ç‚¹ï¼š

ä½ ç°åœ¨è¿™æ ·è´´çš„å››æŸ±å®ƒåƒå¾—ä¸‹ï¼›

å°†æ¥ä½ è¦è´´ä½ è‡ªå·±çš„è¡¨æ ¼ç‰ˆï¼ˆæœ‰â€œæ­£è´¢/ä¼¤å®˜/è—å¹²/ç¥ç…â€ï¼‰å®ƒä¹Ÿèƒ½åˆ¤æ–­ï¼›

æœ€é‡è¦ï¼šå®ƒä¼šå‘Šè¯‰åç«¯â€œåˆ«çå†™ï¼Œè¿™ç›˜è¦é—®ç”¨æˆ·â€ã€‚

â‘¢ å‰ç«¯ï¼šåªè¦åç«¯è¯´ mode: "need_prophecy_feedback"ï¼Œå°±å¼¹â€œå‡† / ä¸å‡†â€

åœ¨ä½ ç°åœ¨çš„ static/js/verify_wizard.js é‡Œï¼Œæ‰¾åˆ°ä½  Mode B ç‚¹å‡»â€œå¼€å§‹åˆ†æâ€åæ‹¿åˆ°ç»“æœçš„é‚£ä¸€æ®µï¼Œè¡¥ä¸Šè¿™ä¸ªåˆ†æ”¯ï¼š

async function startFullChartAnalysis() {
  // ... ä½ åŸæ¥çš„å– textarea çš„ä»£ç 
  const payload = { /* ... */ };

  const resp = await fetch("/verify/api/run_full_chart_ai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  const data = await resp.json();

  if (!data.ok) {
    showToast(data.toast || "åˆ†æå¤±è´¥");
    return;
  }

  // â‘  è¿™é‡Œæ˜¯é‡ç‚¹ï¼šåç«¯è¯´â€œèµ„æ–™ä¸å¤Ÿï¼Œè¦ç”¨æˆ·ç‚¹å‡†â€
  if (data.mode === "need_prophecy_feedback") {
    // æ˜¾ç¤º prophecy åŒºåŸŸ
    showProphecyPanel(data.bazi.required_modules || []);
    // åŒæ—¶è§¦å‘â€œæ ¹æ®ç´«å¾®ç»“æ„ç”Ÿæˆé¢˜ç›®â€
    runProphecyAIFromZiwei();
    return;
  }

  // â‘¡ å¦‚æœæ˜¯å®Œæ•´åˆ†æï¼Œå°±èµ°ä½ åŸæ¥çš„æ¸²æŸ“
  if (data.mode === "full_completed") {
    renderFullAnalysis(data);
  }
}


ç„¶ååŠ ä¸€ä¸ªå¾ˆç®€å•çš„ UI å¡«ç©ºå‡½æ•°ï¼ˆä½ å·²ç»æœ‰åœ°æ–¹äº†ï¼Œå°±æ˜¯ä½ æˆªå›¾é‚£ä¸ªâ€œğŸ“„ å…«å­—å‘½ç›˜éªŒè¯ç»“æœâ€ä¸‹é¢ï¼‰ï¼š

function showProphecyPanel(modules) {
  const box = document.getElementById("prophecy_zone");
  box.innerHTML = "<h4>è¯·ç‚¹é€‰ä»¥ä¸‹å‘½ç›˜é¢„è¨€æ˜¯å¦å‘½ä¸­ï¼š</h4>";
  modules.forEach((m, idx) => {
    box.innerHTML += `
      <div class="prophecy-card" data-module="${m}">
        <span>ã€${m}ã€‘æ­¤éƒ¨åˆ†éœ€è¦ä½ çš„çœŸå®ç»å†æ¥éªŒè¯ã€‚</span>
        <button onclick="reportProphecy('${m}', true)">âœ… å‡†</button>
        <button onclick="reportProphecy('${m}', false)">âŒ ä¸å‡†</button>
      </div>
    `;
  });
}
