çœŸå‘½ç›˜éªŒè¯ä¸­å¿ƒï¼ˆWizard + æ‰‹å†™è¡¥å…… + å…«å­—/ç´«å¾®å¯¼å…¥ï¼‰

è¯·åœ¨æœ¬é¡¹ç›®ä¸­å®Œæˆä»¥ä¸‹æ”¹é€ ã€‚æ‰€æœ‰è·¯å¾„ç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ã€‚

ç›®æ ‡

æ–°å¢ ç”¨æˆ·ä¸ªäººä¸»é¡µ â†’ æˆ‘çš„å‘½ç›˜ â†’ çœŸå‘½ç›˜éªŒè¯ä¸­å¿ƒ çš„å®Œæ•´æµç¨‹ï¼ˆæ¸©æŸ”å…³æ€€å‹è¯­æ°” Aï¼‰ã€‚

ä¸‰ç»„åˆï¼šâ‘  é€æ­¥é—®ç­” Wizardï¼ˆå®¶åº­/å­¦ä¸š/äº‹ä¸š/å©šå§»/è´¢åŠ¡/å¥åº·/é‡å¤§äº‹ä»¶ï¼‰â‘¡ æ‰‹å†™è¡¥å…… â‘¢ å‘½ç›˜å¯¼å…¥ï¼ˆå…«å­—+ç´«å¾®ï¼šä¸Šä¼ /æ‹–æ‹½/ç²˜è´´æ–‡æœ¬/OCRå ä½ï¼‰ã€‚

è§£æåæ‰§è¡ŒåŒ¹é…è¯„åˆ† â†’ è¾“å‡º 3 ç»„â€œå¯èƒ½çœŸå®å‘½ç›˜â€ â†’ ç”¨æˆ·ç¡®è®¤ â†’ å…¥åº“å½’æ¡£ï¼ˆSupabase birthcharts + verified_charts è¡¨ï¼‰ã€‚

æ‰‹åŠ¨å¡«å†™å§“å/æ€§åˆ« é”å®šä¼˜å…ˆï¼Œä¸ä¼šè¢«è¯†åˆ«å€¼è¦†ç›–ã€‚

æŠ€æœ¯æ ˆ

Flask (+SocketIO å·²æœ‰)ã€Jinja2ã€Tailwind/åŸç”ŸCSSã€ES6 modulesã€Supabase Python SDKï¼ˆå·²é…ç½®ï¼‰ã€‚
æ²¿ç”¨é¡¹ç›®é‡Œçš„ admin_dashboard åº”ç”¨ä¸ verification/verifier.pyã€‚

ä¸€ã€æ•°æ®åº“

æ–°å»ºè¡¨ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰ï¼š

verified_charts

create table if not exists public.verified_charts(
  id bigserial primary key,
  user_id bigint references public.users(id),
  source_text text,
  parsed jsonb,         -- è§£æåçš„ç»“æ„åŒ–å‘½ç›˜ï¼ˆå…«å­—/ç´«å¾®åˆå¹¶å­—æ®µï¼‰
  wizard jsonb,         -- é€æ­¥é—®ç­”ç»“æœ
  notes text,           -- æ‰‹å†™è¡¥å……
  candidates jsonb,     -- åŒ¹é…å€™é€‰({id,score,explain})
  chosen_id bigint,     -- ç”¨æˆ·ç¡®è®¤çš„birthcharts.id
  score numeric,        -- æœ€ç»ˆåŒ¹é…åˆ†
  created_at timestamptz default now()
);


ä¸º birthcharts å¢è¡¥åˆ—ï¼ˆè‹¥ç¼ºå°‘ï¼‰ï¼š

alter table public.birthcharts
  add column if not exists birth_data jsonb,
  add column if not exists source_type text;  -- 'bazi' | 'ziwei' | 'mix'

äºŒã€åç«¯ï¼ˆFlaskï¼‰

åœ¨ admin_dashboard/ ä¸‹æ–°å¢/ä¿®æ”¹ï¼š

æ–°å¢ Blueprint

admin_dashboard/verify/__init__.py

admin_dashboard/verify/routes.py è·¯ç”±ï¼š

GET /verify æ¸²æŸ“é¡µé¢

POST /api/verify/preview æ¥æ”¶ wizard+notes+å‘½ç›˜æ–‡æœ¬/æ–‡ä»¶ï¼Œè°ƒç”¨ verification/verifier.py è¿”å› parsed ä¸ score.breakdown

POST /api/verify/submit å…¥åº“ verified_chartsï¼Œå¿…è¦æ—¶å†™å…¥/æ›´æ–° birthcharts

POST /api/verify/ocrï¼ˆå ä½ï¼Œç›´æ¥å›ä¼ â€œæš‚ä¸å¯ç”¨OCRï¼Œè¯·ç²˜è´´æ–‡æœ¬/ä¸Šä¼ TXTâ€ï¼‰

å¤ç”¨å¹¶å¢å¼ºè§£æ

è°ƒç”¨ç°æœ‰ admin_dashboard/verification/verifier.py çš„è§£ææ–¹æ³•ï¼Œä¸è¦ç”¨ä¸»æ˜Ÿæ”¹åã€‚

å¢åŠ å‡½æ•° merge_manual_fields(parsed, manual)ï¼šè‹¥ manual.name_locked==true åˆ™å¼ºåˆ¶ä»¥æ‰‹åŠ¨å§“å/æ€§åˆ«è¦†ç›–ã€‚

æ–°å¢è¯„åˆ†å™¨ score_match(parsed, wizard, notes)ï¼šè¿”å›

{
  "score": 0.0-1.0,
  "weights": {"events":0.45,"traits":0.30,"marriage":0.15,"health":0.10},
  "signals": [{"key":"å¤§é™-äº‹ä»¶å‘½ä¸­","value":true,"weight":0.18}, ...],
  "candidates":[
     {"id": <birthcharts.id or null>, "label":"æˆŠè¾°å­æ—¶", "score":0.89, "explain":"å¤«å¦»å®«/å¤§é™å‘½ä¸­2å¤„"}
  ]
}


é€‰æ‹©ç¡®è®¤

POST /api/verify/confirmï¼šæ¥æ”¶ {user_id, chosen_id, score, parsed, wizard, notes, candidates}

å†™å…¥ verified_chartsï¼ˆå¸¦å®¡è®¡ï¼‰

å°†é€‰æ‹©çš„å‘½ç›˜ ID è®°å½•åˆ° users çš„ true_chart_idï¼ˆè‹¥ä½ å·²æœ‰è¯¥åˆ—ï¼Œå¦åˆ™è·³è¿‡ï¼‰

æ‰€æœ‰æ¥å£è¿”å›å½¢å¦‚ï¼š{"ok":true, "data":..., "toast":"æ¸©æŸ”æç¤ºè¯­"}

ä¸‰ã€å‰ç«¯ï¼ˆæ¨¡æ¿ä¸è„šæœ¬ï¼‰

æ¨¡æ¿

admin_dashboard/templates/verify.html
ç»“æ„ï¼ˆJinjaï¼‰ï¼š

é¡¶éƒ¨ï¼šæ¸©æŸ”æç¤ºæ–‡æ¡ˆï¼ˆå¦‚â€œæˆ‘ä¼šé™ªä½ ä¸€æ­¥æ­¥è¿˜åŸçœŸå®çš„å‡ºç”Ÿæ—¶è¾°â€ï¼‰

Wizard Stepperï¼ˆ7æ­¥ï¼Œæ¯æ­¥è¡¨å•+â€œä¸‹ä¸€æ­¥â€ï¼‰

æ‰‹å†™è¡¥å……ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼‰

å‘½ç›˜å¯¼å…¥ç»„åˆåŒºï¼š

Tabï¼šå…«å­— / ç´«å¾®

ä¸‰ç§æ–¹å¼ï¼šä¸Šä¼ TXTã€æ‹–æ‹½ã€ç²˜è´´æ–‡æœ¬ï¼ˆ<textarea>ï¼‰

OCRæŒ‰é’®ï¼ˆæç¤ºâ€œæš‚ä¸å¯ç”¨ï¼Œè¯·ä¼˜å…ˆç²˜è´´æ–‡æœ¬â€ï¼‰

æ‰‹åŠ¨å§“å/æ€§åˆ« + â€œğŸ”’é”å®šå§“å/æ€§åˆ«â€å¼€å…³

å³ä¾§ è¯†åˆ«JSON é¢„è§ˆï¼ˆå¯å¤åˆ¶ï¼‰

åº•éƒ¨æŒ‰é’®ï¼š[è¯†åˆ«å¹¶é¢„è§ˆ] [ä¿å­˜ä¸ºæˆ‘çš„çœŸå‘½ç›˜]

æ ·å¼

admin_dashboard/static/css/verify.cssï¼ˆå»¶ç»­æ·±è‰²ä¼˜é›…é£ï¼‰

è„šæœ¬

admin_dashboard/static/js/verify_wizard.js

Stateï¼šwizard, notes, manual={name, gender, name_locked}, rawText={bazi, ziwei}

composePayload() åˆå¹¶æ‰€æœ‰è¾“å…¥ï¼Œfetch('/api/verify/preview') â†’ æ¸²æŸ“ JSON é¢„è§ˆä¸è¯„åˆ†

â€œå¤åˆ¶åˆ°å‰ªè´´æ¿â€æŒ‰é’®

â€œä¿å­˜ä¸ºæˆ‘çš„çœŸå‘½ç›˜â€â†’ fetch('/api/verify/submit')ï¼ŒæˆåŠŸåå¼¹å‡ºæ¸©æŸ”æç¤º

æ–‡æ¡ˆï¼ˆæ¸©æŸ”å…³æ€€å‹ï¼‰ï¼š

ç¬¬ä¸€æ­¥ï¼šâ€œè°¢è°¢ä½ ä¿¡ä»»æˆ‘ï¼Œæˆ‘ä»¬å…ˆä»å®¶åº­å¼€å§‹ï¼Œå¥½å—ï¼Ÿâ€

ä¸‹ä¸€æ­¥ï¼šâ€œå¾ˆå¥½ï¼Œæˆ‘ä»¬ç»§ç»­â€¦â€¦â€ã€ä¿å­˜ï¼šâ€œæˆ‘å·²ä¸ºä½ ä¿ç®¡è¿™ä»½è®°å½•ã€‚â€

è·¯ç”±æŒ‚è½½
åœ¨ admin_dashboard/app.pyï¼ˆæˆ–ä¸»å…¥å£ï¼‰æ³¨å†Œ blueprintï¼š

from verify.routes import verify_bp
app.register_blueprint(verify_bp)

å››ã€æ‰‹åŠ¨å­—æ®µé”å®šï¼ˆå…³é”®ï¼‰

å‰ç«¯æäº¤ä¸­åŠ å…¥ï¼š

"manual": {"name":"å¼ ä¸‰","gender":"å¥³","name_locked": true}


åç«¯ merge_manual_fieldsï¼š

def merge_manual_fields(parsed, manual):
    parsed = dict(parsed or {})
    if manual.get("name_locked"):
        if manual.get("name"):   parsed["name"] = manual["name"]
        if manual.get("gender"): parsed["gender"] = manual["gender"]
    else:
        parsed["name"]   = parsed.get("name")   or manual.get("name")   or ""
        parsed["gender"] = parsed.get("gender") or manual.get("gender") or ""
    return parsed

äº”ã€å¯¼èˆªä¸æƒé™

åœ¨å·²æœ‰çš„ç”¨æˆ·ä¸ªäººä¸»é¡µä¾§è¾¹æ ï¼Œæ–°å¢å…¥å£ï¼š

â€œæˆ‘çš„å‘½ç›˜â€ â†’ /verify

éœ€è¦ user_idï¼ˆä» session æˆ– queryï¼‰ï¼Œæ²¡æœ‰åˆ™å¼•å¯¼ç™»å½•ã€‚

å…­ã€éªŒæ”¶æ ‡å‡†ï¼ˆå¿…é¡»å…¨éƒ¨é€šè¿‡ï¼‰

æ‰“å¼€ /verify èƒ½çœ‹åˆ° Wizard+æ‰‹å†™+å¯¼å…¥çš„ä¸‰ç»„åˆç•Œé¢ï¼Œæ–‡æ¡ˆæ¸©æŸ”ã€‚

åœ¨â€œæ‰‹åŠ¨å§“å= u_test99ã€æ€§åˆ«=å¥³ï¼ŒğŸ”’é”å®šå¼€å¯â€ï¼Œç²˜è´´ä¸€æ®µç´«å¾®æ–‡æœ¬ â†’ ç‚¹å‡»â€œè¯†åˆ«å¹¶é¢„è§ˆâ€

é¢„è§ˆ JSON ä¸­ parsed.name === "u_test99"ï¼Œä¸ä¼šè¢«è¦†ç›–ã€‚

æäº¤åï¼š

verified_charts æ–°å¢ä¸€æ¡ï¼Œå« wizard/notes/parsed/candidates/score

è‹¥åŒ¹é…å€™é€‰åŒ…å«å·²æœ‰ birthchartsï¼Œåˆ™ chosen_id å¯ä¿å­˜ï¼ˆåœ¨ç¡®è®¤æ¥å£ï¼‰

birthcharts è‡³å°‘æœ‰ 1 æ¡ source_type ä¸ birth_data æ›´æ–°ã€‚

â€œå¤åˆ¶JSONâ€æŒ‰é’®å¯å¤åˆ¶è¯†åˆ«ç»“æœã€‚

OCR æŒ‰é’®æç¤ºâ€œæš‚ä¸å¯ç”¨ï¼Œè¯·ä¼˜å…ˆç²˜è´´æ–‡æœ¬/ä¸Šä¼ TXTâ€ã€‚

ä»»ä¸€æ¥å£å¤±è´¥ä¼šè¿”å› {"ok":false,"toast":"æ¸©æŸ”é”™è¯¯æç¤º"} å¹¶åœ¨å‰ç«¯å±•ç¤ºã€‚

ä¸ƒã€å¼€å‘åæœ¬åœ°è‡ªæµ‹å‘½ä»¤
# è¿è¡Œ
python admin_dashboard/app.py

# å¿«é€Ÿæ£€æŸ¥æœ€è¿‘å…¥åº“
python - <<'PY'
from supabase import create_client; import os, json
db=create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))
r=db.table("verified_charts").select("id,user_id,score,created_at").order("id",desc=True).limit(3).execute()
print(json.dumps(r.data,ensure_ascii=False,indent=2))
PY

å…«ã€æ–‡ä»¶æ¸…å•ï¼ˆè¯·åˆ›å»º/æ›´æ–°ï¼‰

admin_dashboard/verify/__init__.py

admin_dashboard/verify/routes.py

admin_dashboard/templates/verify.html

admin_dashboard/static/css/verify.css

admin_dashboard/static/js/verify_wizard.js

æ›´æ–° admin_dashboard/app.py æŒ‚è½½ blueprint

å¦‚æ—  verified_charts è¡¨åˆ™åˆ›å»º

æ³¨æ„ï¼šä¸¥æ ¼ä¿è¯â€œæ‰‹åŠ¨å§“å/æ€§åˆ«é”å®šä¼˜å…ˆâ€çš„é€»è¾‘è´¯é€šå‰åç«¯ï¼›ä¸è¦åœ¨ä»»ä½•è§£ææ­¥éª¤ç”¨ä¸»æ˜Ÿç­‰å­—æ®µè¦†ç›–å§“åã€‚

å®Œæˆåè¯·å›æ˜¾ï¼š

æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

æ•°æ®åº“è¿ç§»ç»“æœï¼ˆè¡¨/åˆ—æ˜¯å¦å­˜åœ¨ï¼‰

è®¿é—®è·¯å¾„ /verify

ä¸€æ¬¡ç«¯åˆ°ç«¯æ¼”ç¤ºï¼šç²˜è´´å‘½ç›˜ â†’ è¯†åˆ«é¢„è§ˆ â†’ ä¿å­˜ â†’ Supabase è®°å½•æˆªå›¾/JSON è¾“å‡º