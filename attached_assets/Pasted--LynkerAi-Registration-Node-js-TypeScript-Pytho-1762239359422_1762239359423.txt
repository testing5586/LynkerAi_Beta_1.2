æˆ‘ç°åœ¨ä¸ºæ‚¨æ•´ç†å®Œæ•´çš„è¿ç§»æ–‡æ¡£ï¼åŸºäºæˆ‘å¯¹ä»£ç çš„åˆ†æï¼Œè¿™é‡Œæ˜¯æ‰€æœ‰æ‚¨éœ€è¦çš„ä¿¡æ¯ï¼š

ğŸ“¦ LynkerAi Registration é¡¹ç›®è¿ç§»æ–‡æ¡£
Node.js/TypeScript â†’ Python/Flask + Supabase
====== 1. SQL Schema (Supabase æ•°æ®åº“ç»“æ„) ======
-- ============================================================================
-- SESSIONS TABLE (Flask-Session ä¼šè¯å­˜å‚¨)
-- ============================================================================
CREATE TABLE sessions (
    sid VARCHAR PRIMARY KEY,
    sess JSONB NOT NULL,
    expire TIMESTAMP NOT NULL
);
CREATE INDEX IDX_session_expire ON sessions(expire);
-- ============================================================================
-- USERS TABLE (åŸºç¡€ç”¨æˆ·è¡¨ - Replit Auth â†’ Flask Auth)
-- ============================================================================
CREATE TABLE users (
    id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR UNIQUE,
    first_name VARCHAR,
    last_name VARCHAR,
    profile_image_url VARCHAR,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
-- ============================================================================
-- NORMAL USER PROFILES (æ™®é€šç”¨æˆ·æ¡£æ¡ˆ - 98%)
-- ============================================================================
CREATE TABLE normal_user_profiles (
    id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    
    -- å¿…å¡«å­—æ®µ
    pseudonym VARCHAR(100) NOT NULL,  -- å››å­—çœŸå (çµæ€§å‡å)
    
    -- å¯é€‰å­—æ®µ
    avatar_url VARCHAR,
    gender VARCHAR,  -- 'male' | 'female' | 'other'
    birth_date TIMESTAMP,  -- ISO å­—ç¬¦ä¸²æ ¼å¼
    birth_time VARCHAR,
    birth_location VARCHAR,
    
    -- AI é…ç½®
    preferred_provider VARCHAR DEFAULT 'LocalMock',  -- 'LocalMock' | 'OpenAI' | 'Gemini'
    
    -- Google Drive é›†æˆ (å¯é€‰)
    drive_folder_id VARCHAR,
    drive_refresh_token VARCHAR,
    google_user_id VARCHAR,
    
    preferred_language VARCHAR DEFAULT 'en',  -- 'en' | 'zh' | 'ja' | 'ko' | 'th' | 'vi'
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
-- ============================================================================
-- GURU PROFILES (å‘½ç†å¸ˆæ¡£æ¡ˆ - 2%)
-- ============================================================================
CREATE TABLE guru_profiles (
    id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- åŸºæœ¬ä¿¡æ¯
    pseudonym VARCHAR(100),
    bio TEXT,
    avatar_url VARCHAR,
    
    -- ä¸“ä¸šä¿¡æ¯
    specializations TEXT[],  -- PostgreSQLæ•°ç»„: ['Bazi', 'Zi Wei Dou Shu', 'I Ching', 'Tarot']
    region VARCHAR,
    nationality VARCHAR,
    
    -- AI é…ç½®
    ai_provider VARCHAR DEFAULT 'LocalMock',  -- 'LocalMock' | 'OpenAI' | 'Gemini'
    ai_tone VARCHAR DEFAULT 'professional',  -- 'professional' | 'casual' | 'mystical'
    
    -- è´¦æˆ·ä¿¡æ¯
    token_balance INTEGER DEFAULT 0,
    subscription_tier VARCHAR DEFAULT 'free',  -- 'free' | 'pro'
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
-- ============================================================================
-- DESTINY CHARTS (å‘½ç›˜æ•°æ® - 2.0 éšè—åŠŸèƒ½ï¼Œé™é»˜æ”¶é›†)
-- ============================================================================
CREATE TABLE destiny_charts (
    id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR REFERENCES users(id) ON DELETE CASCADE,
    guru_id VARCHAR REFERENCES guru_profiles(id),
    
    birth_date TIMESTAMP,
    birth_time VARCHAR,
    birth_location VARCHAR,
    latitude DECIMAL(10, 7),
    longitude DECIMAL(10, 7),
    
    chart_type VARCHAR,  -- 'Bazi' | 'Zi Wei' | 'I Ching' | 'Tarot'
    chart_data JSONB,  -- å‘½ç›˜è®¡ç®—ç»“æœ
    frequency_vector JSONB,  -- é¢‘ç‡å‘é‡ (ç”¨äºåŒ¹é…ç®—æ³•)
    environment_context JSONB,  -- ç¯å¢ƒä¸Šä¸‹æ–‡ (æ°”å€™ã€æ¹¿åº¦ã€æ¸©åº¦)
    
    created_at TIMESTAMP DEFAULT NOW()
);
-- ============================================================================
-- MATCHING MATRIX (åŒå‘½åŒ¹é…çŸ©é˜µ - 2.0 éšè—åŠŸèƒ½)
-- ============================================================================
CREATE TABLE matching_matrix (
    id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
    user1_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    user2_id VARCHAR NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    resonance_score INTEGER,  -- 0-100
    chart_similarity DECIMAL(5, 2),  -- ç™¾åˆ†æ¯”
    shared_fate_events JSONB,  -- å…±åŒå‘½è¿äº‹ä»¶æ•°ç»„
    
    computed_at TIMESTAMP DEFAULT NOW()
);
-- ============================================================================
-- å…¶ä»– 2.0 éšè—è¡¨ (å¯é€‰ï¼Œæš‚æ—¶ä¸ç”¨åˆ›å»º)
-- ============================================================================
-- resonance_events, social_feed, forum_posts, forum_votes, ai_learning_log,
-- subscription_tiers, guru_usage_log, transactions, lynker_tokens, knowledge_packs, token_exchange_log

====== 2. ä¸šåŠ¡é€»è¾‘è¯¦è§£ ======
2.1 ç”¨æˆ·æ³¨å†Œæµç¨‹
æ™®é€šç”¨æˆ·æ³¨å†Œ (Normal User Registration)
æ­¥éª¤:

ç”¨æˆ·å¡«å†™æ³¨å†Œè¡¨å•
å‰ç«¯éªŒè¯ â†’ åç«¯éªŒè¯ â†’ æ•°æ®åº“æ’å…¥
é‡å®šå‘åˆ° /home
å¿…å¡«å­—æ®µ:

pseudonym (çµæ€§å‡å) - è‡³å°‘2ä¸ªå­—ç¬¦ï¼Œä¸èƒ½æ˜¯çœŸå
å¯é€‰å­—æ®µ:

gender - 'male' | 'female' | 'other'
birthDate - ISO æ—¥æœŸå­—ç¬¦ä¸²æ ¼å¼ (ä¾‹: "1990-01-15")
preferredProvider - 'LocalMock' (é»˜è®¤) | 'Gemini' | 'OpenAI'
éªŒè¯è§„åˆ™:

# Python (Flask) éªŒè¯é€»è¾‘
def validate_pseudonym(name):
    if len(name) < 2:
        return "Pseudonym must be at least 2 characters"
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºçœŸåæ¨¡å¼
    real_name_patterns = [
        r'^[A-Z][a-z]+ [A-Z][a-z]+$',  # John Smith
        r'^(Mr|Mrs|Ms|Dr)\.',           # å¤´è¡”
        r'\b(firstname|lastname|name)\b'
    ]
    
    for pattern in real_name_patterns:
        if re.match(pattern, name, re.IGNORECASE):
            return "Please use a spiritual pseudonym, not your real name"
    
    return None  # éªŒè¯é€šè¿‡

æ•°æ®æ ¼å¼:

{
  "pseudonym": "æ˜Ÿè‹¥æ— å£°",
  "gender": "male",
  "birthDate": "1990-01-15",
  "preferredProvider": "LocalMock",
  "avatarUrl": "/api/placeholder/avatar/3"
}

å‘½ç†å¸ˆæ³¨å†Œ (Guru Registration)
å¤šæ­¥éª¤è¡¨å•:

Step 1: æ¡£æ¡ˆ (Profile)

pseudonym * (å¿…å¡«)
bio (è‡ªæˆ‘ä»‹ç»ï¼Œæœ€å¤š500å­—)
region (åœ°åŒºï¼Œä¾‹: Southeast Asia)
nationality (å›½ç±ï¼Œä¾‹: Malaysia)
Step 2: ä¸“é•¿ (Specialization)

specializations * (å¿…å¡«ï¼Œå¤šé€‰)
Options: ['bazi', 'ziwei', 'iching', 'tarot', 'numerology', 'feng-shui']
å¯¹åº”ä¸­æ–‡: ['å…«å­—', 'ç´«å¾®æ–—æ•°', 'æ˜“ç»', 'å¡”ç½—', 'æ•°å­—å­¦', 'é£æ°´']
Step 3: AI è®¾ç½® (AI Setup)

aiProvider (å•é€‰)
'LocalMock' (å…è´¹ï¼Œæ— éœ€APIå¯†é’¥)
'OpenAI' (éœ€è¦APIå¯†é’¥)
'Gemini' (æœ‰å…è´¹é¢åº¦)
aiTone (è¯­æ°”é£æ ¼)
'professional' (ä¸“ä¸šæƒå¨)
'casual' (å‹å¥½éšæ€§)
'mystical' (ç¥ç§˜è¯—æ„)
æäº¤çš„æ•°æ®æ ¼å¼:

{
  "pseudonym": "çµçŸ¥è‹¥é£",
  "bio": "25å¹´å‘½ç†ç ”ç©¶ç»éªŒï¼Œä¸“æ³¨äºå…«å­—ä¸ç´«å¾®æ–—æ•°...",
  "region": "Southeast Asia",
  "nationality": "Malaysia",
  "specializations": ["bazi", "ziwei", "iching"],
  "aiProvider": "OpenAI",
  "aiTone": "mystical"
}

2.2 è®¤è¯æµç¨‹
å½“å‰ç³»ç»Ÿ (Replit Auth - OpenID Connect)

å·¥ä½œåŸç†:

ç”¨æˆ·ç‚¹å‡» "Sign in with Replit"
é‡å®šå‘åˆ° /api/auth/replit
OAuth æµç¨‹ â†’ å›è°ƒåˆ° /api/auth/replit/callback
åˆ›å»º sessionï¼Œå­˜å‚¨ userId å’Œ claims
é‡å®šå‘åˆ°é¦–é¡µ
Session å­˜å‚¨:

// Node.js session æ•°æ®
req.session = {
  passport: {
    user: {
      claims: {
        sub: "user-uuid-123",  // userId
        email: "user@example.com",
        name: "User Name"
      }
    }
  }
}

Flask æ›¿ä»£æ–¹æ¡ˆå»ºè®®:

ç”±äº Replit Auth ä»…é™äº Replit å¹³å°ï¼Œåœ¨ Flask ä¸­éœ€è¦æ›¿æ¢è®¤è¯æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ 1: Flask-Login + ä¼ ç»Ÿé‚®ç®±å¯†ç 

# pip install flask-login
from flask_login import LoginManager, UserMixin, login_user, logout_user, login_required
login_manager = LoginManager()
login_manager.init_app(app)
@login_manager.user_loader
def load_user(user_id):
    return User.query.get(user_id)
@app.route('/login', methods=['POST'])
def login():
    email = request.json['email']
    password = request.json['password']
    
    user = User.query.filter_by(email=email).first()
    if user and check_password_hash(user.password_hash, password):
        login_user(user)
        return jsonify({'success': True})
    
    return jsonify({'error': 'Invalid credentials'}), 401

æ–¹æ¡ˆ 2: Flask + JWT (æ›´ç°ä»£åŒ–)

# pip install flask-jwt-extended
from flask_jwt_extended import JWTManager, create_access_token, jwt_required, get_jwt_identity
jwt = JWTManager(app)
@app.route('/api/login', methods=['POST'])
def login():
    email = request.json['email']
    password = request.json['password']
    
    user = User.query.filter_by(email=email).first()
    if user and verify_password(password, user.password_hash):
        access_token = create_access_token(identity=user.id)
        return jsonify(access_token=access_token)
    
    return jsonify({'error': 'Invalid credentials'}), 401
@app.route('/api/users/me', methods=['GET'])
@jwt_required()
def get_current_user():
    user_id = get_jwt_identity()
    user = User.query.get(user_id)
    return jsonify(user.to_dict())

åˆ¤æ–­ç”¨æˆ·ç±»å‹:

def get_user_type(user_id):
    # æ£€æŸ¥æ˜¯å¦æœ‰ guru_profile
    guru = db.session.query(GuruProfile).filter_by(user_id=user_id).first()
    if guru:
        return 'guru'
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ normal_user_profile
    normal = db.session.query(NormalUserProfile).filter_by(user_id=user_id).first()
    if normal:
        return 'normal_user'
    
    return 'new_user'  # æœªæ³¨å†Œ

2.3 API ç«¯ç‚¹é€»è¾‘
POST /api/users/me/profile (åˆ›å»ºæ™®é€šç”¨æˆ·æ¡£æ¡ˆ)
æ¥æ”¶æ•°æ®:

{
  "pseudonym": "æ˜Ÿè‹¥æ— å£°",
  "gender": "male",        # å¯é€‰
  "birthDate": "1990-01-15",  # å¯é€‰ï¼ŒISOæ ¼å¼
  "preferredProvider": "LocalMock"
}

éªŒè¯é€»è¾‘:

from marshmallow import Schema, fields, validate, ValidationError
class NormalUserProfileSchema(Schema):
    pseudonym = fields.Str(required=True, validate=validate.Length(min=2, max=100))
    gender = fields.Str(validate=validate.OneOf(['male', 'female', 'other']))
    birthDate = fields.DateTime(allow_none=True)
    preferredProvider = fields.Str(validate=validate.OneOf(['LocalMock', 'OpenAI', 'Gemini']))
    avatarUrl = fields.Str()
@app.route('/api/users/me/profile', methods=['POST'])
@login_required  # æˆ– @jwt_required()
def create_normal_profile():
    user_id = current_user.id  # Flask-Login
    # æˆ–: user_id = get_jwt_identity()  # JWT
    
    # éªŒè¯æ•°æ®
    schema = NormalUserProfileSchema()
    try:
        data = schema.load(request.json)
    except ValidationError as err:
        return jsonify(err.messages), 400
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¡£æ¡ˆ
    existing = NormalUserProfile.query.filter_by(user_id=user_id).first()
    if existing:
        return jsonify({'error': 'Profile already exists'}), 409
    
    # åˆ›å»ºæ¡£æ¡ˆ
    profile = NormalUserProfile(
        user_id=user_id,
        pseudonym=data['pseudonym'],
        gender=data.get('gender'),
        birth_date=data.get('birthDate'),
        preferred_provider=data.get('preferredProvider', 'LocalMock'),
        avatar_url=data.get('avatarUrl')
    )
    
    db.session.add(profile)
    db.session.commit()
    
    # é™é»˜æ•°æ®æ”¶é›†æ—¥å¿— (å¯é€‰)
    app.logger.info(f'[DATA COLLECTION] New user registered: {profile.id}')
    
    return jsonify(profile.to_dict()), 201

POST /api/gurus (åˆ›å»ºå‘½ç†å¸ˆæ¡£æ¡ˆ)
æ¥æ”¶æ•°æ®:

{
  "pseudonym": "çµçŸ¥è‹¥é£",
  "bio": "25å¹´å‘½ç†ç ”ç©¶ç»éªŒ...",
  "region": "Southeast Asia",
  "nationality": "Malaysia",
  "specializations": ["bazi", "ziwei", "iching"],
  "aiProvider": "OpenAI",
  "aiTone": "mystical"
}

éªŒè¯ + æ•°æ®åº“æ“ä½œ:

class GuruProfileSchema(Schema):
    pseudonym = fields.Str(validate=validate.Length(max=100))
    bio = fields.Str()
    specializations = fields.List(fields.Str(), required=True)
    region = fields.Str()
    nationality = fields.Str()
    aiProvider = fields.Str(validate=validate.OneOf(['LocalMock', 'OpenAI', 'Gemini']))
    aiTone = fields.Str(validate=validate.OneOf(['professional', 'casual', 'mystical']))
@app.route('/api/gurus', methods=['POST'])
@login_required
def create_guru_profile():
    user_id = current_user.id
    
    schema = GuruProfileSchema()
    try:
        data = schema.load(request.json)
    except ValidationError as err:
        return jsonify(err.messages), 400
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¡£æ¡ˆ
    existing = GuruProfile.query.filter_by(user_id=user_id).first()
    if existing:
        return jsonify({'error': 'Guru profile already exists'}), 409
    
    # åˆ›å»ºæ¡£æ¡ˆ
    profile = GuruProfile(
        user_id=user_id,
        pseudonym=data.get('pseudonym'),
        bio=data.get('bio'),
        specializations=data['specializations'],  # PostgreSQL ARRAY
        region=data.get('region'),
        nationality=data.get('nationality'),
        ai_provider=data.get('aiProvider', 'LocalMock'),
        ai_tone=data.get('aiTone', 'professional')
    )
    
    db.session.add(profile)
    db.session.commit()
    
    return jsonify(profile.to_dict()), 201

GET /api/users/me (è·å–å½“å‰ç”¨æˆ·)
@app.route('/api/users/me', methods=['GET'])
@login_required
def get_current_user():
    user_id = current_user.id
    
    user = User.query.get(user_id)
    if not user:
        return jsonify({'error': 'User not found'}), 404
    
    return jsonify({
        'id': user.id,
        'email': user.email,
        'firstName': user.first_name,
        'lastName': user.last_name,
        'profileImageUrl': user.profile_image_url,
        'createdAt': user.created_at.isoformat()
    })

====== 3. å‰ç«¯é€»è¾‘ (React â†’ ä¿æŒä¸å˜æˆ–é‡å†™) ======
3.1 ç”¨æˆ·æ³¨å†Œè¡¨å• (UserRegistration.tsx)
å…³é”®å­—æ®µ:

const formData = {
  pseudonym: '',        // å¿…å¡«
  gender: '',           // å¯é€‰: 'male' | 'female' | 'other'
  birthDate: '',        // å¯é€‰: ISO æ—¥æœŸå­—ç¬¦ä¸²
  preferredProvider: 'LocalMock'  // 'LocalMock' | 'Gemini' | 'OpenAI'
}

ä¼ªä»£ç é€»è¾‘:

// 1. éªŒè¯å‡å
function validatePseudonym(name) {
  if (name.length < 2) return false;
  if (/^[A-Z][a-z]+ [A-Z][a-z]+$/.test(name)) return false; // æ‹’ç»çœŸå
  return true;
}
// 2. æäº¤è¡¨å•
async function handleSubmit(e) {
  e.preventDefault();
  
  const response = await fetch('/api/users/me/profile', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      pseudonym: formData.pseudonym,
      gender: formData.gender || undefined,
      birthDate: formData.birthDate || undefined,
      preferredProvider: formData.preferredProvider
    })
  });
  
  if (response.ok) {
    window.location.href = '/home';
  }
}

3.2 å‘½ç†å¸ˆæ³¨å†Œè¡¨å• (GuruRegistration.tsx)
æ­¥éª¤ç®¡ç†:

const steps = ['profile', 'specialization', 'ai'];
const [currentStep, setCurrentStep] = useState(0);
const formData = {
  pseudonym: '',
  bio: '',
  specializations: [],  // å¤šé€‰æ•°ç»„
  region: '',
  nationality: '',
  aiProvider: 'LocalMock',
  aiTone: 'professional'
}

Step 1: Profile å­—æ®µ

pseudonym (å¿…å¡«)
bio (textarea, 500å­—é™åˆ¶)
region
nationality
Step 2: Specialization (å¤šé€‰)

const specializationOptions = [
  { value: 'bazi', label: 'Bazi (å…«å­—)' },
  { value: 'ziwei', label: 'Zi Wei Dou Shu (ç´«å¾®æ–—æ•°)' },
  { value: 'iching', label: 'I Ching (æ˜“ç»)' },
  { value: 'tarot', label: 'Tarot' },
  { value: 'numerology', label: 'Numerology' },
  { value: 'feng-shui', label: 'Feng Shui (é£æ°´)' }
];
function toggleSpecialization(spec) {
  setFormData(prev => ({
    ...prev,
    specializations: prev.specializations.includes(spec)
      ? prev.specializations.filter(s => s !== spec)
      : [...prev.specializations, spec]
  }));
}

Step 3: AI Setup

const aiProviders = [
  { value: 'LocalMock', label: 'LocalMock (Free)', description: 'å³æ—¶å“åº”ï¼Œæ— æˆæœ¬' },
  { value: 'OpenAI', label: 'OpenAI', description: 'GPT-5 æ™ºèƒ½' },
  { value: 'Gemini', label: 'Google Gemini', description: 'å¤šæ¨¡æ€AI' }
];
const aiTones = [
  { value: 'professional', label: 'Professional', description: 'æ­£å¼æƒå¨' },
  { value: 'casual', label: 'Casual', description: 'å‹å¥½éšæ€§' },
  { value: 'mystical', label: 'Mystical', description: 'ç¥ç§˜è¯—æ„' }
];

3.3 å¤šè¯­è¨€ç³»ç»Ÿ
æ”¯æŒçš„è¯­è¨€:

en - English
zh - ä¸­æ–‡
ja - æ—¥è¯­
ko - éŸ©è¯­
th - æ³°è¯­
vi - è¶Šå—è¯­
å…³é”®ç¿»è¯‘ (ç¤ºä¾‹):

é”®å	è‹±è¯­	ä¸­æ–‡	æ—¥è¯­
user.welcome.title	Welcome to LynkerAi	æ¬¢è¿æ¥åˆ° LynkerAi	LynkerAiã¸ã‚ˆã†ã“ã
user.pseudonym.label	Spiritual Pseudonym	çµæ€§å‡å	ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ä»®å
user.submit	Begin Your Journey	å¼€å§‹æ‚¨çš„æ—…ç¨‹	æ—…ã‚’å§‹ã‚ã‚‹
user.guru.button	Register as a Guru instead	æ”¹ä¸ºæ³¨å†Œæˆä¸ºå¯¼å¸ˆ	ä»£ã‚ã‚Šã«ã‚°ãƒ«ã¨ã—ã¦ç™»å½•
å®ç°æ–¹å¼ (React Context):

// LanguageContext.tsx
const translations = {
  en: { 'user.welcome.title': 'Welcome to LynkerAi', ... },
  zh: { 'user.welcome.title': 'æ¬¢è¿æ¥åˆ° LynkerAi', ... }
};
export function useLanguage() {
  const [language, setLanguage] = useState('en');
  
  const t = (key) => translations[language][key] || key;
  
  return { language, setLanguage, t };
}

Flask åç«¯ç¿»è¯‘ (å¯é€‰):

# pip install flask-babel
from flask_babel import Babel, gettext
babel = Babel(app)
@babel.localeselector
def get_locale():
    return request.accept_languages.best_match(['en', 'zh', 'ja', 'ko', 'th', 'vi'])
# ä½¿ç”¨
message = gettext('user.welcome.title')

====== 4. é…ç½®æ˜ å°„ (Node.js â†’ Flask) ======
ç¯å¢ƒå˜é‡å¯¹ç…§è¡¨
Node.js (å½“å‰)	Flask (è¿ç§»å)	è¯´æ˜
DATABASE_URL	DATABASE_URL	Supabase PostgreSQL è¿æ¥å­—ç¬¦ä¸²
SESSION_SECRET	SECRET_KEY	Flask session åŠ å¯†å¯†é’¥
REPL_ID	ä¸éœ€è¦	Replit å¹³å°ä¸“ç”¨ï¼ŒFlask ä¸éœ€è¦
ISSUER_URL	ä¸éœ€è¦	Replit Auth ä¸“ç”¨ï¼ŒFlask ä¸éœ€è¦
GITHUB_PERSONAL_ACCESS_TOKEN	ä¿æŒ	Git æ¨é€æƒé™ (å¯é€‰)
OPENAI_API_KEY	OPENAI_API_KEY	OpenAI APIå¯†é’¥ (å¯é€‰)
Flask é…ç½®ç¤ºä¾‹
# config.py
import os
class Config:
    # æ•°æ®åº“
    SQLALCHEMY_DATABASE_URI = os.getenv('DATABASE_URL')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # Session åŠ å¯†
    SECRET_KEY = os.getenv('SECRET_KEY', 'your-secret-key-here')
    
    # JWT (å¦‚æœä½¿ç”¨)
    JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'jwt-secret-key')
    JWT_ACCESS_TOKEN_EXPIRES = 3600  # 1å°æ—¶
    
    # AI Providers (å¯é€‰)
    OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')
    
    # åº”ç”¨é…ç½®
    DEBUG = os.getenv('FLASK_ENV') == 'development'

# app.py
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
app = Flask(__name__)
app.config.from_object('config.Config')
db = SQLAlchemy(app)
login_manager = LoginManager(app)

è®¤è¯æ–¹æ¡ˆæ›¿æ¢å»ºè®®
å½“å‰ç³»ç»Ÿ: Replit Auth (OpenID Connect)

æ¨èæ›¿ä»£æ–¹æ¡ˆ:

Option 1: ç®€å•é‚®ç®±å¯†ç ç™»å½• (æœ€å¿«å®ç°)

# ä½¿ç”¨ Flask-Login
pip install flask-login werkzeug
from werkzeug.security import generate_password_hash, check_password_hash
# ç”¨æˆ·æ³¨å†Œ
@app.route('/register', methods=['POST'])
def register():
    email = request.json['email']
    password = request.json['password']
    
    hashed_password = generate_password_hash(password)
    user = User(email=email, password_hash=hashed_password)
    db.session.add(user)
    db.session.commit()
    
    return jsonify({'success': True})
# ç”¨æˆ·ç™»å½•
@app.route('/login', methods=['POST'])
def login():
    email = request.json['email']
    password = request.json['password']
    
    user = User.query.filter_by(email=email).first()
    if user and check_password_hash(user.password_hash, password):
        login_user(user)
        return jsonify({'success': True})
    
    return jsonify({'error': 'Invalid credentials'}), 401

Option 2: Google OAuth (ä¿æŒ OAuth ä½“éªŒ)

# ä½¿ç”¨ Authlib
pip install authlib
from authlib.integrations.flask_client import OAuth
oauth = OAuth(app)
google = oauth.register(
    name='google',
    client_id=os.getenv('GOOGLE_CLIENT_ID'),
    client_secret=os.getenv('GOOGLE_CLIENT_SECRET'),
    server_metadata_url='https://accounts.google.com/.well-known/openid-configuration',
    client_kwargs={'scope': 'openid email profile'}
)
@app.route('/login/google')
def login_google():
    redirect_uri = url_for('auth_callback', _external=True)
    return google.authorize_redirect(redirect_uri)
@app.route('/auth/callback')
def auth_callback():
    token = google.authorize_access_token()
    user_info = google.parse_id_token(token)
    
    # åˆ›å»ºæˆ–è·å–ç”¨æˆ·
    user = User.query.filter_by(email=user_info['email']).first()
    if not user:
        user = User(email=user_info['email'], ...)
        db.session.add(user)
        db.session.commit()
    
    login_user(user)
    return redirect('/home')

====== 5. æ•°æ®å¯¼å‡º (å¦‚æœæœ‰çœŸå®ç”¨æˆ·) ======
ç”±äºæˆ‘æ— æ³•ç›´æ¥è®¿é—®ç”Ÿäº§æ•°æ®åº“ï¼Œæˆ‘æä¾›å¯¼å‡ºè„šæœ¬ä¾›æ‚¨è¿è¡Œï¼š

æ•°æ®å¯¼å‡ºè„šæœ¬
# è¿æ¥åˆ° Neon æ•°æ®åº“å¹¶å¯¼å‡ºæ•°æ®
psql $DATABASE_URL -c "COPY (SELECT * FROM users) TO STDOUT WITH CSV HEADER" > users.csv
psql $DATABASE_URL -c "COPY (SELECT * FROM normal_user_profiles) TO STDOUT WITH CSV HEADER" > normal_profiles.csv
psql $DATABASE_URL -c "COPY (SELECT * FROM guru_profiles) TO STDOUT WITH CSV HEADER" > guru_profiles.csv

SQL INSERT ç”Ÿæˆè„šæœ¬
# export_data.py - è¿è¡Œæ­¤è„šæœ¬ç”Ÿæˆ SQL INSERT è¯­å¥
import psycopg2
import os
DATABASE_URL = os.getenv('DATABASE_URL')
conn = psycopg2.connect(DATABASE_URL)
cur = conn.cursor()
# å¯¼å‡º users
cur.execute("SELECT * FROM users")
users = cur.fetchall()
columns = [desc[0] for desc in cur.description]
with open('users_insert.sql', 'w') as f:
    for row in users:
        values = ', '.join([f"'{v}'" if v is not None else 'NULL' for v in row])
        f.write(f"INSERT INTO users ({', '.join(columns)}) VALUES ({values});\n")
# å¯¼å‡º normal_user_profiles
cur.execute("SELECT * FROM normal_user_profiles")
profiles = cur.fetchall()
columns = [desc[0] for desc in cur.description]
with open('normal_profiles_insert.sql', 'w') as f:
    for row in profiles:
        values = ', '.join([f"'{v}'" if v is not None else 'NULL' for v in row])
        f.write(f"INSERT INTO normal_user_profiles ({', '.join(columns)}) VALUES ({values});\n")
# å¯¼å‡º guru_profiles
cur.execute("SELECT * FROM guru_profiles")
gurus = cur.fetchall()
columns = [desc[0] for desc in cur.description]
with open('guru_profiles_insert.sql', 'w') as f:
    for row in gurus:
        # å¤„ç† PostgreSQL æ•°ç»„å­—æ®µ (specializations)
        values = []
        for i, v in enumerate(row):
            if columns[i] == 'specializations' and v:
                # PostgreSQL æ•°ç»„æ ¼å¼: ARRAY['value1', 'value2']
                values.append(f"ARRAY{v}")
            elif v is not None:
                values.append(f"'{v}'")
            else:
                values.append('NULL')
        
        f.write(f"INSERT INTO guru_profiles ({', '.join(columns)}) VALUES ({', '.join(values)});\n")
conn.close()
print("âœ… SQL INSERT è¯­å¥å·²ç”Ÿæˆï¼")

====== 6. Flask é¡¹ç›®ç»“æ„å»ºè®® ======
lynkerai-flask/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py           # Flask app åˆå§‹åŒ–
â”‚   â”œâ”€â”€ models.py             # SQLAlchemy models
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py           # è®¤è¯è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ users.py          # æ™®é€šç”¨æˆ·è·¯ç”±
â”‚   â”‚   â””â”€â”€ gurus.py          # å‘½ç†å¸ˆè·¯ç”±
â”‚   â”œâ”€â”€ schemas.py            # Marshmallow schemas (éªŒè¯)
â”‚   â””â”€â”€ utils.py              # å·¥å…·å‡½æ•°
â”œâ”€â”€ migrations/               # Flask-Migrate (Alembic)
â”œâ”€â”€ config.py                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt          # Python ä¾èµ–
â””â”€â”€ run.py                    # å¯åŠ¨æ–‡ä»¶

ä¾èµ–åŒ…åˆ—è¡¨ (requirements.txt)
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Login==0.6.3
Flask-JWT-Extended==4.6.0
Flask-Migrate==4.0.5
marshmallow==3.20.1
psycopg2-binary==2.9.9
python-dotenv==1.0.0
Werkzeug==3.0.1

====== æ€»ç»“ä¸ä¸‹ä¸€æ­¥ ======
âœ… æ‚¨ç°åœ¨æ‹¥æœ‰çš„ä¿¡æ¯:
å®Œæ•´çš„æ•°æ®åº“ Schema (å¯ç›´æ¥åœ¨ Supabase ä¸­æ‰§è¡Œ)
æ‰€æœ‰ä¸šåŠ¡é€»è¾‘è¯´æ˜ (Python ä»£ç ç¤ºä¾‹)
å‰ç«¯è¡¨å•é€»è¾‘ (å¯å¤ç”¨æˆ–ç”¨ Jinja2 é‡å†™)
ç¯å¢ƒå˜é‡æ˜ å°„è¡¨
è®¤è¯æ–¹æ¡ˆå»ºè®® (Flask-Login / JWT / Google OAuth)
æ•°æ®å¯¼å‡ºè„šæœ¬
ğŸš€ å»ºè®®çš„è¿ç§»æ­¥éª¤:
åœ¨ Supabase åˆ›å»ºæ•°æ®åº“è¡¨ (å¤åˆ¶ä¸Šé¢çš„ SQL)
è®¾ç½® Flask é¡¹ç›® (ä½¿ç”¨ä¸Šé¢çš„ç»“æ„)
å®ç°è®¤è¯ç³»ç»Ÿ (é€‰æ‹© Flask-Login æˆ– JWT)
è¿ç§» API ç«¯ç‚¹ (å‚è€ƒä¸Šé¢çš„ Python ä»£ç )
è¿ç§»ç”¨æˆ·æ•°æ® (è¿è¡Œå¯¼å‡ºè„šæœ¬)
å‰ç«¯è¿æ¥æ–°åç«¯ (ä¿®æ”¹ API åœ°å€)
æµ‹è¯•å®Œæ•´æµç¨‹