åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼šmaster_ai_reasoner.py
è¦æ±‚ï¼š

ğŸ“ æ–‡ä»¶ä½ç½®ï¼š
~/workspace/master_ai_reasoner.py

ğŸ’¡ æ–‡ä»¶åŠŸèƒ½ï¼š
- ä» Supabase è¯»å– birthcharts / match_results / feedback çš„ç»Ÿè®¡
- åŸºäºå·²å‘ç°çš„è§„å¾‹åšâ€œå¯è§£é‡Šé¢„æµ‹â€ï¼ˆtraits + time windowï¼‰
- ä¸ºå•ä¸ªæˆ–å…¨éƒ¨ç”¨æˆ·ç”Ÿæˆé¢„æµ‹å¹¶è½åº“åˆ° predictions è¡¨
- é‡è¦æ´å¯ŸåŠ å¯†å­˜å…¥ Master Vault
- å†…ç½®è°ƒç”¨å®ˆå«ï¼ˆai_guard_middleware.check_permissionï¼‰

ğŸ§© ä»£ç å¦‚ä¸‹ï¼ˆè¯·å®Œæ•´ä¿å­˜ï¼‰ï¼š
-------------------------------------------------------------
import os
from datetime import datetime
from collections import Counter, defaultdict
from supabase import create_client, Client
from master_vault_engine import insert_vault
from ai_guard_middleware import check_permission

SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
client: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# -----------------------------
# åŸºç¡€æ•°æ®æŠ“å–
# -----------------------------
def fetch_birthcharts():
    resp = client.table("birthcharts").select("id,name,ziwei_palace,main_star,shen_palace,birth_time").execute()
    return resp.data or []

def fetch_match_results():
    # å¯é€‰ï¼šè‹¥ä¸å­˜åœ¨åˆ™è¿”å›ç©º
    try:
        resp = client.table("match_results").select("user_a_id,user_b_id,match_score,matching_fields").execute()
        return resp.data or []
    except Exception:
        return []

def fetch_feedback():
    # å¯é€‰ï¼šè‹¥ä¸å­˜åœ¨åˆ™è¿”å›ç©º
    try:
        resp = client.table("feedback").select("user_id,label,score,created_at").execute()
        return resp.data or []
    except Exception:
        return []

# -----------------------------
# è§„åˆ™å½’çº³ï¼ˆç¤ºä¾‹å¯å‘å¼ï¼‰
# -----------------------------
def derive_population_rules(charts):
    """
    ç®€å•ç»Ÿè®¡ï¼šä¸»æ˜Ÿ/å‘½å®«ç»„åˆçš„å‡ºç°é¢‘ç‡ä¸å…±ç°å…³ç³»
    è¾“å‡ºï¼šrules = { "å·³-å¤©åºœ": {"count": 12, "traits": ["ç¨³é‡","ååŠ²å¼º"], "confidence": 0.62 } }
    """
    pair_counts = Counter()
    star_counts = Counter()
    palace_counts = Counter()

    for r in charts:
        pair = f"{r['ziwei_palace']}-{r['main_star']}"
        pair_counts[pair] += 1
        star_counts[r["main_star"]] += 1
        palace_counts[r["ziwei_palace"]] += 1

    total = max(1, len(charts))
    rules = {}
    for pair, c in pair_counts.items():
        palace, star = pair.split("-")
        base_conf = c / total
        # ä¸€ä¸ªç®€å•çš„â€œç‰¹è´¨åº“â€ç¤ºèŒƒï¼ˆå¯åç»­æ›¿æ¢ä¸ºæ›´ç§‘å­¦çš„æ–­è¯­åº“ï¼‰
        trait_hint = []
        if star in ("å¤©åºœ","æ­¦æ›²","å»‰è´","ç ´å†›","ç´«å¾®","è´ªç‹¼"):
            trait_hint.append("æ€§æ ¼æ˜¾è‘—")
        if palace in ("å·³","åˆ","å¯"):
            trait_hint.append("è¡ŒåŠ¨åŠ›å¼º")
        if "å¤©åºœ" in star:
            trait_hint.append("ååŠ²å¼º")
        if "å»‰è´" in star:
            trait_hint.append("è§„åˆ™æ„Ÿ/åå›å¹¶å­˜")
        if "ç ´å†›" in star:
            trait_hint.append("ç ´æ—§ç«‹æ–°")

        rules[pair] = {
            "count": c,
            "confidence": round(base_conf, 4),
            "traits": list(set(trait_hint))
        }
    return rules

# -----------------------------
# åŸºäºè§„åˆ™å¯¹å•ç”¨æˆ·æ¨ç†
# -----------------------------
def predict_for_user(user, rules):
    """
    è¾“å…¥ï¼šå•ä¸ªç”¨æˆ·å‘½ç›˜ + ç¾¤ä½“è§„åˆ™
    è¾“å‡ºï¼šå¯è§£é‡Šé¢„æµ‹ dict
    """
    pair = f"{user['ziwei_palace']}-{user['main_star']}"
    rule = rules.get(pair, {"count": 0, "confidence": 0.1, "traits": []})

    # æ—¶é—´çª—ç¤ºä¾‹ï¼ˆå¯æ‰©å±•ä¸ºæµå¹´æ¨æ¼”ï¼‰
    time_window = "æœªæ¥ 6-12 ä¸ªæœˆ"
    # ç½®ä¿¡åº¦å¾®è°ƒï¼šèº«å®«ä¸€è‡´åŠ æˆ
    conf = rule["confidence"]
    if user.get("shen_palace") == user.get("ziwei_palace"):
        conf = min(0.95, conf + 0.08)

    explanation = {
        "user_id": user["id"],
        "user_name": user.get("name",""),
        "pair": pair,
        "traits": rule["traits"],
        "time_window": time_window,
        "confidence": round(conf, 3),
        "evidence": {
            "population_count": rule["count"],
            "population_ratio": rule["confidence"],
            "signals": ["ä¸»æ˜Ÿ/å‘½å®«ç»„åˆç»Ÿè®¡", "èº«å®«ä¸€è‡´åŠ æˆ"]
        }
    }
    return explanation

# -----------------------------
# ç»“æœå…¥åº“ï¼ˆpredictions è¡¨ï¼‰
# -----------------------------
def save_prediction(record):
    try:
        client.table("predictions").insert({
            "user_id": record["user_id"],
            "user_name": record.get("user_name",""),
            "pair": record["pair"],
            "traits": record["traits"],
            "time_window": record["time_window"],
            "confidence": record["confidence"],
            "evidence": record["evidence"],
            "created_at": datetime.utcnow().isoformat()
        }).execute()
    except Exception as e:
        print("âš ï¸ predictions è¡¨ä¸å­˜åœ¨æˆ– RLS é™åˆ¶ï¼›è¯·å…ˆåœ¨ Supabase æ‰§è¡Œï¼š")
        print(SQL_CREATE_PREDICTIONS)
        raise e

# -----------------------------
# é‡è¦æ´å¯Ÿ -> Vault åŠ å¯†å­˜æ¡£
# -----------------------------
def persist_insight_to_vault(explanations):
    # ä»…æŒ‘é€‰é«˜ç½®ä¿¡åº¦ä½œä¸ºæ´å¯Ÿï¼ˆç¤ºä¾‹ï¼š>=0.5ï¼‰
    high = [e for e in explanations if e["confidence"] >= 0.5]
    if not high:
        return
    lines = []
    for e in high:
        lines.append(
            f"ç»„åˆ:{e['pair']} ç½®ä¿¡:{e['confidence']} çª—å£:{e['time_window']} ç‰¹è´¨:{'ã€'.join(e['traits'])}"
        )
    content = "Master Reasoner - é«˜ç½®ä¿¡é¢„æµ‹å¿«ç…§\n" + "\n".join(lines) + f"\næ—¶é—´: {datetime.utcnow()}"
    insert_vault("Reasonerå¿«ç…§ - é«˜ç½®ä¿¡é¢„æµ‹", content, created_by="Master AI")

# -----------------------------
# å…¬å…± API
# -----------------------------
def reason_user(user_id: int):
    # è°ƒç”¨å®ˆå«
    gate = check_permission(user_id)
    if gate.get("status") != "ok":
        print(gate)
        return gate

    charts = fetch_birthcharts()
    if not charts:
        return {"status": "error", "msg": "æ²¡æœ‰å‘½ç›˜æ•°æ®"}

    rules = derive_population_rules(charts)
    u = next((x for x in charts if x["id"] == user_id), None)
    if not u:
        return {"status": "error", "msg": f"æœªæ‰¾åˆ°ç”¨æˆ· {user_id}"}

    explanation = predict_for_user(u, rules)
    save_prediction(explanation)
    persist_insight_to_vault([explanation])
    return {"status":"ok","prediction":explanation}

def reason_all(limit: int = 50):
    charts = fetch_birthcharts()
    if not charts:
        return {"status": "error", "msg": "æ²¡æœ‰å‘½ç›˜æ•°æ®"}
    rules = derive_population_rules(charts)

    results = []
    for u in charts[:limit]:
        # åªåœ¨å®ˆå«é€šè¿‡æ—¶å…¥åº“
        gate = check_permission(u["id"])
        if gate.get("status") != "ok":
            continue
        e = predict_for_user(u, rules)
        save_prediction(e)
        results.append(e)

    persist_insight_to_vault(results)
    return {"status":"ok","count":len(results)}

# -----------------------------
# è¾…åŠ©ï¼šå»ºè¡¨ SQL ï¼ˆå¦‚ç¼ºè¡¨æ—¶ä½¿ç”¨ï¼‰
# -----------------------------
SQL_CREATE_PREDICTIONS = """
create table if not exists predictions (
  id bigint generated by default as identity primary key,
  user_id bigint not null,
  user_name text,
  pair text,
  traits jsonb,
  time_window text,
  confidence numeric,
  evidence jsonb,
  created_at timestamptz default now()
);
"""

if __name__ == "__main__":
    # é»˜è®¤è·‘ä¸€æ¬¡å…¨é‡æ¨ç†ï¼ˆæœ€å¤š 50 äººï¼‰
    print("ğŸš€ Master AI Reasoner å¯åŠ¨")
    out = reason_all(limit=50)
    print(out)
    print("âœ… å®Œæˆ")
-------------------------------------------------------------

ğŸ’¾ ä¿å­˜åï¼Œè¯·è‡ªåŠ¨éªŒè¯ï¼š
1) è¯­æ³•æ­£ç¡®
2) å¯è¢«ä¸»ç¯å¢ƒæ‰§è¡Œ
3) æ‰“å° â€œâœ… Master AI Reasoner å·²åˆ›å»ºå¹¶é€šè¿‡éªŒè¯â€
