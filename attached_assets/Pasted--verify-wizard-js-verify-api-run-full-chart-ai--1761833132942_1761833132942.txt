âœ… ä¸€ã€å‰ç«¯ä¿®å¤ï¼ˆverify_wizard.jsï¼‰

åœ¨ä½ è°ƒç”¨ /verify/api/run_full_chart_ai ä¹‹å‰ï¼Œæ’å…¥ä»¥ä¸‹å‡½æ•°ä¸æ›¿æ¢é€»è¾‘ğŸ‘‡

// === åœ¨æ–‡ä»¶é¡¶éƒ¨æˆ–å‡½æ•°ä½“å‰åŠ å…¥ï¼šæ ¼å¼è½¬æ¢å‡½æ•° ===
function formatBaziForAPI(baziData) {
  if (!baziData) return "";
  if (typeof baziData === "string") return baziData; // å·²ç»æ˜¯æ–‡æœ¬æ ¼å¼

  const y = baziData.year_pillar || "";
  const m = baziData.month_pillar || "";
  const d = baziData.day_pillar || "";
  const h = baziData.hour_pillar || "";
  return `å¹´æŸ±:${y} æœˆæŸ±:${m} æ—¥æŸ±:${d} æ—¶æŸ±:${h}`;
}


ç„¶ååœ¨ä½ è°ƒç”¨æ¥å£æ—¶ï¼ˆå¤§æ¦‚åœ¨ startFullChartAnalysis() å‡½æ•°é‡Œï¼‰
æŠŠå‘é€ä½“æ›¿æ¢æˆï¼š

// å‡è®¾ baziData æ˜¯ä½ å·¦ä¾§ JSON åŒºçš„æ•°æ®å¯¹è±¡
// å‡è®¾ ziweiData æ˜¯å³ä¾§ JSON åŒºçš„æ•°æ®å¯¹è±¡
const baziFormatted = formatBaziForAPI(baziData);
const ziweiText = JSON.stringify(ziweiData, null, 2); // åŸæ ·å‘è¿‡å»ä¹Ÿè¡Œ

const payload = {
  user_id: currentUserId || 1,
  bazi_text: baziFormatted,
  ziwei_text: ziweiText,
  sop_template: selectedSOP || "standard_v1"
};

console.log("[Mode B] Sending payload:", payload);

const response = await fetch("/verify/api/run_full_chart_ai", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload)
});


ğŸ“Œ æ•ˆæœï¼š
å³ä¾¿ç”¨æˆ·ä¸Šä¼ çš„å…«å­—æ˜¯ JSONï¼Œä¹Ÿä¼šè‡ªåŠ¨å˜æˆï¼š

å¹´æŸ±:åºšè¾° æœˆæŸ±:å·±å¯ æ—¥æŸ±:ä¸ä¸‘ æ—¶æŸ±:ç”²è¾°


åç«¯æ—§é€»è¾‘å®Œå…¨èƒ½ç†è§£ã€‚

âœ… äºŒã€åç«¯ä¿®å¤ï¼ˆrun_full_chart_ai.pyï¼‰

åœ¨ /verify/api/run_full_chart_ai é‡Œæ‰¾åˆ°è¿™å‡ è¡Œï¼ˆå¤§æ¦‚åœ¨å‡½æ•°å¼€å¤´ï¼‰ï¼š

data = request.get_json()
bazi_text = data.get("bazi_text", "")


æ›¿æ¢æˆä»¥ä¸‹æ™ºèƒ½åˆ¤æ–­é€»è¾‘ğŸ‘‡

data = request.get_json() or {}
bazi_text = data.get("bazi_text", "")

# ğŸ§© å¦‚æœå‰ç«¯ä¼ æ¥çš„æ˜¯ JSONï¼ˆéå­—ç¬¦ä¸²ï¼‰
if isinstance(bazi_text, dict):
    y = bazi_text.get("year_pillar", "")
    m = bazi_text.get("month_pillar", "")
    d = bazi_text.get("day_pillar", "")
    h = bazi_text.get("hour_pillar", "")
    bazi_text = f"å¹´æŸ±:{y} æœˆæŸ±:{m} æ—¥æŸ±:{d} æ—¶æŸ±:{h}"

# ğŸ§© è‹¥ä¸ºç©ºä½†ä¸»å­—æ®µå­˜åœ¨
if not bazi_text and all(k in data for k in ["year_pillar", "month_pillar", "day_pillar", "hour_pillar"]):
    bazi_text = f"å¹´æŸ±:{data.get('year_pillar','')} æœˆæŸ±:{data.get('month_pillar','')} æ—¥æŸ±:{data.get('day_pillar','')} æ—¶æŸ±:{data.get('hour_pillar','')}"

# ğŸ§© æ ¡éªŒæ ¼å¼
if not re.search(r"å¹´æŸ±[:ï¼š].+æœˆæŸ±[:ï¼š].+æ—¥æŸ±[:ï¼š].+æ—¶æŸ±[:ï¼š]", bazi_text):
    return jsonify({
        "ok": False,
        "error": "å…«å­—æ–‡æœ¬è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚æ”¯æŒæ ¼å¼ï¼šå¹´æŸ±:ç”²å­ æœˆæŸ±:ä¸™å¯… æ—¥æŸ±:æˆŠåˆ æ—¶æŸ±:åºšç”³"
    }), 400

âœ… ä¸‰ã€å¯é€‰ï¼šæ—¥å¿—è¾“å‡ºï¼ˆè°ƒè¯•æ›´æ–¹ä¾¿ï¼‰

åœ¨åŒä¸€å‡½æ•°åŠ ä¸Šï¼š

print("[Mode B] Received å…«å­—æ–‡æœ¬:", bazi_text)


è¿™æ · Replit Console ä¼šæ‰“å°æ¯æ¬¡ä¼ å…¥çš„å››æŸ±ï¼Œæ–¹ä¾¿ä½ éªŒè¯ã€‚

âœ… å››ã€æœ€ç»ˆæ•ˆæœ
é˜¶æ®µ	åŸé—®é¢˜	ä¿®å¤ç»“æœ
å‰ç«¯	å‘é€ JSON å¯¼è‡´ 400	è‡ªåŠ¨è½¬æ ¼å¼æˆâ€œå¹´æŸ±:â€¦ æ—¶æŸ±:â€¦â€
åç«¯	æ— æ³•è¯†åˆ« JSON æ ¼å¼	è‡ªåŠ¨å®¹é”™ + æç¤º
æ•´ä½“	â€œå…¨ç›˜éªŒè¯å¤±è´¥â€	âœ… å¯è¯†åˆ«å¹¶è¿›å…¥åˆ†ææµç¨‹