echo "âš™ï¸ Installing bus & logs for Masterâ€“Childâ€“User collaboration..."

# 0) ä¾èµ–ï¼ˆä»…ç”¨åˆ° Flask å·²æœ‰ï¼›è¿™é‡Œä¿è¯ httpx åœ¨ï¼‰
pip install httpx > /dev/null 2>&1 || true

# 1) ä¸‰æ–¹æ¶ˆæ¯/å¯¹è¯æ—¥å¿—ï¼šconversation_bus.py
cat > conversation_bus.py <<'PY'
"""
Masterâ€“Childâ€“User ä¸‰æ–¹åä½œçš„æœ€å°å®žçŽ°ï¼š
- JSONL ä½œä¸ºäº‹ä»¶æ€»çº¿ï¼ˆç®€æ´å¯é ï¼‰
- /api/relay/send    -> Master æŒ‡æ´¾ä»»åŠ¡ç»™ Childï¼ˆæˆ–ç›´æŽ¥æ¶ˆæ¯ï¼‰
- /api/relay/callback-> Child æ‰§è¡Œå®Œæˆå›žä¼ ç»“æžœ
- /api/relay/logs    -> æ‹‰å–æœ€è¿‘ N æ¡å¯¹è¯/äº‹ä»¶
- /api/relay/ack     -> ï¼ˆå¯é€‰ï¼‰å¯¹æ¶ˆæ¯è¿›è¡Œç¡®è®¤
- å…¨éƒ¨å†™å…¥ conversation_log.jsonlï¼Œé¢å‘å®¡è®¡ä¸Žå›žæ”¾
"""
import os, json, time, threading
from typing import Dict, Any, List
from flask import Blueprint, request, jsonify

bp = Blueprint("relay", __name__)
LOG_FILE = "conversation_log.jsonl"
_lock = threading.Lock()

def _append_log(record: Dict[str, Any]):
    record.setdefault("ts", time.strftime("%Y-%m-%d %H:%M:%S"))
    with _lock:
        with open(LOG_FILE, "a", encoding="utf-8") as f:
            f.write(json.dumps(record, ensure_ascii=False) + "\n")

def _read_logs(limit: int = 100) -> List[Dict[str, Any]]:
    if not os.path.exists(LOG_FILE): return []
    with open(LOG_FILE, "r", encoding="utf-8") as f:
        lines = f.readlines()[-limit:]
    return [json.loads(x) for x in lines]

@bp.route("/api/relay/send", methods=["POST"])
def relay_send():
    """
    Master -> Child æˆ– User -> Master çš„é€šç”¨å‘é€æŽ¥å£
    body:
    {
      "from": "master" | "user",
      "to":   "child" | "master",
      "type": "task" | "message",
      "task_id": "t_xxx",        # type=task æ—¶å¯é€‰/è‡ªåŠ¨ç”Ÿæˆ
      "cmd": "generate_report",  # ä»»åŠ¡å‘½ä»¤ï¼ˆå¯é€‰ï¼‰
      "payload": {...},          # ä»»åŠ¡å‚æ•°
      "text": "è‡ªç„¶è¯­è¨€"          # è‡ªç”±æ–‡æœ¬
    }
    """
    data = request.get_json(force=True)
    if not data or not data.get("from") or not data.get("to"):
        return jsonify({"status":"error","msg":"missing from/to"}), 400

    # ç®€å•è‡ªåŠ¨ task_id
    if data.get("type") == "task" and not data.get("task_id"):
        data["task_id"] = f"t_{int(time.time()*1000)}"

    _append_log({"event":"send", **data})
    return jsonify({"status":"ok", "task_id": data.get("task_id")})

@bp.route("/api/relay/callback", methods=["POST"])
def relay_callback():
    """
    Child -> Master ä»»åŠ¡å›žè°ƒ
    body:
    {
      "task_id":"t_xxx",
      "child_id": "child_bazi",
      "status": "done" | "failed",
      "result": {...} | "æ–‡æœ¬"
    }
    """
    data = request.get_json(force=True)
    if not data or not data.get("task_id"):
        return jsonify({"status":"error","msg":"missing task_id"}), 400
    _append_log({"event":"callback", **data})
    return jsonify({"status":"ok"})

@bp.route("/api/relay/logs", methods=["GET"])
def relay_logs():
    limit = int(request.args.get("limit", 100))
    return jsonify({"status":"ok","logs":_read_logs(limit)})

@bp.route("/api/relay/ack", methods=["POST"])
def relay_ack():
    """
    ï¼ˆå¯é€‰ï¼‰å¯¹æ¶ˆæ¯ç¡®è®¤
    body: { "task_id":"t_xxx", "ack_by":"master|child" }
    """
    data = request.get_json(force=True)
    if not data or not data.get("task_id"):
        return jsonify({"status":"error","msg":"missing task_id"}), 400
    _append_log({"event":"ack", **data})
    return jsonify({"status":"ok"})
PY

# 2) ç®€æ˜“ child ai æ‰§è¡Œå™¨ï¼šchild_worker_mock.py
cat > child_worker_mock.py <<'PY'
"""
Child AI ä¼ªæ‰§è¡Œå™¨ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰ï¼š
- æ‹‰å– conversation_log.jsonl é‡Œçš„ task äº‹ä»¶ï¼ˆto=childï¼‰
- æ ¹æ® cmd ç®€å•å¤„ç†åŽï¼Œå‘ /api/relay/callback å›žä¼ ç»“æžœ
å®žé™…éƒ¨ç½²æ—¶ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶ç‹¬ç«‹è¿è¡Œåœ¨å­ AI çš„å®¹å™¨/å‡½æ•°é‡Œã€‚
"""
import json, time, os, requests

API_BASE = os.getenv("LYNKER_API_BASE", "http://127.0.0.1:8008")  # ä½ çš„ Flask æœåŠ¡åœ°å€
LOG_FILE = "conversation_log.jsonl"
SEEN = set()

def iter_tasks():
    if not os.path.exists(LOG_FILE): return []
    with open(LOG_FILE, "r", encoding="utf-8") as f:
        for line in f:
            try:
                r = json.loads(line)
                if r.get("event")=="send" and r.get("to")=="child" and r.get("type")=="task":
                    yield r
            except: 
                continue

def handle_task(task):
    cmd = task.get("cmd")
    payload = task.get("payload", {})
    # è¿™é‡Œå†™ä½ çš„å­ AI å…·ä½“é€»è¾‘ï¼ˆå‘½ç†åˆ†æž/æŠ¥å‘Š/éªŒè¯ç­‰ï¼‰
    if cmd == "verify_chart":
        result = {"summary":"å·²æ ¹æ® Vault è§„åˆ™åˆæ£€å‘½ç›˜è½¨è¿¹ä¸€è‡´æ€§","score":0.72}
    elif cmd == "generate_brief":
        result = {"brief": f"æ ¹æ®èµ„æ–™ï¼Œ{payload.get('topic','ä¸»é¢˜')} åˆæ­¥è¦ç‚¹å·²ç”Ÿæˆã€‚"}
    else:
        result = {"echo": payload}
    return result

def main():
    print("ðŸ§’ Child Worker mock running...")
    while True:
        for t in iter_tasks():
            tid = t.get("task_id")
            if tid in SEEN: 
                continue
            SEEN.add(tid)
            res = handle_task(t)
            # å›žè°ƒ
            requests.post(f"{API_BASE}/api/relay/callback", json={
                "task_id": tid,
                "child_id": "child_bazi",
                "status": "done",
                "result": res
            })
        time.sleep(2)

if __name__ == "__main__":
    main()
PY

# 3) å°† bus è“å›¾æŽ¥å…¥åˆ°ä¸» APIï¼šmaster_ai_uploader_api.py
python - <<'PY'
import re, io, sys

p = "master_ai_uploader_api.py"
src = open(p, "r", encoding="utf-8").read()

if "from conversation_bus import bp as relay_bp" in src:
    print("âœ… relay bus å·²æŒ‚è½½è¿‡ï¼Œè·³è¿‡ã€‚")
    sys.exit(0)

# åœ¨æ–‡ä»¶é¡¶éƒ¨ imports åŽæ³¨å…¥
src = src.replace("from flask import Flask, request, jsonify",
                  "from flask import Flask, request, jsonify\nfrom conversation_bus import bp as relay_bp")

# åœ¨ app åˆ›å»ºä½ç½®ä¹‹åŽæŒ‚è½½è“å›¾
src = src.replace("app = Flask(__name__)",
                  "app = Flask(__name__)\n# æŒ‚è½½ä¸‰æ–¹åä½œè“å›¾ï¼ˆMasterâ€“Childâ€“Userï¼‰\napp.register_blueprint(relay_bp)")

open(p, "w", encoding="utf-8").write(src)
print("âœ… å·²å°† relay bus è“å›¾æŒ‚è½½åˆ°ä¸» API")
PY

echo "ðŸŽ‰ Done. Endpoints added:"
echo "  â€¢ POST /api/relay/send        # å‘é€ä»»åŠ¡/æ¶ˆæ¯"
echo "  â€¢ POST /api/relay/callback    # å­AIå›žè°ƒ"
echo "  â€¢ GET  /api/relay/logs?limit=50"
echo "  â€¢ POST /api/relay/ack"
