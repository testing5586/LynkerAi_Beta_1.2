ğŸ’¡ ä»»åŠ¡ï¼šåœ¨å½“å‰é¡¹ç›®ä¸­æ–°å»ºæ–‡ä»¶ `soulmate_matcher.py`ï¼Œå®ç°åŒå‘½åŒ¹é…ç³»ç»Ÿï¼Œå¹¶åŠ å…¥è‡ªåŠ¨å»ºè¡¨é€»è¾‘ã€‚

---

ğŸ“ æ–‡ä»¶ï¼šsoulmate_matcher.py

å®ç°ä»¥ä¸‹åŠŸèƒ½ç»“æ„ï¼š

```python
from datetime import datetime
from sentence_transformers import SentenceTransformer, util
from supabase_init import init_supabase
import torch

# åˆå§‹åŒ–è¯­ä¹‰æ¨¡å‹ï¼ˆå¤ç”¨å…è´¹æ¨¡å‹ï¼‰
model = SentenceTransformer("shibing624/text2vec-base-chinese")

def init_match_table(supabase):
    """è‡ªåŠ¨æ£€æµ‹å¹¶åˆ›å»ºåŒ¹é…ç»“æœè¡¨"""
    if supabase is None:
        print("âš ï¸ Supabase æœªè¿æ¥ã€‚")
        return
    try:
        ddl = """
        create table if not exists public.soulmate_matches (
          id uuid primary key default gen_random_uuid(),
          user_id text not null,
          matched_user_id text not null,
          similarity numeric,
          shared_tags jsonb,
          verified_at timestamptz default now(),
          created_at timestamptz default now()
        );
        """
        try:
            supabase.postgrest.rpc('exec_sql', {'sql': ddl})
        except Exception:
            print("âš ï¸ exec_sql ä¸å¯ç”¨ï¼Œè·³è¿‡ RPC æ£€æŸ¥ã€‚")
        print("âœ… Table 'soulmate_matches' å·²å­˜åœ¨æˆ–å·²åˆ›å»ºã€‚")
    except Exception as e:
        print("âš ï¸ æ£€æŸ¥åŒ¹é…è¡¨å¤±è´¥ï¼š", e)

def compute_similarity(tags1, tags2):
    """è®¡ç®—ä¸¤ä½ç”¨æˆ·çš„ç›¸ä¼¼åº¦"""
    t1 = " ".join([str(v) for v in tags1.values() if v])
    t2 = " ".join([str(v) for v in tags2.values() if v])
    emb1 = model.encode(t1, convert_to_tensor=True)
    emb2 = model.encode(t2, convert_to_tensor=True)
    sim = util.cos_sim(emb1, emb2).item()
    return round(sim, 3)

def run_soulmate_matcher(user_id="u_demo", supabase=None, top_n=3):
    """æ‰§è¡ŒåŒå‘½åŒ¹é…"""
    print("\nğŸ’ æ­£åœ¨æ‰§è¡ŒåŒå‘½åŒ¹é… Soulmate Matcher ...")

    if supabase is None:
        supabase = init_supabase()
    init_match_table(supabase)

    # è¯»å–æ‰€æœ‰ç”¨æˆ·æ ‡ç­¾
    data = supabase.table("user_life_tags").select("*").execute().data
    if not data or len(data) < 2:
        print("âš ï¸ æ•°æ®ä¸è¶³ï¼Œæ— æ³•åŒ¹é…ã€‚")
        return None

    # æ‰¾å‡ºç›®æ ‡ç”¨æˆ·ä¸ä»–äººå¯¹æ¯”
    current = next((u for u in data if u["user_id"] == user_id), None)
    if not current:
        print(f"âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ· {user_id} çš„ life_tagsã€‚")
        return None

    results = []
    for other in data:
        if other["user_id"] == user_id:
            continue
        sim = compute_similarity(current, other)
        shared = {k: v for k, v in current.items() if k in other and current[k] == other[k] and v}
        results.append({
            "matched_user_id": other["user_id"],
            "similarity": sim,
            "shared_tags": shared
        })

    results = sorted(results, key=lambda x: x["similarity"], reverse=True)[:top_n]

    # ä¿å­˜ç»“æœ
    for r in results:
        supabase.table("soulmate_matches").upsert({
            "user_id": user_id,
            "matched_user_id": r["matched_user_id"],
            "similarity": r["similarity"],
            "shared_tags": r["shared_tags"],
            "verified_at": datetime.now().isoformat()
        }).execute()
        print(f"ğŸ’— åŒ¹é…ä¿å­˜ï¼š{user_id} â†” {r['matched_user_id']} ({r['similarity']})")

    print("âœ… Soulmate åŒ¹é…å®Œæˆã€‚")
    return results
