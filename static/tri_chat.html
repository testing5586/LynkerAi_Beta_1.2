<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰æ–¹åä½œèŠå¤© - Lynker Master AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter {
            animation: fadeInUp 0.3s ease-out;
        }
        .message-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .message-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .bg-gradient-dark {
            background: linear-gradient(to bottom, #0f172a, #1e293b, #0f172a);
        }
        pre {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .new-message-badge {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden">
    <div class="w-full h-full flex flex-col bg-gradient-dark text-white">
        <!-- Header -->
        <div class="bg-slate-900/80 backdrop-blur-md border-b border-white/10 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        ğŸ§  ä¸‰æ–¹åä½œèŠå¤©
                    </h1>
                    <p class="text-sm text-slate-400 mt-1">Master AI â†” Child AI â†” User å®æ—¶å¯¹è¯</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="newMessageBadge" class="hidden items-center gap-2 px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-xs cursor-pointer new-message-badge" onclick="scrollToBottom()">
                        <span>ğŸ“¨ æœ‰æ–°æ¶ˆæ¯</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-slate-400">å®æ—¶åŒæ­¥</span>
                    </div>
                    <button onclick="clearLogs()" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition">
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="text-center text-slate-500 py-20">
                <div class="animate-pulse">åŠ è½½å¯¹è¯è®°å½•...</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-white/10 bg-slate-900/80 backdrop-blur-md">
            <div class="max-w-4xl mx-auto flex items-center gap-3">
                <input
                    id="messageInput"
                    type="text"
                    placeholder="è¾“å…¥æ¶ˆæ¯ç»™ Master AI..."
                    class="flex-1 bg-slate-800 text-white rounded-xl px-4 py-3 outline-none border border-white/10 focus:border-purple-400 transition"
                    onkeypress="handleKeyPress(event)"
                />
                <button
                    id="sendButton"
                    onclick="sendMessage()"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                >
                    å‘é€
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'lynker_relay_secret_2025';
        let logs = [];
        let isSending = false;
        let lastLogCount = 0;

        const roleConfig = {
            master: { label: 'Master AI', icon: 'ğŸ§ ', color: 'bg-purple-500' },
            child: { label: 'Child AI', icon: 'ğŸ¤–', color: 'bg-emerald-500' },
            user: { label: 'You', icon: 'ğŸ‘¤', color: 'bg-blue-500' },
            system: { label: 'System', icon: 'âš™ï¸', color: 'bg-gray-500' }
        };

        function getRole(log) {
            if (log.from === 'master') return roleConfig.master;
            if (log.from === 'child' || log.child_id) return roleConfig.child;
            if (log.from === 'user') return roleConfig.user;
            return roleConfig.system;
        }

        function formatTime(ts) {
            return ts ? ts.split(' ')[1] : '';
        }

        function formatContent(log) {
            if (log.text) return log.text;
            if (log.result) return JSON.stringify(log.result, null, 2);
            if (log.event === 'callback') {
                return `âœ… ä»»åŠ¡å®Œæˆ\nTask ID: ${log.task_id}\nçŠ¶æ€: ${log.status}\nç»“æœ: ${JSON.stringify(log.result, null, 2)}`;
            }
            if (log.event === 'ack') {
                return `ğŸ‘Œ æ¶ˆæ¯ç¡®è®¤\nTask ID: ${log.task_id}\nç¡®è®¤æ–¹: ${log.ack_by}`;
            }
            return JSON.stringify(log, null, 2);
        }

        function isAtBottom() {
            const container = document.getElementById('messagesContainer');
            const threshold = 100;
            return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
        }

        function scrollToBottom(smooth = true) {
            const container = document.getElementById('messagesContainer');
            container.scrollTo({
                top: container.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
            document.getElementById('newMessageBadge').classList.add('hidden');
        }

        function createMessageElement(log, index) {
            const role = getRole(log);
            const align = log.from === 'user' ? 'items-end text-right' : 'items-start';
            const content = formatContent(log);
            const time = formatTime(log.ts);

            const div = document.createElement('div');
            div.className = `flex flex-col ${align} group message-enter`;
            div.setAttribute('data-index', index);
            div.innerHTML = `
                <div class="flex items-center gap-2 opacity-80 text-xs mb-1">
                    <div class="rounded-full px-3 py-1 ${role.color} text-white text-xs flex items-center gap-1.5">
                        <span>${role.icon}</span>
                        <span>${role.label}</span>
                    </div>
                    <span class="text-slate-400">${time}</span>
                </div>
                <div class="message-card max-w-[80%] rounded-2xl px-4 py-3 text-sm leading-relaxed backdrop-blur-md bg-white/10 border border-white/10">
                    <pre class="text-white/90">${content}</pre>
                </div>
            `;
            return div;
        }

        function updateMessages(newLogs) {
            const container = document.getElementById('messagesContainer');
            const wasAtBottom = isAtBottom();
            
            if (newLogs.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-20">æš‚æ— å¯¹è¯è®°å½•</div>';
                lastLogCount = 0;
                return;
            }

            if (newLogs.length > lastLogCount) {
                const startIndex = lastLogCount;
                const fragment = document.createDocumentFragment();
                
                for (let i = startIndex; i < newLogs.length; i++) {
                    fragment.appendChild(createMessageElement(newLogs[i], i));
                }
                
                if (lastLogCount === 0) {
                    container.innerHTML = '';
                }
                
                container.appendChild(fragment);
                lastLogCount = newLogs.length;

                if (wasAtBottom) {
                    scrollToBottom(true);
                } else {
                    const badge = document.getElementById('newMessageBadge');
                    badge.classList.remove('hidden');
                    badge.classList.add('flex');
                }
            }
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/api/relay/logs?limit=100');
                const data = await res.json();
                const newLogs = data.logs || [];
                
                if (JSON.stringify(newLogs) !== JSON.stringify(logs)) {
                    logs = newLogs;
                    updateMessages(logs);
                }
            } catch (error) {
                console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            const text = input.value.trim();

            if (!text || isSending) return;

            isSending = true;
            button.disabled = true;
            button.textContent = 'å‘é€ä¸­...';

            try {
                const res = await fetch('/api/relay/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Relay-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        from: 'user',
                        to: 'master',
                        type: 'message',
                        text: text
                    })
                });

                if (res.ok) {
                    input.value = '';
                    setTimeout(fetchLogs, 300);
                } else {
                    alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } finally {
                isSending = false;
                button.disabled = false;
                button.textContent = 'å‘é€';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                fetch('/api/relay/clear', {
                    method: 'POST',
                    headers: { 'X-Relay-API-Key': API_KEY }
                }).then(() => {
                    logs = [];
                    lastLogCount = 0;
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = '<div class="text-center text-slate-500 py-20">æš‚æ— å¯¹è¯è®°å½•</div>';
                }).catch(err => {
                    console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', err);
                    alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        }

        fetchLogs();
        setInterval(fetchLogs, 2500);
    </script>
</body>
</html>
