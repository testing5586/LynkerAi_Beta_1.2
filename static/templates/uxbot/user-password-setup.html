<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>设置密码 - 灵客AI</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --border: rgba(139,92,246,0.28);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --danger: #ef4444;
      --ok: #22c55e;
      --accent: #8b5cf6;
      --accent2: #d946ef;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(circle at 20% 10%, rgba(139,92,246,0.18), transparent 40%),
                  radial-gradient(circle at 80% 80%, rgba(234,179,8,0.10), transparent 45%),
                  var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 24px;
      box-sizing: border-box;
    }
    .wrap { width: 100%; max-width: 520px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 50px rgba(0,0,0,0.35);
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p { margin: 0 0 16px; color: var(--muted); line-height: 1.6; }
    .row { display: grid; gap: 10px; margin: 14px 0; }
    label { font-size: 13px; color: var(--muted); }
    input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      box-sizing: border-box;
      outline: none;
    }
    input:focus { border-color: rgba(139,92,246,0.65); box-shadow: 0 0 0 3px rgba(139,92,246,0.14); }
    .btn {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      font-weight: 650;
      color: white;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }
    .btn:disabled { opacity: 0.65; cursor: not-allowed; }
    .btn2 {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      font-weight: 650;
      background: #fff;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .msg { display:none; margin: 12px 0 0; padding: 12px; border-radius: 10px; font-size: 14px; }
    .msg.ok { display:block; background: rgba(34,197,94,0.14); color: var(--ok); border: 1px solid rgba(34,197,94,0.3); }
    .msg.bad { display:block; background: rgba(239,68,68,0.14); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
    .msg.warn { display:block; background: rgba(234,179,8,0.12); color: #eab308; border: 1px solid rgba(234,179,8,0.28); }
    .small { margin-top: 10px; font-size: 12px; color: var(--muted); }
    .link { color: rgba(139,92,246,0.95); text-decoration: none; }
    .topbar { display:flex; align-items:center; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
    .topbar a { color: var(--muted); text-decoration:none; font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a href="/uxbot/index.html">← 返回首页</a>
      <a href="/uxbot/user-registration-form.html">没有账号？去注册</a>
    </div>

    <div class="card">
      <h1>设置登录密码</h1>
      <p>
        为了安全起见：需要先用 <b>Google 登录</b> 验证该邮箱，才能设置密码。
      </p>

      <div class="row">
        <label>邮箱（将用于登录）</label>
        <input id="email" type="email" placeholder="someone@example.com" autocomplete="email" />
      </div>

      <button id="googleBtn" class="btn2" type="button">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        使用 Google 登录验证邮箱
      </button>

      <div style="height: 12px;"></div>

      <div class="row">
        <label>新密码（至少 8 位）</label>
        <input id="pw1" type="password" placeholder="输入新密码" autocomplete="new-password" />
      </div>
      <div class="row">
        <label>确认新密码</label>
        <input id="pw2" type="password" placeholder="再次输入" autocomplete="new-password" />
      </div>

      <button id="saveBtn" class="btn" type="button">保存密码</button>

      <div id="msg" class="msg"></div>
      <div class="small">
        设置成功后，你就可以在首页用 <b>邮箱 + 密码</b> 登录。若你之前是旧注册（user_registrations），系统会自动把旧资料绑定到新账号。
      </div>
    </div>
  </div>

<script>
(function(){
  function qs(k){ try { return new URLSearchParams(location.search).get(k); } catch(e){ return null; } }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  const emailInput = document.getElementById('email');
  const msg = document.getElementById('msg');
  const btnGoogle = document.getElementById('googleBtn');
  const btnSave = document.getElementById('saveBtn');

  function setMsg(type, text){
    msg.className = 'msg ' + type;
    msg.textContent = text;
  }

  // Prefill from query/localStorage
  try {
    const qEmail = (qs('email') || '').trim();
    const lsEmail = (localStorage.getItem('user_email') || '').trim();
    const initial = qEmail || lsEmail;
    if (initial) emailInput.value = initial;
  } catch(e) {}

  // Handle google callback params on this page too
  try {
    const params = new URLSearchParams(location.search);
    const googleAuth = params.get('google_auth');
    const userId = params.get('user_id');
    const userName = params.get('name');
    const email = params.get('email');
    const role = params.get('role');
    const avatar = params.get('avatar') || params.get('avatar_url') || params.get('picture');

    if (googleAuth === 'success' && role !== 'guru' && userId) {
      try {
        localStorage.setItem('uxbot_logged_in','1');
        localStorage.setItem('user_role','user');
        localStorage.setItem('user_id', String(userId));
        if (userName) localStorage.setItem('user_name', String(userName));
        if (email) localStorage.setItem('user_email', String(email));
        if (avatar) localStorage.setItem('user_avatar_url', String(avatar));
      } catch(e) {}

      // Clean oauth params but keep email param if present
      ['google_auth','user_id','name','avatar','avatar_url','picture','role','error'].forEach(k => { try { params.delete(k); } catch(e) {} });
      const newQs = params.toString();
      history.replaceState({}, document.title, location.pathname + (newQs ? '?' + newQs : ''));

      setMsg('ok', 'Google 验证成功，可以设置密码了。');
    }

    const err = params.get('error');
    if (err) {
      setMsg('bad', 'Google 登录失败：' + decodeURIComponent(err));
    }
  } catch(e) {}

  btnGoogle.addEventListener('click', function(){
    const email = (emailInput.value || '').trim().toLowerCase();
    if (!email) {
      setMsg('bad','请先输入邮箱');
      return;
    }

    // Redirect back to this page after Google OAuth
    const next = '/uxbot/user-password-setup.html?email=' + encodeURIComponent(email);
    location.href = '/api/auth/google/login?role=user&next=' + encodeURIComponent(next);
  });

  btnSave.addEventListener('click', async function(){
    const email = (emailInput.value || '').trim().toLowerCase();
    const pw1 = (document.getElementById('pw1').value || '').trim();
    const pw2 = (document.getElementById('pw2').value || '').trim();

    if (!email) { setMsg('bad','请输入邮箱'); return; }
    if (pw1.length < 8) { setMsg('bad','密码至少 8 位'); return; }
    if (pw1 !== pw2) { setMsg('bad','两次输入的密码不一致'); return; }

    btnSave.disabled = true;
    btnSave.textContent = '保存中...';

    try {
      const resp = await fetch('/api/user/password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, new_password: pw1 })
      });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data.success) {
        const msgText = (data && data.error) ? String(data.error) : '设置失败';
        // Most common: missing server session for this email
        if (resp.status === 401) {
          setMsg('warn', '请先使用 Google 登录验证该邮箱，然后再设置密码。');
        } else {
          setMsg('bad', msgText);
        }
        return;
      }

      // Persist identity locally so landing page shows correct state
      try {
        localStorage.setItem('uxbot_logged_in','1');
        localStorage.setItem('user_role','user');
        if (data.user_id) localStorage.setItem('user_id', String(data.user_id));
        localStorage.setItem('user_email', email);
      } catch(e) {}

      // Fetch user profile to get name and avatar for localStorage
      if (data.user_id) {
        try {
          const profileResp = await fetch('/api/user/profile/' + encodeURIComponent(data.user_id));
          const profileData = await profileResp.json().catch(() => ({}));
          if (profileData && profileData.success && profileData.data) {
            const pData = profileData.data;
            if (pData.name) localStorage.setItem('user_name', pData.name);
            if (pData.avatar_url) localStorage.setItem('user_avatar_url', pData.avatar_url);
          }
        } catch(profileErr) {
          console.warn('[password-setup] Failed to fetch profile:', profileErr);
        }
      }

      setMsg('ok', '密码设置成功！正在跳转...');
      // Redirect to user-profile-setup.html instead of index.html
      setTimeout(() => {
        location.href = '/uxbot/user-profile-setup.html';
      }, 900);

    } catch (e) {
      setMsg('bad', '网络错误，请重试');
    } finally {
      btnSave.disabled = false;
      btnSave.textContent = '保存密码';
    }
  });
})();
</script>
</body>
</html>
