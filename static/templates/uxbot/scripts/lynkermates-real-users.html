<!-- 
  ===================================================
  çµå‹åœˆé¡µé¢ - çœŸå®ç”¨æˆ·é›†æˆè„šæœ¬
  ===================================================
  ç”¨é€”: ä» Supabase è·å–çœŸå®ç”¨æˆ·æ¡£æ¡ˆå¹¶æ›¿æ¢ç¡¬ç¼–ç æ•°æ®
  ä½¿ç”¨æ–¹æ³•: åœ¨ lynkermates.html åº•éƒ¨å¼•å…¥æ­¤æ–‡ä»¶
  ä¾èµ–: /api/users/profiles åç«¯API
  ===================================================
-->

<script>
(function() {
  'use strict';
  
  console.log('[LynkermatesIntegration] åˆå§‹åŒ–çœŸå®ç”¨æˆ·æ•°æ®åŠ è½½...');
  
  /**
   * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
   */
  function formatTimeAgo(isoDateString) {
    if (!isoDateString) return 'åˆšåˆš';
    
    try {
      var date = new Date(isoDateString);
      var now = new Date();
      var diff = now - date;
      
      var minutes = Math.floor(diff / 60000);
      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return minutes + 'åˆ†é’Ÿå‰';
      
      var hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'å°æ—¶å‰';
      
      var days = Math.floor(hours / 24);
      if (days < 7) return days + 'å¤©å‰';
      
      var weeks = Math.floor(days / 7);
      if (weeks < 4) return weeks + 'å‘¨å‰';
      
      var months = Math.floor(days / 30);
      return months + 'ä¸ªæœˆå‰';
    } catch (e) {
      return 'æœ€è¿‘';
    }
  }
  
  /**
   * è·å–å›½æ—— emoji
   */
  function getNationalityFlag(nationality) {
    var flagMap = {
      'ä¸­å›½': 'ğŸ‡¨ğŸ‡³',
      'China': 'ğŸ‡¨ğŸ‡³',
      'ç¾å›½': 'ğŸ‡ºğŸ‡¸',
      'USA': 'ğŸ‡ºğŸ‡¸',
      'United States': 'ğŸ‡ºğŸ‡¸',
      'æ—¥æœ¬': 'ğŸ‡¯ğŸ‡µ',
      'Japan': 'ğŸ‡¯ğŸ‡µ',
      'éŸ©å›½': 'ğŸ‡°ğŸ‡·',
      'Korea': 'ğŸ‡°ğŸ‡·',
      'è‹±å›½': 'ğŸ‡¬ğŸ‡§',
      'UK': 'ğŸ‡¬ğŸ‡§',
      'æ³•å›½': 'ğŸ‡«ğŸ‡·',
      'France': 'ğŸ‡«ğŸ‡·',
      'å¾·å›½': 'ğŸ‡©ğŸ‡ª',
      'Germany': 'ğŸ‡©ğŸ‡ª',
      'åŠ æ‹¿å¤§': 'ğŸ‡¨ğŸ‡¦',
      'Canada': 'ğŸ‡¨ğŸ‡¦',
      'æ¾³å¤§åˆ©äºš': 'ğŸ‡¦ğŸ‡º',
      'Australia': 'ğŸ‡¦ğŸ‡º'
    };
    
    return flagMap[nationality] || 'ğŸŒ';
  }
  
  /**
   * åˆ›å»ºç”¨æˆ·å¡ç‰‡ HTML
   */
  function createUserCardHTML(profile, index) {
    var pseudonym = profile.pseudonym || 'çµå®¢ç”¨æˆ·';
    var bio = profile.bio || 'è¿™ä¸ªäººå¾ˆç¥ç§˜ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹';
    var avatarUrl = profile.avatar_url || '/static/uxbot/assets/optimized_images/default-avatar.png';
    var flag = getNationalityFlag(profile.nationality);
    var timeAgo = formatTimeAgo(profile.created_at);
    
    // ç”Ÿæˆéšæœºäº’åŠ¨æ•°æ® (å®é™…åº”è¯¥ä» posts è¡¨è·å–)
    var likes = Math.floor(Math.random() * 200) + 20;
    var comments = Math.floor(Math.random() * 50) + 5;
    var shares = Math.floor(Math.random() * 30) + 1;
    
    // éšæœºæ ‡ç­¾ (å®é™…åº”è¯¥ä»ç”¨æˆ·çš„ posts è·å–)
    var tags = ['#å…«å­—', '#å‘½ç†', '#äººç”Ÿè§„åˆ’', '#ç´«è–‡', '#è½¬è¿', '#åŒå‘½', '#è®ºå›', '#çŸ¥è¯†åˆ†äº«'];
    var selectedTags = tags.sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * 3) + 1);
    
    var tagsHTML = selectedTags.map(function(tag) {
      return '<div class="inline-flex items-center rounded-md border px-2.5 py-0.5 font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 text-foreground text-xs cursor-pointer hover:bg-primary/10">' + tag + '</div>';
    }).join('');
    
    // æ„å»ºå¡ç‰‡ HTML
    var html = '<div class="rounded-xl border bg-card text-card-foreground shadow glass-card border-border/50 overflow-hidden hover:border-primary/30 transition-colors">';
    
    // ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨
    html += '<div class="p-4 border-b border-border/30">';
    html += '<div class="flex items-start justify-between">';
    html += '<div class="flex items-center gap-3">';
    html += '<button class="cursor-pointer">';
    html += '<div class="relative inline-block">';
    html += '<span class="relative flex shrink-0 overflow-hidden rounded-full h-10 w-10">';
    
    // å¦‚æœæœ‰å¤´åƒï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å¦åˆ™æ˜¾ç¤ºé¦–å­—æ¯
    if (avatarUrl && avatarUrl.indexOf('default') === -1) {
      html += '<img src="' + avatarUrl + '" alt="' + pseudonym + '" class="h-full w-full object-cover" />';
    } else {
      html += '<span class="flex h-full w-full items-center justify-center rounded-full bg-primary text-primary-foreground">';
      html += pseudonym.substring(0, 2);
      html += '</span>';
    }
    
    html += '</span>';
    
    // å›½æ——æ ‡è¯†
    if (flag) {
      html += '<div class="absolute -bottom-1 -right-1 text-lg">' + flag + '</div>';
    }
    
    html += '</div></button>';
    
    // æ˜µç§°å’Œæ—¶é—´
    html += '<div class="flex-1"><div class="flex items-center gap-2">';
    html += '<h4 class="font-semibold text-foreground">' + pseudonym + '</h4>';
    html += '</div>';
    html += '<p class="text-xs text-muted-foreground">' + timeAgo + '</p>';
    html += '</div></div>';
    
    // æ›´å¤šæŒ‰é’®
    html += '<button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground h-8 w-8">';
    html += '<svg class="lucide lucide-ellipsis w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>';
    html += '</button>';
    
    html += '</div></div>';
    
    // å†…å®¹åŒºåŸŸ
    html += '<div class="p-4 space-y-3">';
    html += '<p class="text-foreground leading-relaxed">' + bio + '</p>';
    
    // æ ‡ç­¾
    if (tagsHTML) {
      html += '<div class="flex flex-wrap gap-2">' + tagsHTML + '</div>';
    }
    
    html += '</div>';
    
    // ç»Ÿè®¡ä¿¡æ¯
    html += '<div class="px-4 py-2 border-t border-border/30 text-xs text-muted-foreground flex justify-between">';
    html += '<span>' + likes + ' äººèµ</span>';
    html += '<div class="space-x-3">';
    html += '<span>' + comments + ' æ¡è¯„è®º</span>';
    html += '<span>' + shares + ' æ¬¡åˆ†äº«</span>';
    html += '</div></div>';
    
    // æ“ä½œæŒ‰é’®
    html += '<div class="px-4 py-3 border-t border-border/30 flex items-center gap-2">';
    html += '<button class="inline-flex items-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 h-8 rounded-md px-3 text-xs flex-1 justify-center text-muted-foreground hover:text-primary hover:bg-primary/10">';
    html += '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/></svg>';
    html += '<span class="text-xs">èµ</span></button>';
    
    html += '<button class="inline-flex items-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 h-8 rounded-md px-3 text-xs flex-1 justify-center text-muted-foreground hover:text-primary hover:bg-primary/10">';
    html += '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719"/></svg>';
    html += '<span class="text-xs">è¯„è®º</span></button>';
    
    html += '<button class="inline-flex items-center gap-2 whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 h-8 rounded-md px-3 text-xs flex-1 justify-center text-muted-foreground hover:text-primary hover:bg-primary/10">';
    html += '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>';
    html += '<span class="text-xs">åˆ†äº«</span></button>';
    html += '</div>';
    
    html += '</div>';
    
    return html;
  }
  
  /**
   * ä» API è·å–ç”¨æˆ·æ¡£æ¡ˆå¹¶æ›´æ–°é¡µé¢
   */
  function loadRealUserProfiles() {
    console.log('[LynkermatesIntegration] å¼€å§‹è·å–ç”¨æˆ·æ¡£æ¡ˆ...');
    
    // æŸ¥æ‰¾åŠ¨æ€åˆ—è¡¨å®¹å™¨
    var feedContainer = document.querySelector('.space-y-4.px-4.pb-8');
    if (!feedContainer) {
      console.error('[LynkermatesIntegration] æœªæ‰¾åˆ°åŠ¨æ€åˆ—è¡¨å®¹å™¨');
      return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    var loadingHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div><p class="mt-2 text-sm text-muted-foreground">åŠ è½½çœŸå®ç”¨æˆ·æ¡£æ¡ˆ...</p></div>';
    feedContainer.innerHTML = loadingHTML;
    
    // è°ƒç”¨ API
    fetch('/api/users/profiles?limit=10')
      .then(function(response) {
        if (!response.ok) {
          throw new Error('API è¯·æ±‚å¤±è´¥: ' + response.status);
        }
        return response.json();
      })
      .then(function(data) {
        console.log('[LynkermatesIntegration] è·å–åˆ°ç”¨æˆ·æ¡£æ¡ˆ:', data);
        
        if (!data.success || !data.profiles || data.profiles.length == 0) {
          // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
          var emptyHTML = '<div class="text-center py-12">';
          emptyHTML += '<svg class="mx-auto h-16 w-16 text-muted-foreground opacity-50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
          emptyHTML += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>';
          emptyHTML += '<p class="text-lg font-medium mb-2">æš‚æ— ç”¨æˆ·åŠ¨æ€</p>';
          emptyHTML += '<p class="text-sm text-muted-foreground mb-4">æˆä¸ºç¬¬ä¸€ä¸ªå®Œå–„æ¡£æ¡ˆå¹¶åˆ†äº«åŠ¨æ€çš„çµå®¢å§ï¼</p>';
          emptyHTML += '<a href="/uxbot/user-profile-setup.html" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">';
          emptyHTML += 'ç«‹å³å®Œå–„æ¡£æ¡ˆ</a>';
          emptyHTML += '</div>';
          feedContainer.innerHTML = emptyHTML;
          return;
        }
        
        // ç”Ÿæˆç”¨æˆ·å¡ç‰‡
        var cardsHTML = '';
        data.profiles.forEach(function(profile, index) {
          cardsHTML += createUserCardHTML(profile, index);
        });
        
        feedContainer.innerHTML = cardsHTML;
        console.log('[LynkermatesIntegration] æˆåŠŸæ¸²æŸ“ ' + data.profiles.length + ' ä¸ªç”¨æˆ·æ¡£æ¡ˆ');
      })
      .catch(function(error) {
        console.error('[LynkermatesIntegration] åŠ è½½å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        var errorHTML = '<div class="text-center py-12">';
        errorHTML += '<svg class="mx-auto h-12 w-12 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
        errorHTML += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
        errorHTML += '<p class="text-lg font-medium mb-2">åŠ è½½å¤±è´¥</p>';
        errorHTML += '<p class="text-sm text-muted-foreground mb-4">æ— æ³•è·å–ç”¨æˆ·æ¡£æ¡ˆæ•°æ®: ' + error.message + '</p>';
        errorHTML += '<button onclick="location.reload()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">';
        errorHTML += 'é‡è¯•</button>';
        errorHTML += '</div>';
        feedContainer.innerHTML = errorHTML;
      });
  }
  
  // ç­‰å¾… DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadRealUserProfiles);
  } else {
    // DOM å·²åŠ è½½ï¼Œå»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿ React æ¸²æŸ“å®Œæˆ
    setTimeout(loadRealUserProfiles, 500);
  }
  
})();
</script>

<style>
/* åŠ è½½åŠ¨ç”» */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.animate-spin {
  animation: spin 1s linear infinite;
}
</style>
